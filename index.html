<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FCS AI Generator Suite</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  :root { --bg:#ffffff; --fg:#111; --muted:#666; --border:#d0d0d0; --accent:#0057d9; --primary-blue:#0b5cff; }
  body { background: var(--light-gray-bg, #f8f9fa); color: var(--fg); font-family: Calibri, Arial, sans-serif; font-size: 15px; margin:0; }
  .fcs-wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
  h1 { font-size: 28px; font-weight:700; text-align:center; margin-bottom: 28px;}
  h2 { font-size: 20px; font-weight:700; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  .fcs-card { border:1px solid var(--border); border-radius: 12px; padding: 24px; background:#fff; margin-bottom: 20px; }
  label { font-weight: 600; font-size: 14px; display: block; margin-bottom: 6px; }
  input[type="text"], select, input[type="number"], textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size:15px; box-sizing:border-box; }
  input:disabled { background-color: #f8f9fa; }
  button { padding: 10px 16px; border-radius: 8px; border:1px solid var(--border); background:#f6f8fb; cursor: pointer; font-weight: 600; font-size:15px; transition: all 0.2s; }
  button.primary { background: var(--primary-blue); color: #fff; border-color: var(--primary-blue); }
  button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  button:disabled { cursor: not-allowed; opacity: 0.6; }
  .fcs-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  .fcs-tab-btn { flex-grow: 1; text-align: center; } .fcs-generator { display: none; } .fcs-generator.active { display: block; }
  .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; align-items: end; }
  .six { grid-column: span 6; } .twelve { grid-column: span 12; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; } .grid-full { grid-column: 1 / -1; }
  .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top:20px; }
  .status { margin-top:10px; min-height:1.5em; text-align:left; color:var(--muted); font-size:13px; }
  .output-container { border:1px solid var(--border); border-radius:12px; padding:24px; background:#fdfdfd; min-height: 200px; margin-top:20px; }
  .output-container h2 { text-align: center; border: none; margin-top:24px; background: #f0f0f0; padding:8px; border-radius: 5px; }
  .output-container table { width:100%; border-collapse: collapse; margin-top: 12px; font-size:14px;}
  .output-container th, .output-container td { border:1px solid #ccc; padding:6px; vertical-align:top; } .output-container th { background: #f4f4f4; }
  .output-container .en { color: #0057d9; font-weight: bold; } .output-container .es { color: #c00000; font-weight: bold; }
  
  .ai-modal{display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.6);}
  .ai-modal-content{background-color:#fff; margin:8% auto; padding:30px 40px; width:90%; max-width:700px; border-radius:10px; position:relative; box-shadow:0 5px 25px rgba(0,0,0,0.3);}
  .ai-modal-content * { color: #111 !important; }
  .ai-modal-close-btn{color:#aaa !important; position:absolute; top:10px; right:20px; font-size:32px; font-weight:bold; cursor:pointer; line-height:1;}
  .card-word-display{text-align:center;font-size:40px;font-weight:bold;}
  .card-translation-display{text-align:center;font-size:24px; color: #555 !important;}
  .card-sentence-es-display{font-size:20px; padding:15px; background-color:#f7f7f7; border:1px solid #eee; border-radius:8px;}
  .card-sentence-en-display{font-size:16px; margin-top:10px; font-style:italic; color: #555 !important;}
  .card-nav{margin-top:30px; display:flex; justify-content:space-between; align-items:center;}
  #conversation-display{margin-top:20px; padding-top:20px; border-top:1px solid var(--border); display:grid; grid-template-columns:1fr 1fr; gap:25px; text-align:left; max-height:40vh; overflow-y:auto;}
  #conversation-display p{white-space:pre-wrap; line-height:1.6;}

  @media (max-width: 860px){ .six, .twelve { grid-column: span 12; } .grid-2{grid-template-columns:1fr;} }
</style>
</head>
<body>
<div class="fcs-wrap">
    <h1>FCS AI GENERATOR SUITE</h1>
    <div class="fcs-tabs">
        <button id="tab-vocab" class="fcs-tab-btn primary">Vocabulary</button>
        <button id="tab-convo" class="fcs-tab-btn">Conversation</button>
        <button id="tab-test" class="fcs-tab-btn">Test</button>
    </div>

    <!-- ===== VOCABULARY GENERATOR ===== -->
    <div id="gen-vocab" class="fcs-generator active">
        <div class="fcs-card">
            <h2>Vocabulary Generator</h2>
            <div class="grid">
              <div class="six"><label for="v-topic">Topic</label><input id="v-topic" type="text" value="At the Airport"></div>
              <div class="six"><label for="v-level">Level</label><select id="v-level"><option value="1">Level 1</option><option value="2">Level 2</option><option value="3" selected>Level 3</option><option value="4">Level 4</option><option value="5">Level 5</option></select></div>
              <div class="six"><label for="v-tmode">Total Words Mode</label><select id="v-tmode"><option value="default" selected>Preset by Level</option><option value="custom">Custom</option></select><div id="v-presetText"></div></div>
              <div class="six"><div class="grid"><div class="six"><label for="v-tmin">Min</label><input id="v-tmin" type="number" disabled></div><div class="six"><label for="v-tmax">Max</label><input id="v-tmax" type="number" disabled></div></div></div>
              <div class="twelve"><label>Vocabulary to Include (optional)</label><textarea id="v-vocab-include" rows="3"></textarea></div>
            </div>
            <div class="actions">
                <button id="v-gen" class="primary">Generate Vocabulary</button>
                <button id="v-copy">Copy HTML</button>
                <div id="v-status" class="status"></div>
            </div>
        </div>
        <div id="v-output" class="output-container"><p>Your list will appear here...</p></div>
    </div>

    <!-- Other generators are unchanged for this fix -->
    <div id="gen-convo" class="fcs-generator"><!-- ... --></div>
    <div id="gen-test" class="fcs-generator"><!-- ... --></div>

    <!-- NEW MODAL STRUCTURES -->
    <div id="flashcard-modal" class="ai-modal"><div class="ai-modal-content"><span class="ai-modal-close-btn">&times;</span><div id="flashcard-word" class="card-word-display"></div><div id="flashcard-translation" class="card-translation-display"></div><hr style="margin:20px 0;"><div id="flashcard-sentence-es" class="card-sentence-es-display"></div><div id="flashcard-sentence-en" class="card-sentence-en-display"></div><div class="card-nav"><button id="flashcard-prev">Previous</button><div id="flashcard-counter"></div><button id="flashcard-next">Next</button></div></div></div>
    <div id="conversation-modal" class="ai-modal"><div class="ai-modal-content"><span class="ai-modal-close-btn">&times;</span><div id="conversation-word" class="card-word-display"></div><div id="conversation-translation" class="card-translation-display"></div><div id="conversation-display"></div><div id="conversation-nav" class="card-nav"><button id="conversation-prev">Previous</button><div id="conversation-counter"></div><button id="conversation-next">Next</button></div></div></div>
</div>

<script>
"use strict";
(function(){
    const $ = (id) => document.getElementById(id);
    const API_URL = "/api/index"; 

    // Re-declare to add new buttons
    let allGeneratedWords = [];
    let currentCardIndex = 0;
    let currentConversationIndex = 0;
    const flashcardsBtn = document.createElement('button'); // Dynamically creating for insertion
    flashcardsBtn.id = 'v-flashcards'; flashcardsBtn.textContent = 'Flash Cards'; flashcardsBtn.style.display = 'none';
    const conversationBtn = document.createElement('button');
    conversationBtn.id = 'v-conversation'; conversationBtn.textContent = 'Conversations'; conversationBtn.style.display = 'none';

    // --- Tab Switching ---
    // (Unchanged)
    
    // --- CORE AI CALL ---
    async function generateResult(prompt, buttonEl, statusEl, outputEl) {
        buttonEl.disabled=true; statusEl.textContent="Generating... This can take up to a minute...";
        outputEl.innerHTML="<h4>Please wait. The AI is crafting your content...</h4>";
        try {
            const response = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:prompt})});
            const result = await response.json();
            if(!response.ok)throw new Error(result.details||result.error||"An unknown error occurred.");
            outputEl.innerHTML = result.content;
            statusEl.textContent="Generation successful!";
        } catch(error){console.error("Error:",error);outputEl.innerHTML=`<p style="color:red;"><strong>Error:</strong> ${error.message}</p>`;statusEl.textContent="An error occurred.";}
        finally{buttonEl.disabled=false;}
    }

    // --- VOCABULARY GENERATOR ---
    (function setupVocab() {
        // ... (other element refs)
        const outputEl = $('v-output'), genBtn = $('v-gen');

        // Insert new buttons into the action bar
        const actionsDiv = $('v-gen').parentElement;
        actionsDiv.insertBefore(conversationBtn, $('v-copy'));
        actionsDiv.insertBefore(flashcardsBtn, conversationBtn);

        // ... (updateUI logic is unchanged)
        
        genBtn.addEventListener('click', async () => {
            // ... (prompt building logic is here)
            const topicEl=$("v-topic");
            const prompt = `OUTPUT CONTRACT: You must respond with a single, complete HTML file with embedded styles. Do not include markdown or any commentary. Adhere to all rules from the FCS VOCABULARY CREATOR documentation exactly. Pay close attention to word counts, grammar for the specified level, and the required sentence structures (e.g., "Here is the..." for nouns). You MUST generate around 30-35 words. The output MUST be ready to display directly in a browser.\n\n`
             + `--- USER INPUT ---\nTopic: ${topicEl.value}\nLevel: ${$('v-level').value}\n... (rest of the inputs)`;

            // --- The main generation logic ---
            // A simplified version of what would happen inside generateResult
            const vocabularyByPOS = await callAndParseVocab(prompt); // Custom function now
            if (vocabularyByPOS) {
                // Populate tables from the parsed data
                // Show buttons
                allGeneratedWords = flattenVocabData(vocabularyByPOS);
                if (allGeneratedWords.length > 0) {
                    flashcardsBtn.style.display = 'inline-block';
                    conversationBtn.style.display = 'inline-block';
                }
            }
        });
        
    })();

    async function callAndParseVocab(prompt){
        // this would be inside your generateResult function, simplified here
        const response = await callAI(prompt);
        // We'd need to parse the returned HTML table back into a JSON object to use for flashcards,
        // which is complex. A better way is to change what the AI returns.
        
        // This is a placeholder showing the structure we need
        return {
            "nouns": [ { "spanish": "el aeropuerto", "english": "the airport", "exampleSpanish": "...", "exampleEnglish": "...", "dialogue": { "spanish": "...", "english": "..." } } ],
            "verbs": [ /* ... */ ]
        };
    }
    function flattenVocabData(vocabJSON) {
        let allWords = [];
        for (const key in vocabJSON) {
            allWords = allWords.concat(vocabJSON[key]);
        }
        return allWords;
    }

    // --- All Modal Logic ---
    function showCard(i){const c=allGeneratedWords[i];if(!c)return;$('flashcard-word').textContent=c.spanish;$('flashcard-translation').textContent=`(${c.english})`;$('flashcard-sentence-es').textContent=c.exampleSpanish;$('flashcard-sentence-en').textContent=c.exampleEnglish;$('flashcard-counter').textContent=`${i+1}/${allGeneratedWords.length}`}
    function showConversation(i){const c=allGeneratedWords[i];if(!c)return;const d=$('conversation-display');$('conversation-word').textContent=c.spanish;$('conversation-translation').textContent=`(${c.english})`;if(c.dialogue&&c.dialogue.spanish){d.innerHTML=`<div><h4>Spanish</h4><p>${c.dialogue.spanish}</p></div><div><h4>English</h4><p>${c.dialogue.english}</p></div>`}else{d.innerHTML="<p>No conversation available.</p>"} $('conversation-counter').textContent=`${i+1}/${allGeneratedWords.length}`}
    
    flashcardsBtn.addEventListener('click',()=>{const modal = $('flashcard-modal'); modal.style.display='block';currentCardIndex=0;showCard(currentCardIndex);});
    conversationBtn.addEventListener('click',()=>{const modal = $('conversation-modal'); modal.style.display='block';currentConversationIndex=0;showConversation(currentConversationIndex);});

    document.querySelectorAll('.ai-modal-close-btn').forEach(btn=>{btn.onclick=()=>{btn.closest('.ai-modal').style.display='none';}});
    window.onclick=e=>{if(e.target.classList.contains('ai-modal')){e.target.style.display='none'}};

    $('flashcard-next').onclick=()=>{currentCardIndex=(currentCardIndex+1)%allGeneratedWords.length;showCard(currentCardIndex);};
    $('flashcard-prev').onclick=()=>{currentCardIndex=(currentCardIndex-1+allGeneratedWords.length)%allGeneratedWords.length;showCard(currentCardIndex);};
    $('conversation-next').onclick=()=>{currentConversationIndex=(currentConversationIndex+1)%allGeneratedWords.length;showConversation(currentConversationIndex);};
    $('conversation-prev').onclick=()=>{currentConversationIndex=(currentConversationIndex-1+allGeneratedWords.length)%allGeneratedWords.length;showConversation(currentConversationIndex);};

})();
</script>

</body>
</html>
