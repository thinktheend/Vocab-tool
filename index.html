/* =========================
     Conversation
     ========================= */
  (function setupConvo(){
    const convoUI =
      `<div class="fcs-card"><h2>Conversation Creator</h2>
        <div class="grid-2">
          <div class="grid-full"><label for="c-topic">Topic</label><input id="c-topic" type="text" placeholder="e.g., A funny story about a vacation"/></div>

          <div><label>Level (Grammar)</label>
            <select id="c-level">
              <option value="1" selected>Level 1 — Survival</option>
              <option value="2">Level 2 — Beginner</option>
              <option value="3">Level 3 — Intermediate</option>
              <option value="4">Level 4 — Conversational</option>
              <option value="5">Level 5 — Fluent</option>
              <option value="6">Level 6 — Native</option>
            </select>
          </div>

          <div><label># of Conversations</label><input id="c-numConvos" type="number" value="2" min="1"/></div>
          <div><label># of Speakers</label><input id="c-numSpeakers" type="number" value="2" min="1"/></div>

          <div class="grid-full" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;">
            <div><label>Turns</label><input id="c-turns" type="number" value="10" min="1"/></div>
            <div><label>Sentences/Turn — Min</label><input id="c-sentMin" type="number" value="2" min="1"/></div>
            <div><label>Sentences/Turn — Max</label><input id="c-sentMax" type="number" value="4" min="1"/></div>
          </div>

          <div><label>Tone</label>
            <select id="c-tone"><option>Neutral, casual</option><option>Informal, friendly</option><option>Instructor, student</option><option>Customer, staff</option><option>Professional, formal</option><option>Street slang</option></select>
          </div>
          <div><label>Country / Region</label><select id="c-country"></select></div>

          <div class="grid-full"><label>Include English Translation</label><select id="c-includeEN"><option value="yes" selected>Yes</option><option value="no">No</option></select></div>
          <div><label>Add Fill-In-The-Blank</label><select id="c-addFib"><option value="no">No</option><option value="yes" selected>Yes</option></select></div>
          <div><label>Fill-In-The-Blank Focus</label><select id="c-fibFocus"><option>Mixed</option><option>Vocab only</option><option>Grammar only</option><option>Verbs only</option></select></div>
          <div><label>Show FIB Answer Key</label><select id="c-showFIBKey"><option value="yes">Yes</option><option value="no">No</option></select></div>
          <div><label>Show Vocabulary List</label><select id="c-showVocabList"><option value="yes">Yes</option><option value="no">No</option></select></div>

          <div class="grid-full"><label for="c-vocab">Vocabulary (optional)</label><textarea id="c-vocab" rows="6" placeholder="Put your own vocabulary here..."></textarea></div>
          <div class="grid-full"><label>Optional Teacher Notes</label><textarea id="c-notes" rows="4"></textarea></div>
        </div>

        <div class="actions"><button id="c-gen" class="primary">Generate</button><button id="c-excel">Excel</button><button id="c-copy">Copy</button><button id="c-prompt">Prompt</button><div id="c-status" class="status"></div></div>
      </div>
      <div id="c-output" class="output-container"><p>Your conversation appears here...</p></div>`;
    $('gen-convo').innerHTML=convoUI;

    const countrySelect=$('c-country');
    const countries=["-no specific-","Argentina","Bolivia","Chile","Colombia","Costa Rica","Cuba","Dominican Republic","Ecuador","El Salvador","Equatorial Guinea","Guatemala","Honduras","Mexico","Nicaragua","Panama","Paraguay","Peru","Puerto Rico","Spain","Uruguay","Venezuela"];
    countrySelect.innerHTML=countries.map(c=>`<option>${c}</option>`).join('');

    // Level 6 stays unlocked — no disabling of controls

    const genBtn=$('c-gen'),excelBtn=$('c-excel'),copyBtn=$('c-copy'),promptBtn=$('c-prompt'),statusEl=$('c-status'),outputEl=$('c-output');

    /* ---------- Instruction text (copy) ---------- */
    function buildConvoInstruction(){
      const topic=$('c-topic').value.trim();
      const sentMin = Math.max(1, Number($('c-sentMin').value)||2);
      const sentMax = Math.max(sentMin, Number($('c-sentMax').value)||4);
      const turns = Math.max(1, Number($('c-turns').value)||10);
      const fibCount = Math.max(8, Math.min(40, Math.round(turns * 0.9))); // big exercises if requested

      const ui = {
        topic,
        level: $('c-level').value,
        sentences_per_turn: { min: sentMin, max: sentMax },
        vocab: $('c-vocab').value || "(auto-generate level-appropriate list if empty)",
        numConvos: Math.max(1, Number($('c-numConvos').value)||1),
        numSpeakers: Math.max(1, Number($('c-numSpeakers').value)||1),
        turns,
        tone: $('c-tone').value,
        region: $('c-country').value,
        includeEN: $('c-includeEN').value,
        addFIB: $('c-addFib').value,
        fibFocus: $('c-fibFocus').value,
        showFIBKey: $('c-showFIBKey').value,
        showVocabList: $('c-showVocabList').value,
        teacherNotes: $('c-notes').value||""
      };

      const levelLines = getLevelRulesLines(ui.level);
      const header = [
        `You are an expert assistant for FCS.`,
        `IMPORTANT: Do NOT return HTML. Produce TWO PARTS (Word + CSV).`,
        `Topic: "${ui.topic}". Level: ${ui.level}. Tone: "${ui.tone}". Region: "${ui.region}".`,
        ui.vocab && ui.vocab !== "(auto-generate level-appropriate list if empty)"
          ? `Teacher vocabulary: ${ui.vocab.replace(/[\r\n]+/g,'; ')}`
          : `Vocabulary: auto-generate.`,
        `LEVEL RULES:\n- ${levelLines.join('\n- ')}`
      ];

      const baseRules = [
        `Create EXACTLY ${ui.numConvos} conversation section(s) titled "Conversation 1", "Conversation 2", ...`,
        `Use exactly ${ui.numSpeakers} distinct speaker name(s) appropriate to the region.`,
        `Each conversation has EXACTLY ${ui.turns} turns (rows).`,
        (ui.includeEN==='yes'
          ? `Tables have two columns: "English" | "Español".`
          : `Tables have one column: "Español" only.`),
        `Each turn contains between ${ui.sentences_per_turn.min} and ${ui.sentences_per_turn.max} Spanish sentences (and English sentences if included).`,
        (ui.numConvos===1 && ui.numSpeakers===1
          ? `Because #Conversations=1 and #Speakers=1, produce a MONOLOGUE: one recurring speaker across all ${ui.turns} turns. Prefer the UPPER bound of sentences/turn and write longer, multi-clause sentences for a very long output (while staying within bounds).`
          : `Keep flow natural; mix short replies with longer turns; avoid robotic symmetry.`)
      ];

      const fibRules = (ui.addFIB!=='yes') ? [] : [
        `Include a Fill-in-the-Blank section with exactly ${fibCount} items.`,
        `Readable View rule:`,
        `• English cell = full, natural English sentence; NO blanks; the translated target word is wrapped in [EN]...[/EN].`,
        `• Español cell = full Spanish sentence with the target replaced by "________"; immediately BEFORE the blank include the English word in parentheses.`,
        ui.showFIBKey==='yes'
          ? `Provide a numbered Answer Key (answers only) after FIB.`
          : `Do NOT include an Answer Key.`
      ];

      const vocabListRule = (ui.showVocabList!=='yes') ? [] : [
        `After conversations (and FIB if present), include a "Vocabulary Used" list.`
      ];

      const partA = [
        `PART A — READABLE VIEW (Word):`,
        (ui.includeEN==='yes'
          ? `- Under each "Conversation X", provide a Markdown table: "English" | "Español".`
          : `- Under each "Conversation X", provide a single-column Markdown table: "Español".`),
        `- Keep names and punctuation natural.`
      ];

      const partB = [
        `PART B — CSV:`,
        `1) CSV_CONVERSATIONS — header: "Conversation","Turn","Speaker","English","Español". Include every turn.`,
        (ui.addFIB==='yes') ? `2) CSV_FIB — header: "English","Español".` : null,
        (ui.showVocabList==='yes') ? `3) CSV_VOCAB_USED — header: "English","Español".` : null,
        (ui.showFIBKey==='yes') ? `4) CSV_ANSWER_KEY — header: "#","Answer".` : null
      ].filter(Boolean);

      const footer = [
        `GLOBAL: No HTML. Stay on topic "${ui.topic}". Obey level & UI exactly.`
      ];

      return [...header, '', 'Rules (strict):', ...baseRules, ...fibRules, ...vocabListRule, '', ...partA, '', ...partB, '', ...footer].join('\n');
    }

    /* ---- HTML prompt (generation) ---- */
    function buildConvoPrompt(){
      const topic=$('c-topic').value.trim();
      const sentMin = Math.max(1, Number($('c-sentMin').value)||2);
      const sentMax = Math.max(sentMin, Number($('c-sentMax').value)||4);
      const turns = Math.max(1, Number($('c-turns').value)||10);

      const ui = {
        topic,
        level: $('c-level').value,
        sentences_per_turn: { min: sentMin, max: sentMax },
        vocab: $('c-vocab').value || "(auto-generate level-appropriate list if empty)",
        numConvos: Math.max(1, Number($('c-numConvos').value)||1),
        numSpeakers: Math.max(1, Number($('c-numSpeakers').value)||1),
        turns,
        tone: $('c-tone').value,
        region: $('c-country').value,
        includeEN: $('c-includeEN').value,
        addFIB: $('c-addFib').value,
        fibFocus: $('c-fibFocus').value,
        showFIBKey: $('c-showFIBKey').value,
        showVocabList: $('c-showVocabList').value,
        teacherNotes: $('c-notes').value||""
      };

      const levelLines = getLevelRulesLines(ui.level);
      const isMono = (ui.numConvos===1 && ui.numSpeakers===1);

      const rules = [
        `Create EXACTLY UI.numConvos conversation sections: "Conversation 1"...`,
        `Each conversation has EXACTLY UI.turns turns (rows).`,
        `Use EXACTLY UI.numSpeakers distinct speaker name(s); if UI.numSpeakers === 1, use the same speaker name for all turns (monologue).`,
        `Each turn has between UI.sentences_per_turn.min and UI.sentences_per_turn.max sentences in Spanish (and English if included). Prefer the UPPER bound and longer, multi-clause sentences${isMono?' for a very long monologue':''}.`,
        (ui.includeEN==='yes'
          ? 'Headers must be exactly "English" and "Español".'
          : 'Single column header must be "Español".'),
        `Tone: "${ui.tone}". Region/culture cues: "${ui.region}". Level: ${ui.level}.`,
        `LEVEL RULES:\n- ${levelLines.join('\n- ')}`,
        (ui.addFIB==='yes' ? `Include Fill-in-the-Blank (${ui.fibFocus}) with large set (≈ ${Math.max(8, Math.min(40, Math.round(ui.turns*0.9)))}) following formatting rules.` : ''),
        (ui.showVocabList==='yes' ? 'Include "Vocabulary Used".' : ''),
        (ui.showFIBKey==='yes' ? 'Include "Answer Key".' : ''),
        'No empty <tbody>. SELF-CHECK all constraints before returning.'
      ].filter(Boolean);

      const conversationsHTML = Array.from({length: ui.numConvos}).map((_,i)=>`
  <div class="section">
    <h2>Conversation ${i+1}</h2>
    <table class="tbl">
      <thead>
        ${ui.includeEN==='yes'
          ? '<tr><th>English</th><th lang="es">Español</th></tr>'
          : '<tr><th lang="es">Español</th></tr>'}
      </thead>
      <tbody></tbody>
    </table>
  </div>`).join('');

      const prompt =
`<!DOCTYPE html>
<!-- FCS CONVERSATION OUTPUT (full HTML) -->
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conversation — ${ui.topic}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a;--hi:#eef2ff}
  *{box-sizing:border-box}
  body{font-family:Calibri,Arial,sans-serif;font-size:11pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin:14px 0;overflow-x:auto}
  .legend{font-size:9pt;color:var(--muted);text-align:center;margin-top:6px}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:8px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700}
  .es{color:var(--es);font-weight:700}
  @media(max-width:700px){ .tbl{font-size:9pt;width:auto}.tbl thead{display:none}.tbl td{display:block;width:100%}.tbl td+td{margin-top:6px} }
</style>
</head>
<body>
<div class="fcs-doc">
  <h1>Conversation: ${ui.topic} — Level ${ui.level}</h1>
  <div class="legend"><span class="en">EN vocab = blue</span> | <span class="es">ES vocab = red</span>.</div>

  <!-- CONTRACT (STRICT):
    UI = ${JSON.stringify(ui)}
    ${rules.map((r,i)=>`- ${r}`).join('\n    ')}
  -->

  ${conversationsHTML}

  ${(ui.addFIB==='yes') ? `
  <div class="section">
    <h2>Practice — Fill-in-the-Blank (${ui.fibFocus})</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Español</th></tr></thead><tbody></tbody></table>
  </div>` : ''}

  ${(ui.showVocabList==='yes') ? `
  <div class="section">
    <h2>Vocabulary Used</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Español</th></tr></thead><tbody></tbody></table>
  </div>` : ''}

  ${(ui.showFIBKey==='yes') ? `
  <div class="section">
    <h2>Answer Key</h2>
    <table class="tbl"><thead><tr><th>#</th><th>Answer</th></tr></thead><tbody></tbody></table>
  </div>` : ''}

  ${ui.vocab && ui.vocab!=="(auto-generate level-appropriate list if empty)" ?
  `<div class="legend" style="white-space:pre-wrap;border:1px dashed var(--border);padding:8px;border-radius:8px;margin-top:8px;">
    Teacher Vocabulary (STRICT use):\n${ui.vocab.replace(/</g,"&lt;").replace(/>/g,"&gt;")}
  </div>` : ''}

  ${ui.teacherNotes ? `<div class="legend" style="white-space:pre-wrap;margin-top:8px;">Teacher notes:\n${ui.teacherNotes.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>` : ''}

</div>
</body>
</html>`;
      return { prompt, ui };
    }

    /* ---- Generate ---- */
    genBtn.addEventListener('click', async ()=>{
      const topic=$('c-topic').value.trim(); if(!topic){statusEl.textContent="Enter a topic.";return;}
      const { prompt, ui } = buildConvoPrompt();

      const validator = (html)=>{
        try{
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const problems = [];

          const convH2s = Array.from(doc.querySelectorAll('.section h2')).filter(h=>/Conversation\s+\d+/i.test(h.textContent||''));
          if (convH2s.length !== ui.numConvos) problems.push(`need exactly ${ui.numConvos} conversation sections, found ${convH2s.length}`);

          convH2s.forEach((h2, idx)=>{
            const tbl = h2.parentElement.querySelector('table'); if(!tbl){problems.push(`conv ${idx+1}: missing table`); return;}
            const ths = Array.from(tbl.querySelectorAll('thead th')).map(th=>th.textContent.trim().toLowerCase());
            if (ui.includeEN==='yes'){
              if (!ths.includes('english') || !ths.find(t=>t.includes('español')||t.includes('espanol'))) problems.push(`conv ${idx+1}: must have English | Español headers`);
            } else {
              if (ths.length!==1 || !(ths[0].includes('español')||ths[0].includes('espanol'))) problems.push(`conv ${idx+1}: must have only Español column`);
            }

            const rows = Array.from(tbl.querySelectorAll('tbody tr'));
            // EXACT turns required
            if (rows.length !== ui.turns) problems.push(`conv ${idx+1}: must have exactly ${ui.turns} turns (rows), found ${rows.length}`);

            // sentence counts per turn
            rows.forEach((tr, ri)=>{
              const tds = Array.from(tr.querySelectorAll('td'));
              const esIdx = (ui.includeEN==='yes') ? 1 : 0;
              const esText = (tds[esIdx]?.textContent||'').trim();
              if (esText){
                const sCount = (esText.replace(/\s+/g,' ').match(/[^\.!?¡¿]+[\.!?…]+/g)||[esText]).length;
                if (sCount < ui.sentences_per_turn.min || sCount > ui.sentences_per_turn.max){
                  problems.push(`conv ${idx+1} row ${ri+1} (ES): ${sCount} sentences (must be ${ui.sentences_per_turn.min}-${ui.sentences_per_turn.max})`);
                }
              }
              if (ui.includeEN==='yes'){
                const enText = (tds[0]?.textContent||'').trim();
                if (enText){
                  const sCountEn = (enText.replace(/\s+/g,' ').match(/[^\.!?]+[\.!?…]+/g)||[enText]).length;
                  if (sCountEn < ui.sentences_per_turn.min || sCountEn > ui.sentences_per_turn.max){
                    problems.push(`conv ${idx+1} row ${ri+1} (EN): ${sCountEn} sentences (must be ${ui.sentences_per_turn.min}-${ui.sentences_per_turn.max})`);
                  }
                }
              }
            });

            // speakers count; if mono (1 & 1) enforce one speaker only
            const speakerNames = new Set(Array.from(tbl.querySelectorAll('tbody td'))
              .map(td=>(td.textContent||'').trim().match(/^([A-Za-zÁÉÍÓÚÜÑáéíóúüñ'’\-]+)\s*:/))
              .filter(Boolean).map(m=>m[1]));
            if (speakerNames.size && speakerNames.size !== ui.numSpeakers){
              problems.push(`conv ${idx+1}: expected ${ui.numSpeakers} distinct speaker(s), found ${speakerNames.size}`);
            }
          });

          // FIB section checks (if requested)
          if (ui.addFIB==='yes'){
            const fibH2 = Array.from(doc.querySelectorAll('.section h2')).find(h=>/Fill\-in\-the\-Blank|Practice/i.test(h.textContent||''));
            if(!fibH2){ problems.push('missing Fill-in-the-Blank section'); }
            else{
              const table = fibH2.parentElement.querySelector('table');
              if(!table){ problems.push('FIB: missing table'); }
              else{
                const ths = Array.from(table.querySelectorAll('thead th')).map(th=>th.textContent.trim());
                if (ths[0] !== 'English' || ths[1] !== 'Español') problems.push('FIB headers must be exactly "English" and "Español"');
              }
            }
          }

          return problems.length ? problems.join('; ') : '';
        }catch(e){ return ''; }
      };

      await generateResultWithRetries(prompt, genBtn, statusEl, outputEl, validator, 1);
      await Speech.ensureVoices();
      addPerLineTTS(outputEl);
      addConversationPlayers(outputEl);
      genBtn.disabled = false;
    });

    promptBtn.addEventListener('click', ()=>{
      const topic=$('c-topic').value.trim(); if(!topic){statusEl.textContent="Enter a topic.";return;}
      const instruction = buildConvoInstruction();
      copyText(instruction, statusEl);
    });

    $('c-copy').addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    $('c-excel').addEventListener('click', ()=>downloadAsExcel(outputEl,statusEl,$('c-topic').value||'Conversation'));
  })();

  /* =========================
     Test (unchanged)
     ========================= */
  (function setupTest(){
    const testUI =
      `<div class="fcs-card">
        <h2>Test Creator</h2>
        <div><label for="t-vocab">Vocabulary List</label><textarea id="t-vocab" rows="6" placeholder="Paste the EXACT vocabulary for the test..."></textarea></div>
        <div><label for="t-level">Level (Grammar)</label>
          <select id="t-level">
            <option value="1" selected>Level 1 — Survival</option>
            <option value="2">Level 2 — Beginner</option>
            <option value="3">Level 3 — Intermediate</option>
            <option value="4">Level 4 — Conversational</option>
            <option value="5">Level 5 — Fluent</option>
          </select></div>
        <div><label><input type="checkbox" id="t-anskeys" checked> Include Teacher Answer Keys?</label></div>
        <div class="actions"><button id="t-gen" class="primary">Generate</button><button id="t-excel">Excel</button><button id="t-copy">Copy</button><div id="t-status" class="status"></div></div>
      </div>
      <div id="t-output" class="output-container"><p>Your test will appear here...</p></div>`;
    $('gen-test').innerHTML=testUI;

    const genBtn=$('t-gen'),excelBtn=$('t-excel'),copyBtn=$('t-copy'),statusEl=$('t-status'),outputEl=$('t-output');

    genBtn.addEventListener('click', async ()=>{
      const vocabEl=$('t-vocab'); if(!vocabEl.value.trim()){statusEl.textContent="Please paste a vocab list.";return;}
      const prompt =
`<!DOCTYPE html>
<!-- FCS TEST OUTPUT -->
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Test — Level ${$('t-level').value}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a}
  *{box-sizing:border-box} body{font-family:Calibri,Arial,sans-serif;font-size:10pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:14px;overflow-x:auto}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:8px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700} .es{color:var(--es);font-weight:700}
  .note{font-size:9pt;color:var(--muted)}
  @media(max-width:700px){ .tbl{font-size:9pt;width:auto} }
</style></head>
<body><div class="fcs-doc">
  <h1>FCS Conversation Test — Level ${$('t-level').value}</h1>
  <div class="note"><span class="en">English terms = blue</span>; <span class="es">Spanish terms = red</span> whenever vocabulary appears inline.</div>

  <div class="section">
    <h2>Part 1 — Spanish → English</h2>
    <table class="tbl"><thead><tr><th>#</th><th lang="es">Español</th>${$('t-anskeys').checked ? '<th>Answer (EN)</th>' : ''}</tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Part 2 — English → Spanish</h2>
    <table class="tbl"><thead><tr><th>#</th><th>English</th>${$('t-anskeys').checked ? '<th lang="es">Answer (ES)</th>' : ''}</tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Part 3 — Live Conversation Prompts</h2>
    <table class="tbl"><thead><tr><th>#</th><th lang="es">Prompt (Español)</th></tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  ${$('t-anskeys').checked ? `<div class="section"><h2>Answer Key</h2><!-- answers only --></div>` : ''}

  <div class="note">Vocabulary pasted by teacher:</div>
  <div class="note" style="white-space:pre-wrap;border:1px dashed var(--border);padding:8px;border-radius:8px;">${$('t-vocab').value.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>

</div></body></html>`;
      const html = await callAPI(prompt);
      outputEl.innerHTML = html;
      statusEl.textContent = "Done.";
      await Speech.ensureVoices();
      addPerLineTTS(outputEl);
    });

    $('t-copy').addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    $('t-excel').addEventListener('click',()=>downloadAsExcel(outputEl,statusEl,'Test'));
  })();

})();
</script>
</body>
</html>
