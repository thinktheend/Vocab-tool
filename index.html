<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>FCS AI Generator Suite</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  :root { --bg:#f7f9fc; --fg:#111; --muted:#667085; --border:#e5e7eb; --panel:#ffffff; --accent:#0b5cff;
          --en:#1a73e8; --es:#d93025; --head:#0f172a; }
  body { background: var(--bg); color: var(--fg); font-family: Calibri, Arial, sans-serif; font-size: 15px; margin:0; }
  .fcs-wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
  h1 { font-size: 28px; font-weight:700; text-align:center; margin-bottom: 28px; color: var(--head); }
  h2 { font-size: 20px; font-weight:700; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; color: var(--head); }
  .fcs-card { border:1px solid var(--border); border-radius: 12px; padding: 24px; background:var(--panel); margin-bottom: 20px; }
  label { font-weight: 600; font-size: 14px; display: block; margin-bottom: 6px; }
  input[type="text"], select, input[type="number"], textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size:15px; box-sizing:border-box; }
  input:disabled { background-color: #f8f9fa; }
  .hint, .small { font-size: 12px; color: var(--muted); margin-top: 4px; }
  button { padding: 10px 16px; border-radius: 8px; border:1px solid var(--border); background:#f6f8fb; cursor: pointer; font-weight: 600; font-size:15px; transition: all 0.2s; }
  button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
  button:disabled { cursor: not-allowed; opacity: 0.6; }
  .fcs-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  .fcs-tab-btn { flex-grow: 1; text-align: center; } .fcs-generator { display: none; } .fcs-generator.active { display: block; }
  .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; align-items: end; }
  .six { grid-column: span 6; } .twelve { grid-column: span 12; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; } .grid-full { grid-column: 1 / -1; }
  .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top:20px; align-items:center; }
  .status { margin-top:10px; min-height:1.5em; text-align:left; color:var(--muted); font-size:13px; }
  .output-container { border:1px solid var(--border); border-radius:12px; padding:24px; background:#fff; min-height: 240px; margin-top:12px; }
  .output-container h1, .output-container h2 { text-align: center; color: #0f172a !important; }
  .output-container table { width:100%; border-collapse: separate; border-spacing: 0; margin-top: 12px; font-size:10pt;}
  .output-container th, .output-container td { border:1px solid #e5e7eb; padding:8px; vertical-align:top; }
  .output-container th { background: #f5f7fb; }
  .output-container tr:nth-child(even) td { background: #fafafa; }
  .output-container .en { color: var(--en); font-weight: bold; }
  .output-container .es { color: var(--es); font-weight: bold; }
  .output-container .full-black { color: var(--fg); font-weight: 700; }

  .tts-line-btn { display:inline-flex; align-items:center; gap:4px; padding:2px 6px; margin-right:6px; border:1px solid #dbe2ef;
    border-radius:999px; background:#eef2ff; cursor:pointer; font-size:12px; line-height:1; }
  .tts-line-btn[data-tts="es"] { background:#fdeaea; border-color:#f5c2c7; }
  .tts-line-btn:hover { filter:brightness(0.98); }

  .conv-ctrls { display:flex; gap:8px; align-items:center; margin:6px 0 10px; }
  .conv-ctrls button { padding:6px 10px; font-size:12px; }

  @media (max-width: 860px){ .six, .twelve { grid-column: span 12; } .grid-2{grid-template-columns:1fr;} }
</style>
</head>
<body>
<div class="fcs-wrap">
  <h1>FCS AI GENERATOR SUITE</h1>
  <div class="fcs-tabs">
    <button id="tab-vocab" class="fcs-tab-btn primary">Vocabulary</button>
    <button id="tab-convo" class="fcs-tab-btn">Conversation</button>
    <button id="tab-test" class="fcs-tab-btn">Test</button>
  </div>

  <div id="gen-vocab" class="fcs-generator active"></div>
  <div id="gen-convo" class="fcs-generator"></div>
  <div id="gen-test" class="fcs-generator"></div>
</div>

<script>
"use strict";
(function(){
  const $=id=>document.getElementById(id);
  const API_URL="/api/index";

  /* ---------- Helpers ---------- */
  function decodeIfEscaped(html){
    const s=String(html||'');
    if(/&lt;(!DOCTYPE|html|head|body|div|table|h1|h2)/i.test(s)){
      const ta=document.createElement('textarea'); ta.innerHTML=s; return ta.value;
    }
    return s;
  }
  function extractDocHTML(html){
    const parsed=new DOMParser().parseFromString(html,'text/html');
    let node = parsed.querySelector('.fcs-doc') || parsed.body || parsed.documentElement;
    node.querySelectorAll('script').forEach(s=>s.remove());
    return node.innerHTML || '';
  }
  function renderGenerated(html, container){
    const normalized = decodeIfEscaped(html);
    const safeInner = extractDocHTML(normalized);
    container.innerHTML = safeInner || normalized;
  }
  const safeForScriptTemplate = s => String(s||'').replace(/<\/script/gi,'<\\/script');

  /* ---------- TTS ---------- */
  const Speech = (function(){
    let voices=[], ready=false;
    function load(){ voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : []; return voices.length>0; }
    async function ensure(){
      if(!('speechSynthesis' in window)) return [];
      if(ready && voices.length) return voices;
      if(load()){ ready=true; return voices; }
      return new Promise(res=>{
        const h=()=>{ if(load()){ ready=true; window.speechSynthesis.onvoiceschanged=null; res(voices); } };
        window.speechSynthesis.onvoiceschanged=h; setTimeout(h,800);
      });
    }
    function pick(lang){
      const L=String(lang||'').toLowerCase();
      return voices.find(v=>v.lang.toLowerCase()===L)
          || voices.find(v=>v.lang.toLowerCase().startsWith(L.split('-')[0])) || null;
    }
    function speak(text, lang, onend){
      if(!('speechSynthesis' in window)) { if(onend) onend(); return; }
      const t=(text||'').replace(/\s+/g,' ').trim(); if(!t){ if(onend) onend(); return; }
      const u=new SpeechSynthesisUtterance(t);
      u.lang = (lang==='es' ? 'es-ES' : 'en-US');
      const v=pick(u.lang); if(v) u.voice=v;
      if (onend) u.onend = onend;
      window.speechSynthesis.speak(u);
    }
    function pause(){ if('speechSynthesis' in window) window.speechSynthesis.pause(); }
    function resume(){ if('speechSynthesis' in window) window.speechSynthesis.resume(); }
    function cancel(){ if('speechSynthesis' in window) window.speechSynthesis.cancel(); }
    return { ensure, speak, pause, resume, cancel };
  })();

  function addPerLineTTS(root){
    if(!root || !('speechSynthesis' in window)) return;
    root.querySelectorAll('table tbody tr').forEach(tr=>{
      const tds=tr.querySelectorAll('td'); if(tds.length<2) return;
      ['en','es'].forEach((lang,idx)=>{
        const cell=tds[idx];
        if(!cell || cell.querySelector('.tts-line-btn')) return;
        const btn=document.createElement('button');
        btn.type='button'; btn.className='tts-line-btn'; btn.dataset.tts=lang;
        btn.textContent = 'üîä ' + (lang==='en' ? 'EN' : 'ES');
        btn.addEventListener('click',e=>{
          e.stopPropagation();
          const text=(cell.innerText||'').replace(/^\s*üîä\s*(EN|ES)\s*/,'').trim();
          Speech.cancel();
          Speech.speak(text,lang);
        });
        cell.insertBefore(btn, cell.firstChild);
      });
    });
  }

  function injectGlobalTTSControlsForConvo(root){
    if (!root) return;
    let ctrl = root.querySelector('.conv-ctrls');
    if (ctrl) ctrl.remove();
    ctrl = document.createElement('div');
    ctrl.className = 'conv-ctrls';
    ctrl.innerHTML = `
      <button type="button" id="c-play">‚ñ∑ Play All</button>
      <button type="button" id="c-pause">‚è∏ Pause</button>
      <button type="button" id="c-stop">‚èπ Stop</button>
      <span class="small" id="c-tts-status"></span>
    `;
    root.prepend(ctrl);

    const status = ctrl.querySelector('#c-tts-status');

    function buildQueue(){
      const items = [];
      root.querySelectorAll('h2').forEach(h=>{
        if (!/^Conversation\s+\d+/i.test(h.textContent)) return;
        const tbody = h.parentElement.querySelector('table tbody');
        if (!tbody) return;
        tbody.querySelectorAll('tr').forEach(tr=>{
          const tds = tr.querySelectorAll('td');
          if (tds[0]) items.push({lang:'en', text: tds[0].innerText.replace(/^\s*üîä\s*EN\s*/,'').trim()});
          if (tds[1]) items.push({lang:'es', text: tds[1].innerText.replace(/^\s*üîä\s*ES\s*/,'').trim()});
        });
      });
      return items;
    }

    let queue = [];
    let index = 0;
    let running = false;
    function play(){
      if (!running){
        Speech.cancel();
        queue = buildQueue();
        index = 0;
        running = true;
      } else {
        Speech.resume();
        status.textContent = 'Playing...';
        return;
      }
      const step = ()=>{
        if (index >= queue.length){ running=false; status.textContent='Done.'; return; }
        const item = queue[index++];
        status.textContent = `Playing (${index}/${queue.length})`;
        Speech.speak(item.text, item.lang, step);
      };
      step();
    }
    function pause(){ Speech.pause(); status.textContent='Paused.'; }
    function stop(){ Speech.cancel(); running=false; status.textContent='Stopped.'; }

    ctrl.querySelector('#c-play').addEventListener('click', play);
    ctrl.querySelector('#c-pause').addEventListener('click', pause);
    ctrl.querySelector('#c-stop').addEventListener('click', stop);
  }

  /* Tabs */
  (function initTabs(){
    const t=document.querySelectorAll(".fcs-tab-btn"), e=document.querySelectorAll(".fcs-generator");
    t.forEach(o=>{o.addEventListener("click",()=>{const n=o.id.replace("tab-","gen-");t.forEach(t=>t.classList.remove("primary")),o.classList.add("primary"),e.forEach(t=>{t.style.display=t.id===n?"block":"none"})})})
  })();

  async function callAPI(prompt){
    const resp=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})});
    const json=await resp.json();
    if(!resp.ok) throw new Error(json.details||json.error||"Unknown server error.");
    return json.content;
  }

  async function generateAndRender(basePrompt, button, statusEl, outputEl, validator, maxRetries=2){
    try{
      button.disabled=true;
      statusEl.textContent="Generating...";
      outputEl.innerHTML="<h4>Please wait. AI is working...</h4>";
      let html = await callAPI(basePrompt);

      for (let attempt=0; attempt<maxRetries; attempt++){
        const err = validator ? validator(html) : "";
        if (!err) break;
        statusEl.textContent = `Fixing constraints‚Ä¶ (${attempt+1}/${maxRetries})`;
        html = await callAPI(basePrompt + `

<!-- STRICT FIX REQUIRED:
${err}
Do not reduce requested quantities. Preserve document structure (.fcs-doc, section order, tables).
-->`);
      }

      renderGenerated(html, outputEl);
      await Speech.ensure();
      addPerLineTTS(outputEl);
      statusEl.textContent="Done.";
    }catch(err){
      console.error(err);
      statusEl.textContent="Generation failed.";
      outputEl.innerHTML="<p style='color:#d93025'>An error occurred while generating. Please try again.</p>";
    }finally{
      button.disabled=false;
    }
  }

  function downloadAsExcel(container,statusEl,filename){
    try{
      const firstTable = container.querySelector("table");
      if(!firstTable){ statusEl.textContent="No data to export."; return; }
      statusEl.textContent="Creating Excel...";
      const wb=XLSX.utils.book_new(), rows=[], title=container.querySelector("h1")?container.querySelector("h1").innerText:(filename||'Export');
      rows.push([title]); rows.push([]);
      container.querySelectorAll("h2, table").forEach(el=>{
        if(el.tagName==="H2"){ rows.push([el.innerText]); }
        if(el.tagName==="TABLE"){
          el.querySelectorAll("tr").forEach(tr=>{
            const line=Array.from(tr.querySelectorAll("th, td")).map(td=>{
              const clone = td.cloneNode(true);
              clone.querySelectorAll('.tts-line-btn').forEach(b=>b.remove());
              return clone.innerText;
            });
            rows.push(line);
          });
          rows.push([]);
        }
      });
      const ws=XLSX.utils.aoa_to_sheet(rows);
      ws["!cols"]=rows.reduce((acc,row)=>{row.forEach((cell,i)=>{const w=(cell?cell.toString():"").length+2; if(!acc[i]||acc[i].wch<w) acc[i]={wch:w}}); return acc;},[]);
      XLSX.utils.book_append_sheet(wb,ws,"Generated Content");
      XLSX.writeFile(wb,`${(filename||'Export').replace(/\s+/g,"_")}.xlsx`);
      statusEl.textContent="Download started.";
    }catch(e){ console.error("Excel Error:",e); statusEl.textContent="Failed to create Excel."; }
  }

  function copyToClipboard(container,statusEl){
    try{
      const txt = container.innerText.trim();
      if(!txt){ statusEl.textContent="Nothing to copy."; return; }
      if (navigator.clipboard && window.isSecureContext){
        navigator.clipboard.writeText(txt).then(()=>statusEl.textContent="Copied!",()=>{
          const t=document.createElement("textarea");
          t.value=txt; document.body.appendChild(t); t.select();
          try{ document.execCommand("copy") ? statusEl.textContent="Copied!" : statusEl.textContent="Copy failed."; }
          catch(e){ statusEl.textContent="Copy failed."; }
          document.body.removeChild(t);
        });
      } else {
        const t=document.createElement("textarea");
        t.value=txt; document.body.appendChild(t); t.select();
        try{ document.execCommand("copy") ? statusEl.textContent="Copied!" : statusEl.textContent="Copy failed."; }
        catch(e){ statusEl.textContent="Copy failed."; }
        document.body.removeChild(t);
      }
    }catch(e){ statusEl.textContent="Copy failed."; }
  }
  function copyText(text,statusEl){
    const t=(text||"").trim();
    if(!t){ statusEl.textContent="Nothing to copy."; return; }
    if (navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(t).then(()=>statusEl.textContent="Prompt copied!",()=>{
        const ta=document.createElement("textarea");
        ta.value=t; document.body.appendChild(ta); ta.select();
        try{ document.execCommand("copy") ? statusEl.textContent="Prompt copied!" : statusEl.textContent="Copy failed."; }
        catch(e){ statusEl.textContent="Copy failed."; }
        document.body.removeChild(ta);
      });
    } else {
      const ta=document.createElement("textarea");
      ta.value=t; document.body.appendChild(ta); ta.select();
      try{ document.execCommand("copy") ? statusEl.textContent="Prompt copied!" : statusEl.textContent="Copy failed."; }
      catch(e){ statusEl.textContent="Copy failed."; }
      document.body.removeChild(ta);
    }
  }

  /* ===== Util: sentence splitter (cross-browser) ===== */
  function splitIntoSentences(text){
    const norm = String(text || '').replace(/\s+/g,' ').trim();
    if(!norm) return [];
    const parts = norm.match(/[^.!?]+[.!?]?/g) || [];
    return parts.map(s=>s.trim()).filter(Boolean);
  }

  /* ===== Level rules (Conversation) ===== */
  function getLevelRulesLines(level){
    switch(String(level)){
      case '1': return ['LEVEL 1 ‚Äî Survival (‚âà CEFR A1) (MUST FOLLOW):','‚Ä¢ Basic present tense; ser/estar recognition; simple WH- questions.','‚Ä¢ Glue words: y, o, pero, porque; prepositions: a, en, de, con.','‚Ä¢ Concrete everyday vocabulary only.'];
      case '2': return ['LEVEL 2 ‚Äî Beginner (‚âà CEFR A2) (MUST FOLLOW):','‚Ä¢ Present tense production; tener que, necesitar, querer, ir a, poder, acabar de, gustar.','‚Ä¢ Ser vs. estar; simple object pronouns; reflexives with regular verbs.','‚Ä¢ Polite conditional with poder/gustar/deber; basic time words.'];
      case '3': return ['LEVEL 3 ‚Äî Intermediate (‚âà CEFR B1) (MUST FOLLOW):','‚Ä¢ Pret√©rito + imperfecto; present progressive.','‚Ä¢ Narrative sequencing (primero, despu√©s, luego, finalmente).','‚Ä¢ Add comparisons and richer connectors.'];
      case '4': return ['LEVEL 4 ‚Äî Conversational (‚âà CEFR B2) (MUST FOLLOW):','‚Ä¢ Simple future & conditional; present perfect & present perfect progressive.','‚Ä¢ All uses of ‚Äúse‚Äù.','‚Ä¢ Nuanced connectors (aunque, sin embargo, por lo tanto).'];
      case '5': return ['LEVEL 5 ‚Äî Fluent (‚âà CEFR C1) (MUST FOLLOW):','‚Ä¢ Imperatives; subjunctive (present/past) where required.','‚Ä¢ Expanded progressives & perfects; persuasion and hedging.','‚Ä¢ Complex discourse markers (aun as√≠, por ende, no obstante).'];
      case '6': return ['LEVEL 6 ‚Äî Native (‚âà CEFR C2) (MUST FOLLOW):','‚Ä¢ Native-like register and idioms; precise aspect & mood.','‚Ä¢ Cohesive devices across long discourse; subtle pragmatics.','‚Ä¢ Still obey UI constraints.'];
      default: return [];
    }
  }

  /* =========================
     Vocabulary (enforce count; no Index)
     ========================= */
  (function setupVocab(){
    const vocabUI =
      `<div class="fcs-card">
        <h2>Vocabulary Creator</h2>
        <div class="grid">
          <div class="six"><label for="v-topic">Topic</label><input id="v-topic" type="text" placeholder="e.g., At the Airport"></div>

          <div class="six"><label for="v-plan">Word Count Plan</label>
            <select id="v-plan">
              <option value="1" selected>Word Count 1</option>
              <option value="2">Word Count 2</option>
              <option value="3">Word Count 3</option>
              <option value="4">Word Count 4</option>
              <option value="5">Word Count 5</option>
              <option value="custom">Custom</option>
            </select>
            <div id="v-presetText" class="hint"></div>
          </div>

          <div class="twelve">
            <label>Sections to Include (multi-select)</label>
            <div id="v-sections" style="display:flex; flex-wrap:wrap; gap:14px;">
              <label><input type="checkbox" id="v-sec-all" checked> All</label>
              <label><input type="checkbox" class="v-sec" value="nouns" checked> Nouns</label>
              <label><input type="checkbox" class="v-sec" value="verbs" checked> Verbs</label>
              <label><input type="checkbox" class="v-sec" value="adjectives" checked> Adjectives</label>
              <label><input type="checkbox" class="v-sec" value="adverbs" checked> Adverbs</label>
              <label><input type="checkbox" class="v-sec" value="phrases" checked> Common Phrases</label>
              <label><input type="checkbox" class="v-sec" value="questions" checked> Common Questions</label>
            </div>
            <div class="hint">Uncheck to generate only the sections you need. ‚ÄúAll‚Äù toggles everything.</div>
          </div>

          <div class="six">
            <div class="grid">
              <div class="six"><label for="v-tmin">Min (custom)</label><input id="v-tmin" type="number" min="1" max="300" disabled></div>
              <div class="six"><label for="v-tmax">Max (custom)</label><input id="v-tmax" type="number" min="1" max="300" disabled></div>
            </div>
          </div>

          <div class="twelve">
            <label for="v-vocab-include">Vocabulary to Include (optional)</label>
            <textarea id="v-vocab-include" rows="3" placeholder="Paste a full or partial list of words to include..."></textarea>
          </div>
        </div>
        <div class="actions">
          <button id="v-gen" class="primary">Generate Vocabulary</button>
          <button id="v-excel">Download Excel</button>
          <button id="v-copy">Copy</button>
          <button id="v-prompt">Prompt</button>
          <div id="v-status" class="status"></div>
        </div>
      </div>
      <div id="v-output" class="output-container"><p>Your list will appear here...</p></div>`;
    $('gen-vocab').innerHTML=vocabUI;

    const genBtn=$('v-gen'),excelBtn=$('v-excel'),copyBtn=$('v-copy'),promptBtn=$('v-prompt'),statusEl=$('v-status'),outputEl=$('v-output'),
          planEl=$("v-plan"),tminEl=$("v-tmin"),tmaxEl=$("v-tmax"),
          presetTextEl=$("v-presetText"),topicEl=$("v-topic");

    const allBox = $('v-sec-all');
    const childBoxes = Array.from(document.querySelectorAll('.v-sec'));
    function setChildren(checked){ childBoxes.forEach(b=>b.checked=checked); }
    function syncAll(){ allBox.checked = childBoxes.every(b=>b.checked); }
    allBox.addEventListener('change', ()=> setChildren(allBox.checked));
    childBoxes.forEach(b=> b.addEventListener('change', syncAll));

    const presetRanges={
      "1":{min:33,max:55},"2":{min:60,max:85},"3":{min:90,max:120},"4":{min:160,max:220},"5":{min:210,max:280}
    };
    function updateUI(){
      const isCustom=planEl.value==='custom';
      tminEl.disabled=!isCustom; tmaxEl.disabled=!isCustom;
      if(!isCustom){
        const r=presetRanges[planEl.value];
        tminEl.value=r.min; tmaxEl.value=r.max;
        presetTextEl.textContent=`Preset for Word Count ${planEl.value}: ${r.min}‚Äì${r.max} total items (rows across all sections).`;
      }else{ presetTextEl.textContent=`Custom: set Min/Max (1‚Äì300).`; }
    }
    planEl.addEventListener('change',updateUI); updateUI();

    function currentRange(){
      if (planEl.value==='custom'){
        const min=Math.max(1, Math.min(300, Number(tminEl.value)||1));
        const max=Math.max(min, Math.min(300, Number(tmaxEl.value)||min));
        return {min,max};
      }
      return presetRanges[planEl.value];
    }

    function buildVocabInstruction(){
      const {min,max}=currentRange();
      const topic=(topicEl.value||'').trim();
      const selected = Array.from(document.querySelectorAll('.v-sec:checked')).map(b=>b.value);
      return [
`You are an expert assistant for the FCS program.`,
`Topic: ‚Äú${topic}‚Äù.`,
`ABSOLUTE QUANTITY: Produce between ${min} and ${max} total ROWS across the sections listed below (each table row = 1 item). Target the UPPER bound. Do not under-deliver.`,
`Sections (in this exact order): ${selected.length?selected.join(', '):'nouns, verbs, adjectives, adverbs, phrases, questions'}.`,
`Formatting: Output Markdown (no HTML). Each section is a two-column table: English | Espa√±ol.`,
`Rules per section (same as before, shortened):`,
`‚Ä¢ Nouns ‚Äî words/phrases only; subcategory header rows allowed; Spanish noun text visually marked with <span class="es">‚Ä¶</span> in your internal plan (rendered as plain text in Markdown).`,
`‚Ä¢ Verbs in Sentences ‚Äî English uses ‚Äúis/are going to‚Äù and bolds only ‚Äúto + verb‚Äù; Spanish bolds only the infinitive.`,
`‚Ä¢ Adjectives ‚Äî ‚Äúis/are + adjective‚Äù; bold only the adjective.`,
`‚Ä¢ Adverbs ‚Äî reuse verbs; bold only the adverb.`,
`‚Ä¢ Common Phrases ‚Äî phrases only.`,
`‚Ä¢ Common Questions ‚Äî questions only (no answers).`,
`Self-check counts before responding so the TOTAL ROWS across all sections ‚àà [${min}, ${max}].`
      ].join('\n');
    }

    function buildVocabPrompt(){
      const rawPrompt=buildVocabInstruction();
      const topic=safeForScriptTemplate((topicEl.value||'').trim());
      return `<!DOCTYPE html>
<!-- FCS VOCABULARY OUTPUT
  1) First internally answer the Markdown prompt EXACTLY and ensure TOTAL ROWS ‚àà required range.
  2) Then render the SAME content as styled HTML (no Full Vocabulary Index).
-->
<html lang="en">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vocabulary ‚Äî ${topic}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a;}
  *{box-sizing:border-box} body{font-family:Calibri,Arial,sans-serif;font-size:10pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:14px;overflow-x:auto}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:6px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700} .es{color:var(--es);font-weight:700}
</style></head>
<body><div class="fcs-doc" lang="en">
  <h1>Vocabulary: ${topic}</h1>

  <div class="section"><h2>Nouns</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="section"><h2>Verbs in Sentences</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="section"><h2>Adjectives</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="section"><h2>Adverbs</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="section"><h2>Common Phrases</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="section"><h2>Common Questions</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
  </div>
</div></body></html>

<!-- ORIGINAL PROMPT FOR CONTENT PARITY
${rawPrompt}
-->`;
    }

    function countVocabRows(doc){
      const secs = Array.from(doc.querySelectorAll('.section'));
      let rows = 0;
      secs.forEach(s=>{
        const tbody = s.querySelector('tbody'); if(!tbody) return;
        tbody.querySelectorAll('tr').forEach(tr=>{
          const tds = tr.querySelectorAll('td');
          if (tds.length === 2) rows += 1; // count only proper 2-cell rows
        });
      });
      return rows;
    }

    function vocabValidator(html){
      const {min,max}=currentRange();
      if (/Full Vocabulary Index/i.test(html)) return 'Remove "Full Vocabulary Index".';
      try{
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const total = countVocabRows(doc);
        if (total < min) return `You produced ${total} rows; required minimum is ${min}. Add ${min-total} more rows while keeping the same section order and formatting.`;
        if (total > max) return `You produced ${total} rows; maximum is ${max}. Trim ${total-max} rows without changing section order and formatting.`;
      }catch(_){}
      return "";
    }

    $('v-gen').addEventListener('click', async ()=>{
      if(!topicEl.value.trim()){ $('v-status').textContent="Please enter a topic."; return; }
      await generateAndRender(buildVocabPrompt(), $('v-gen'), $('v-status'), $('v-output'), vocabValidator, 4);
    });
    $('v-prompt').addEventListener('click', ()=>{
      if(!topicEl.value.trim()){ $('v-status').textContent="Please enter a topic."; return; }
      copyText(buildVocabInstruction(), $('v-status'));
    });
    $('v-copy').addEventListener('click',()=>copyToClipboard($('v-output'),$('v-status')));
    $('v-excel').addEventListener('click',()=>downloadAsExcel($('v-output'),$('v-status'),$('v-topic').value||'Vocabulary'));
  })();

  /* =========================
     Conversation (strict length, no blanks in conv, FIB rules, Vocab Used contains Answer Key)
     ========================= */
  (function setupConvo(){
    const convoUI =
      `<div class="fcs-card"><h2>Conversation Creator</h2>
        <div class="grid-2">
          <div class="grid-full"><label for="c-topic">Topic</label><input id="c-topic" type="text" placeholder="e.g., A funny story about a vacation"/></div>

          <div><label>Level (Grammar)</label>
            <select id="c-level">
              <option value="1" selected>Level 1 ‚Äî Survival</option>
              <option value="2">Level 2 ‚Äî Beginner</option>
              <option value="3">Level 3 ‚Äî Intermediate</option>
              <option value="4">Level 4 ‚Äî Conversational</option>
              <option value="5">Level 5 ‚Äî Fluent</option>
              <option value="6">Level 6 ‚Äî Native</option>
            </select>
          </div>

          <div><label># of Conversations</label><input id="c-numConvos" type="number" value="1" min="1"/></div>
          <div><label># of Speakers</label><input id="c-numSpeakers" type="number" value="2" min="1"/></div>

          <div class="grid-full" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;">
            <div><label>Turns</label><input id="c-turns" type="number" value="10" min="1"/></div>
            <div>
              <label for="c-length">Output length</label>
              <select id="c-length">
                <option value="verySmall">Very Small (3‚Äì5 / ‚â•5 words)</option>
                <option value="small">Small (5‚Äì7 / ‚â•7 words)</option>
                <option value="medium" selected>Medium (8‚Äì15 / ‚â•10 words)</option>
                <option value="large">Large (16‚Äì25 / ‚â•12 words)</option>
                <option value="veryLarge">Very Large (26‚Äì35 / ‚â•15 words)</option>
                <option value="paragraph">Paragraph (50‚Äì70 / ‚â•15 words)</option>
              </select>
            </div>
          </div>

          <div><label>Tone</label>
            <select id="c-tone"><option>Neutral, casual</option><option>Informal, friendly</option><option>Instructor, student</option><option>Customer, staff</option><option>Professional, formal</option><option>Street slang</option></select>
          </div>
          <div><label>Country / Region</label><select id="c-country"></select></div>

          <div class="grid-full">
            <label>Fill-in-the-Blank Options</label>
            <div id="c-fib-group" style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
              <label><input type="checkbox" id="c-fib-none" checked> none</label>
              <label><input type="checkbox" id="c-fib-mixed"> mixed</label>
              <label><input type="checkbox" class="fib-opt" value="nouns"> nouns</label>
              <label><input type="checkbox" class="fib-opt" value="verbs"> verbs</label>
              <label><input type="checkbox" class="fib-opt" value="adjectives/adverbs"> adjectives/adverbs</label>
              <label><input type="checkbox" class="fib-opt" value="pronouns"> pronouns (object pronouns)</label>
              <label><input type="checkbox" class="fib-opt" value="glue words"> glue words</label>
            </div>
            <div class="hint">
              ‚Äúmixed‚Äù checks all options; ‚Äúnone‚Äù clears them. Glue words: possessive pronouns, demonstratives, conjunctions, adverbs, quantifiers, prepositions, comparisons.
            </div>
          </div>

          <div class="grid-full"><label for="c-vocab">Vocabulary (optional)</label><textarea id="c-vocab" rows="6" placeholder="Put your own vocabulary here..."></textarea></div>
          <div class="grid-full"><label>Optional Teacher Notes</label><textarea id="c-notes" rows="4"></textarea></div>
        </div>

        <div class="actions"><button id="c-gen" class="primary">Generate</button><button id="c-excel">Excel</button><button id="c-copy">Copy</button><button id="c-prompt">Prompt</button><div id="c-status" class="status"></div></div>
      </div>
      <div id="c-output" class="output-container"><p>Your conversation appears here...</p></div>`;
    $('gen-convo').innerHTML=convoUI;

    const countrySelect=$('c-country');
    const countries=["-no specific-","Argentina","Bolivia","Chile","Colombia","Costa Rica","Cuba","Dominican Republic","Ecuador","El Salvador","Equatorial Guinea","Guatemala","Honduras","Mexico","Nicaragua","Panama","Paraguay","Peru","Puerto Rico","Spain","Uruguay","Venezuela"];
    countrySelect.innerHTML=countries.map(c=>`<option>${c}</option>`).join('');

    const genBtn=$('c-gen'),excelBtn=$('c-excel'),copyBtn=$('c-copy'),promptBtn=$('c-prompt'),statusEl=$('c-status'),outputEl=$('c-output');

    const LENGTH_PRESETS = {
      verySmall: { minSent:3, maxSent:5,  minWords:5 },
      small:     { minSent:5, maxSent:7,  minWords:7 },
      medium:    { minSent:8, maxSent:15, minWords:10 },
      large:     { minSent:16,maxSent:25, minWords:12 },
      veryLarge: { minSent:26,maxSent:35, minWords:15 },
      paragraph: { minSent:50,maxSent:70, minWords:15 }
    };
    const getLengthPreset = ()=> LENGTH_PRESETS[$('c-length').value || 'medium'] || LENGTH_PRESETS.medium;

    const noneBox = $('c-fib-none');
    const mixedBox = $('c-fib-mixed');
    const fibBoxes = Array.from(document.querySelectorAll('#c-fib-group .fib-opt'));
    function syncFibFromNone(){ if(noneBox.checked){ mixedBox.checked=false; fibBoxes.forEach(b=>b.checked=false); } }
    function syncFibFromMixed(){ if(mixedBox.checked){ noneBox.checked=false; fibBoxes.forEach(b=>b.checked=true); } }
    function syncFibFromOption(){
      if (fibBoxes.some(b=>b.checked)) { noneBox.checked=false; mixedBox.checked=fibBoxes.every(b=>b.checked); }
      else { noneBox.checked=true; mixedBox.checked=false; }
    }
    noneBox.addEventListener('change', syncFibFromNone);
    mixedBox.addEventListener('change', syncFibFromMixed);
    fibBoxes.forEach(b=>b.addEventListener('change', syncFibFromOption));

    function getSelectedFIB(){
      const tags = fibBoxes.filter(b=>b.checked).map(b=>b.value);
      const active = tags.length>0;
      const label = active ? tags.join(', ') : 'none';
      return { active, tags, label };
    }

    function buildConvoInstruction(){
      const topic=$('c-topic').value.trim();
      const turns = Math.max(1, Number($('c-turns').value)||10);
      const fib = getSelectedFIB();
      const L = getLengthPreset();
      const fibCount = Math.max(20, Math.min(80, turns * L.minSent)); // denser

      const ui = {
        topic,
        level: $('c-level').value,
        sentences_per_turn: { min: L.minSent, max: L.maxSent, minWords: L.minWords },
        vocab: $('c-vocab').value || "(auto-generate level-appropriate list if empty)",
        numConvos: Math.max(1, Number($('c-numConvos').value)||1),
        numSpeakers: Math.max(1, Number($('c-numSpeakers').value)||1),
        turns,
        tone: $('c-tone').value,
        region: $('c-country').value,
        fibOptions: fib.active ? fib.tags : [],
        teacherNotes: $('c-notes').value||"",
        fibCount
      };

      const levelLines = getLevelRulesLines(ui.level);
      const baseRules = [
        `Create EXACTLY ${ui.numConvos} conversation section(s) titled "Conversation 1", "Conversation 2", ...`,
        `Use exactly ${ui.numSpeakers} distinct speaker name(s); every sentence in BOTH columns begins with [Name].`,
        `Each conversation has EXACTLY ${ui.turns} turns (rows).`,
        `Each turn must contain between ${ui.sentences_per_turn.min} and ${ui.sentences_per_turn.max} sentences in BOTH columns, and each sentence must have at least ${ui.sentences_per_turn.minWords} words.`,
        `Conversations MUST NOT contain underscores or blanks ("________") anywhere. Blanks are ONLY allowed in the FIB section.`
      ];

      const fibRules = (!fib.active)
        ? [
          `No Fill-in-the-Blank section.`,
          `After the conversations include "Common Phrases" only.`
        ]
        : [
          `Include a Fill-in-the-Blank section with about ${fibCount} items.`,
          `FIB rules: one sentence per row; English highlights exactly one target with <span class="en">‚Ä¶</span>; Spanish cell uses "(English target) ________" with parentheses immediately BEFORE the blank.`,
          `Vocabulary Used ‚Äî include a de-duplicated list of words/phrases from BOTH the conversations and ALL Answer Key entries; output as a two-column table (English | Espa√±ol); alphabetize by English.`,
          `Answer Key ‚Äî single-column list of answer words only (no numbering column).`
        ];

      return [
        `You are an expert assistant for FCS.`,
        `IMPORTANT: Do NOT return HTML. Produce TWO PARTS (Word + CSV).`,
        `Topic: "${ui.topic}". Level: ${ui.level}. Tone: "${ui.tone}". Region: "${ui.region}".`,
        ui.vocab && ui.vocab !== "(auto-generate level-appropriate list if empty)"
          ? `Teacher vocabulary (preferred when natural): ${ui.vocab.replace(/[\r\n]+/g,'; ')}`
          : `Vocabulary: auto-generate.`,
        `LEVEL RULES:\n- ${levelLines.join('\n- ')}`,
        '',
        'Rules (strict):', ...baseRules, ...fibRules,
        '',
        `GLOBAL: Self-check all numeric constraints before responding.`
      ].join('\n');
    }

    function buildConvoPrompt(){
      const topic= $('c-topic').value.trim();
      const L = getLengthPreset();
      const fib = getSelectedFIB();
      const turns = Math.max(1, Number($('c-turns').value)||10);
      const fibCount = Math.max(20, Math.min(80, turns * L.minSent));

      const ui = {
        topic,
        level: $('c-level').value,
        sentences_per_turn: { min: L.minSent, max: L.maxSent, minWords: L.minWords },
        vocab: $('c-vocab').value || "(auto-generate level-appropriate list if empty)",
        numConvos: Math.max(1, Number($('c-numConvos').value)||1),
        numSpeakers: Math.max(1, Number($('c-numSpeakers').value)||1),
        turns,
        tone: $('c-tone').value,
        region: $('c-country').value,
        fibOptions: fib.active ? fib.tags : [],
        teacherNotes: $('c-notes').value||"",
        fibCount
      };
      const levelLines = getLevelRulesLines(ui.level);
      const isMono = (ui.numConvos===1 && ui.numSpeakers===1);
      const rules = [
        `Create EXACTLY UI.numConvos conversation sections: "Conversation 1"...`,
        `Each conversation has EXACTLY UI.turns turns (rows).`,
        `Every sentence in BOTH columns begins with [Name].`,
        `ABSOLUTE LENGTH COMPLIANCE: Each turn has between UI.sentences_per_turn.min and UI.sentences_per_turn.max sentences in BOTH columns; each sentence has ‚â• UI.sentences_per_turn.minWords words. Prefer the UPPER bound${isMono?' for a very long monologue':''}.`,
        `Conversations MUST NOT contain any "________".`,
        `Tone: "${ui.tone}". Region: "${ui.region}". Level: ${ui.level}.`,
        `LEVEL RULES:\n- ${levelLines.join('\n- ')}`,
        (fib.active ? `Include FIB with about UI.fibCount items. EN has <span class="en">target</span>; ES uses (English target) ________.` : 'Include "Common Phrases" only (no index).'),
        (fib.active ? `Vocabulary Used includes ALL Answer Key entries + additional unique words from conversations. Alphabetize.` : ''),
        (fib.active ? `Answer Key is single-column list of words.` : ''),
        'No empty <tbody>. SELF-CHECK constraints before returning.'
      ].filter(Boolean);

      const safeTopic = safeForScriptTemplate(ui.topic);
      const uiJson = safeForScriptTemplate(JSON.stringify(ui));

      const conversationsHTML = Array.from({length: ui.numConvos}).map((_,i)=>`
  <div class="section">
    <h2>Conversation ${i+1}</h2>
    <table class="tbl">
      <thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>`).join('');

      const fibLabel = fib.active ? fib.tags.join(', ') : '';

      return `<!DOCTYPE html>
<!-- FCS CONVERSATION OUTPUT -->
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conversation ‚Äî ${safeTopic}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a}
  *{box-sizing:border-box}
  body{font-family:Calibri,Arial,sans-serif;font-size:11pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin:14px 0;overflow-x:auto}
  .legend{font-size:9pt;color:var(--muted);text-align:center;margin-top:6px}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:8px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700}
  .es{color:var(--es);font-weight:700}
</style>
</head>
<body>
<div class="fcs-doc">
  <h1>Conversation: ${safeTopic} ‚Äî Level ${ui.level}</h1>
  <div class="legend"><span class="en">EN vocab = blue</span> | <span class="es">ES vocab = red</span>. Speaker names must appear in [brackets]. No blanks in conversations.</div>

  <!-- CONTRACT:
    UI = ${uiJson}
    ${rules.map((r)=>`- ${r}`).join('\n    ')}
  -->

  ${conversationsHTML}

  ${fib.active ? `
  <div class="section">
    <h2>Practice ‚Äî Fill-in-the-Blank (${fibLabel})</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="section">
    <h2>Vocabulary Used</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="section">
    <h2>Answer Key</h2>
    <table class="tbl"><thead><tr><th>Answer</th></tr></thead><tbody></tbody></table>
  </div>` : `
  <div class="section">
    <h2>Common Phrases</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
  </div>`}

  ${ui.vocab && ui.vocab!=="(auto-generate level-appropriate list if empty)" ?
  `<div class="legend" style="white-space:pre-wrap;border:1px dashed var(--border);padding:8px;border-radius:8px;margin-top:8px;">
    Teacher Vocabulary (STRICT use):\n${ui.vocab.replace(/</g,"&lt;").replace(/>/g,"&gt;")}
  </div>` : ''}

  ${ui.teacherNotes ? `<div class="legend" style="white-space:pre-wrap;margin-top:8px;">Teacher notes:\n${ui.teacherNotes.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>` : ''}

</div>
</body>
</html>`;
    }

    function convoValidator(html){
      try{
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const L = getLengthPreset();
        const expectedTurns = Math.max(1, Number($('c-turns').value)||10);
        const fibActive = !$('#c-fib-none').checked;

        const convSections = Array.from(doc.querySelectorAll('h2')).filter(h=>/^Conversation\s+\d+/i.test(h.textContent));
        if (!convSections.length) return 'Missing conversation sections.';
        for (const h of convSections){
          const tbody = h.parentElement.querySelector('table tbody');
          if(!tbody) return `${h.textContent}: table body missing.`;
          const rows = Array.from(tbody.querySelectorAll('tr'));
          if (rows.length !== expectedTurns) return `${h.textContent}: must have exactly ${expectedTurns} turns (rows). Found ${rows.length}.`;

          for (let i=0;i<rows.length;i++){
            const tds = rows[i].querySelectorAll('td');
            if (tds.length<2) return `${h.textContent}, row ${i+1}: needs two cells (English | Espa√±ol).`;

            const checkCell = (txt,label)=>{
              const clean = txt.replace(/^\s*üîä\s*(EN|ES)\s*/,'').trim();
              if (clean.includes('________')) return `${h.textContent}, row ${i+1} (${label}): conversations must not contain blanks "________".`;
              if (!/^\s*\[.+?\]/.test(clean)) return `${h.textContent}, row ${i+1} (${label}): must start with [Speaker Name].`;
              const sents = splitIntoSentences(clean);
              if (sents.length < L.minSent || sents.length > L.maxSent){
                return `${h.textContent}, row ${i+1} (${label}): must have ${L.minSent}‚Äì${L.maxSent} sentences; found ${sents.length}.`;
              }
              for (let k=0;k<sents.length;k++){
                const words = sents[k].replace(/[‚Äú‚Äù"()]/g,'').trim().split(/\s+/).filter(Boolean);
                if (words.length < L.minWords) return `${h.textContent}, row ${i+1} (${label}), sentence ${k+1}: has ${words.length} words; needs ‚â•${L.minWords}.`;
              }
              return "";
            };
            const enErr = checkCell(tds[0].innerText,'English'); if (enErr) return enErr;
            const esErr = checkCell(tds[1].innerText,'Espa√±ol'); if (esErr) return esErr;
          }
        }

        if (fibActive){
          const fibH = Array.from(doc.querySelectorAll('h2')).find(h=>/Practice ‚Äî Fill-in-the-Blank/i.test(h.textContent));
          if(!fibH) return 'Missing "Practice ‚Äî Fill-in-the-Blank" section.';
          const fibBody = fibH.parentElement.querySelector('table tbody');
          if(!fibBody) return 'FIB table body missing.';
          const rows = Array.from(fibBody.querySelectorAll('tr'));
          if (!rows.length) return 'FIB must contain multiple items.';
          for (let i=0;i<rows.length;i++){
            const tds = rows[i].querySelectorAll('td');
            if (tds.length<2) return `FIB row ${i+1}: needs two cells (English | Espa√±ol).`;
            const en = tds[0].innerHTML;
            const es = tds[1].innerHTML;
            const enSentences = splitIntoSentences(tds[0].innerText);
            const esSentences = splitIntoSentences(tds[1].innerText);
            if (enSentences.length !== 1) return `FIB row ${i+1} EN: must be exactly one sentence.`;
            if (esSentences.length !== 1) return `FIB row ${i+1} ES: must be exactly one sentence.`;
            if (!/<span class="en">[^<]+<\/span>/.test(en)) return `FIB row ${i+1} EN: highlight exactly one target word with <span class="en">‚Ä¶</span>.`;
            if (!/\([\w\s,'-]+\)\s*________/.test(es)) return `FIB row ${i+1} ES: must include "(English word) ________" right before the blank.`;
          }
          const usedH = Array.from(doc.querySelectorAll('h2')).find(h=>/Vocabulary Used/i.test(h.textContent));
          if(!usedH) return 'Missing "Vocabulary Used" section.';
          const usedBody = usedH.parentElement.querySelector('table tbody');
          if(!usedBody) return '"Vocabulary Used" table body missing.';
          const usedEN = new Set(Array.from(usedBody.querySelectorAll('tr')).map(tr=>{
            const td = tr.querySelectorAll('td')[0]; return td ? td.innerText.trim().toLowerCase() : '';
          }).filter(Boolean));

          const ansH  = Array.from(doc.querySelectorAll('h2')).find(h=>/Answer Key/i.test(h.textContent));
          if(!ansH)  return 'Missing "Answer Key" section.';
          const ansBody = ansH.parentElement.querySelector('table tbody');
          if(!ansBody) return '"Answer Key" table body missing.';
          const answers = Array.from(ansBody.querySelectorAll('tr')).map(tr=>{
            const td = tr.querySelector('td'); return td ? td.innerText.trim().toLowerCase() : '';
          }).filter(Boolean);
          // ensure every Answer Key word is present in Vocabulary Used (English column)
          for (const a of answers){
            if (!usedEN.has(a)) return `Vocabulary Used must include all Answer Key entries. Missing: "${a}".`;
          }
        }
        return "";
      }catch(e){ return ""; }
    }

    genBtn.addEventListener('click', async ()=>{
      const topic=$('c-topic').value.trim(); if(!topic){statusEl.textContent="Enter a topic.";return;}
      await generateAndRender(buildConvoPrompt(), genBtn, statusEl, outputEl, convoValidator, 4);
      await Speech.ensure();
      injectGlobalTTSControlsForConvo(outputEl);
    });

    promptBtn.addEventListener('click', ()=>{
      const topic=$('c-topic').value.trim(); if(!topic){statusEl.textContent="Enter a topic.";return;}
      copyText(buildConvoInstruction(), statusEl);
    });
    copyBtn.addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    excelBtn.addEventListener('click', ()=>downloadAsExcel(outputEl,statusEl,$('c-topic').value||'Conversation'));
  })();

  /* =========================
     Test (unchanged)
     ========================= */
  (function setupTest(){
    const testUI =
      `<div class="fcs-card">
        <h2>Test Creator</h2>
        <div><label for="t-vocab">Vocabulary List</label><textarea id="t-vocab" rows="6" placeholder="Paste the EXACT vocabulary for the test..."></textarea></div>
        <div><label for="t-level">Level (Grammar)</label>
          <select id="t-level">
            <option value="1" selected>Level 1 ‚Äî Survival</option>
            <option value="2">Level 2 ‚Äî Beginner</option>
            <option value="3">Level 3 ‚Äî Intermediate</option>
            <option value="4">Level 4 ‚Äî Conversational</option>
            <option value="5">Level 5 ‚Äî Fluent</option>
          </select></div>
        <div><label><input type="checkbox" id="t-anskeys" checked> Include Teacher Answer Keys?</label></div>
        <div class="actions"><button id="t-gen" class="primary">Generate</button><button id="t-excel">Excel</button><button id="t-copy">Copy</button><div id="t-status" class="status"></div></div>
      </div>
      <div id="t-output" class="output-container"><p>Your test will appear here...</p></div>`;
    $('gen-test').innerHTML=testUI;

    const genBtn=$('t-gen'),excelBtn=$('t-excel'),copyBtn=$('t-copy'),statusEl=$('t-status'),outputEl=$('t-output');

    genBtn.addEventListener('click', async ()=>{
      const v=$('t-vocab').value.trim(); if(!v){statusEl.textContent="Please paste a vocab list.";return;}
      const prompt = `<!DOCTYPE html>
<!-- FCS TEST OUTPUT -->
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Test ‚Äî Level ${$('t-level').value}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a}
  *{box-sizing:border-box} body{font-family:Calibri,Arial,sans-serif;font-size:10pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:14px;overflow-x:auto}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:8px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700} .es{color:var(--es);font-weight:700}
  .note{font-size:9pt;color:var(--muted)}
</style></head>
<body><div class="fcs-doc">
  <h1>FCS Conversation Test ‚Äî Level ${$('t-level').value}</h1>
  <div class="note"><span class="en">English terms = blue</span>; <span class="es">Spanish terms = red</span> whenever vocabulary appears inline.</div>

  <div class="section">
    <h2>Part 1 ‚Äî Spanish ‚Üí English</h2>
    <table class="tbl"><thead><tr><th>#</th><th lang="es">Espa√±ol</th>${$('t-anskeys').checked ? '<th>Answer (EN)</th>' : ''}</tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Part 2 ‚Äî English ‚Üí Spanish</h2>
    <table class="tbl"><thead><tr><th>#</th><th>English</th>${$('t-anskeys').checked ? '<th lang="es">Answer (ES)</th>' : ''}</tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Part 3 ‚Äî Live Conversation Prompts</h2>
    <table class="tbl"><thead><tr><th>#</th><th lang="es">Prompt (Espa√±ol)</th></tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  ${$('t-anskeys').checked ? `<div class="section"><h2>Answer Key</h2><!-- answers only --></div>` : ''}

  <div class="note">Vocabulary pasted by teacher:</div>
  <div class="note" style="white-space:pre-wrap;border:1px dashed var(--border);padding:8px;border-radius:8px;">${v.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
</div></body></html>`;
      try{
        statusEl.textContent="Generating...";
        const html = await callAPI(prompt);
        renderGenerated(html, outputEl);
        statusEl.textContent="Done.";
      }catch(e){ console.error(e); statusEl.textContent="Generation failed."; }
    });

    $('t-copy').addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    $('t-excel').addEventListener('click',()=>downloadAsExcel(outputEl,statusEl,'Test'));
  })();

})();
</script>
</body>
</html>
