<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FCS AI Generator Suite</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  :root { --bg:#ffffff; --fg:#111; --muted:#666; --border:#d0d0d0; --accent:#0057d9; --primary-blue:#0b5cff; }
  body { background: var(--light-gray-bg, #f8f9fa); color: var(--fg); font-family: Calibri, Arial, sans-serif; font-size: 15px; margin:0; }
  .fcs-wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
  h1 { font-size: 28px; font-weight:700; text-align:center; margin-bottom: 28px;}
  h2 { font-size: 20px; font-weight:700; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  .fcs-card { border:1px solid var(--border); border-radius: 12px; padding: 24px; background:#fff; margin-bottom: 20px; }
  label { font-weight: 600; font-size: 14px; display: block; margin-bottom: 6px; }
  input[type="text"], select, input[type="number"], textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size:15px; box-sizing:border-box; }
  input:disabled { background-color: #f8f9fa; }
  .hint, .small { font-size: 12px; color: var(--muted); margin-top: 4px; }
  button { padding: 10px 16px; border-radius: 8px; border:1px solid var(--border); background:#f6f8fb; cursor: pointer; font-weight: 600; font-size:15px; transition: all 0.2s; }
  button.primary { background: var(--primary-blue); color: #fff; border-color: var(--primary-blue); }
  button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  button:disabled { cursor: not-allowed; opacity: 0.6; }
  .fcs-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  .fcs-tab-btn { flex-grow: 1; text-align: center; } .fcs-generator { display: none; } .fcs-generator.active { display: block; }
  .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; align-items: end; }
  .six { grid-column: span 6; } .twelve { grid-column: span 12; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; } .grid-full { grid-column: 1 / -1; }
  .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top:20px; }
  .status { margin-top:10px; min-height:1.5em; text-align:center; color:var(--muted); font-size:13px; }
  .output-container { border:1px solid var(--border); border-radius:12px; padding:24px; background:#fdfdfd; min-height: 200px; margin-top:20px; }
  .output-container h1, .output-container h2 { text-align: center; color: #000; }
  .output-container h1 { font-size: 20px; } .output-container h2 { font-size: 18px; border: none; margin-top:24px; background: #f0f0f0; padding:8px; border-radius: 5px; }
  .output-container table { width:100%; border-collapse: collapse; margin-top: 12px; font-size:14px;}
  .output-container th, .output-container td { border:1px solid var(--border); padding:8px; }
  .output-container th { background: #f6f8fb; }
  .output-container .en { color:#0057d9; font-weight:bold; } .output-container .es { color:#c00000; font-weight:bold; }
  .output-container .ans-en { color:#0057d9; font-style:italic; } .output-container .ans-es { color:#c00000; font-style:italic; }
  .output-container .subcategory td { background: #e0e0e0; font-weight: bold; }
  .output-container .spacer td { height:12px; background:#fff; border:none; }
  @media (max-width: 860px){ .six, .twelve { grid-column: span 12; } .grid-2{grid-template-columns:1fr;} }
</style>
</head>
<body>
<div class="fcs-wrap">
    <h1>FCS AI GENERATOR SUITE</h1>
    <div class="fcs-tabs">
        <button id="tab-vocab" class="fcs-tab-btn primary">Vocabulary Generator</button>
        <button id="tab-convo" class="fcs-tab-btn">Conversation Generator</button>
        <button id="tab-test" class="fcs-tab-btn">Test Generator</button>
    </div>

    <!-- ===== VOCABULARY GENERATOR ===== -->
    <div id="gen-vocab" class="fcs-generator active">
        <div class="fcs-card">
            <h2>Vocabulary Generator</h2>
            <div class="grid">
                <div class="six"><label for="v-topic">Topic</label><input id="v-topic" type="text" placeholder="e.g., camping, dance" value="At the Airport"></div>
                <div class="six"><label for="v-level">Level</label><select id="v-level"><option value="1">Level 1 — Survival</option><option value="2">Level 2 — Beginner</option><option value="3" selected>Level 3 — Intermediate</option><option value="4">Level 4 — Conversational</option><option value="5">Level 5 — Fluent</option></select></div>
                <div class="six"><label for="v-tmode">Total Words Mode</label><select id="v-tmode"><option value="default" selected>Preset by Level</option><option value="custom">Custom</option></select></div>
                <div class="six"><div class="grid"><div class="six"><label for="v-tmin">Min</label><input id="v-tmin" type="number" value="90" disabled></div><div class="six"><label for="v-tmax">Max</label><input id="v-tmax" type="number" value="120" disabled></div></div></div>
            </div>
            <div class="actions"><button id="v-gen" class="primary">Generate Vocabulary</button><button id="v-copy">Copy HTML</button><div id="v-status" class="status"></div></div>
        </div>
        <div id="v-output" class="output-container"><p>Your generated vocabulary list will appear here...</p></div>
    </div>

    <!-- ===== CONVERSATION GENERATOR ===== -->
    <div id="gen-convo" class="fcs-generator">
        <div class="fcs-card">
            <h2>Conversation Generator</h2>
            <div class="grid-2">
                <div class="grid-full"><label>Topic</label><input id="c-topic" type="text" value="Talking about a recent trip"></div>
                <div><label>Level</label><select id="c-level"><option value="1">Level 1</option><option value="2" selected>Level 2</option><option value="3">Level 3</option><option value="4">Level 4</option><option value="5">Level 5</option></select></div>
                <div><label>Tone</label><select id="c-tone"><option>Neutral, casual</option><option>Informal, friendly</option></select></div>
                <div class="grid-full"><label>Vocabulary (Optional: paste list)</label><textarea id="c-vocab" rows="4"></textarea></div>
                <div><label># Convos</label><input id="c-numConvos" type="number" value="1"></div>
                <div><label># Speakers</label><input id="c-numSpeakers" type="number" value="2"></div>
                <div><label>Add Fill-In-The-Blank?</label><select id="c-addFib"><option value="no">No</option><option value="yes" selected>Yes</option></select></div>
                <div><label>FIB Focus</label><select id="c-fibFocus"><option>Mixed</option><option>Verbs only</option></select></div>
            </div>
            <div class="actions"><button id="c-gen" class="primary">Generate Conversation</button><button id="c-copy">Copy HTML</button><div id="c-status" class="status"></div></div>
        </div>
        <div id="c-output" class="output-container"><p>Your generated conversation will appear here...</p></div>
    </div>
    
    <!-- ===== TEST GENERATOR ===== -->
    <div id="gen-test" class="fcs-generator">
        <div class="fcs-card">
            <h2>Test Generator</h2>
            <div class="grid-2">
                <div class="grid-full"><label for="t-vocab">Vocabulary List</label><textarea id="t-vocab" rows="6" placeholder="Paste the EXACT vocabulary for the test."></textarea></div>
                <div class="grid-full"><label for="t-level">Level (Grammar)</label><select id="t-level"><option value="1">Level 1</option><option value="2" selected>Level 2</option><option value="3">Level 3</option><option value="4">Level 4</option><option value="5">Level 5</option></select></div>
                <div class="grid-full"><label><input type="checkbox" id="t-anskeys" checked> Include Teacher Answer Keys?</label></div>
            </div>
            <div class="actions"><button id="t-gen" class="primary">Generate Test</button><button id="t-copy">Copy HTML</button><div id="t-status" class="status"></div></div>
        </div>
        <div id="t-output" class="output-container"><p>Your generated test will appear here...</p></div>
    </div>
</div>

<script>
"use strict";
(function(){
    const $ = (id) => document.getElementById(id);
    const API_URL = "/api/index"; 

    // --- Tab Switching Logic ---
    const tabs = document.querySelectorAll('.fcs-tab-btn');
    const generators = document.querySelectorAll('.fcs-generator');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetId = tab.id.replace('tab-', 'gen-');
            tabs.forEach(t => t.classList.remove('primary'));
            tab.classList.add('primary');
            generators.forEach(gen => gen.classList.remove('active'));
            $(targetId).classList.add('active');
            // This is needed for Safari/Firefox
            generators.forEach(gen => { gen.style.display = gen.id === targetId ? 'block' : 'none'; });
        });
    });

    // --- CORE AI CALL ---
    async function generateResult(prompt, buttonEl, statusEl, outputEl) {
        buttonEl.disabled = true;
        statusEl.textContent = "Generating... Contacting AI...";
        outputEl.innerHTML = "<h4>Please wait. The AI is crafting your content... This can take up to a minute.</h4>";

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ prompt: prompt })
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.details || result.error || "An unknown error occurred.");
            }
            
            // AI returns { "content": "raw html or markdown..." }
            let htmlContent = result.content;
            
            // Check if the content is markdown (used by vocab tool) and parse it
            // Simple check: does it contain markdown table syntax?
            if (htmlContent.includes('| ---')) {
                 outputEl.innerHTML = marked.parse(htmlContent)
                    .replace(/\| \*\*Nouns - (.*?)\*\* \| \*\*Sustantivos - (.*?)\*\* \|/g, '<tr><td colspan="2" class="subcategory">$1 / $2</td></tr>')
                    .replace(/\| \*\*(.*?)\*\* \| \*\*(.*?)\*\* \|/g, '<tr><td colspan="2" class="subcategory">$1 / $2</td></tr>');
            } else {
                outputEl.innerHTML = htmlContent; // Assume it's already HTML
            }

            statusEl.textContent = "Generation successful!";
        } catch (error) {
            console.error("Generation Error:", error);
            outputEl.innerHTML = `<p style="color:red;"><strong>Error:</strong> Failed to generate content. The AI may have returned an invalid response. Details: ${error.message}</p>`;
            statusEl.textContent = "An error occurred.";
        } finally {
            buttonEl.disabled = false;
        }
    }

    // --- COPY HELPER ---
    function copyToClipboard(outputEl, statusEl) {
        if (!outputEl.innerHTML.includes('<p>')) { statusEl.textContent = "Nothing to copy."; return; }
        navigator.clipboard.writeText(outputEl.innerText).then(
            () => { statusEl.textContent = "Copied to clipboard!"; },
            () => { statusEl.textContent = "Copy failed."; }
        );
    }
    
    // --- VOCABULARY GENERATOR ---
    (function setupVocab() {
        const genBtn = $('v-gen'), copyBtn = $('v-copy'), statusEl = $('v-status'), outputEl = $('v-output');
        const topicEl=$("v-topic"), levelEl=$("v-level"), tmodeEl=$("v-tmode"), tminEl=$("v-tmin"), tmaxEl=$("v-tmax");
        const presetRanges={"1":{min:35,max:55},"2":{min:60,max:85},"3":{min:90,max:120},"4":{min:120,max:180},"5":{min:160,max:240}};
        
        function updateUI(){
            const isCustom=tmodeEl.value==='custom'; const range=presetRanges[levelEl.value];
            tminEl.disabled=!isCustom; tmaxEl.disabled=!isCustom;
            if(!isCustom){ tminEl.value=range.min; tmaxEl.value=range.max; }
        }
        tmodeEl.addEventListener('change', updateUI);
        levelEl.addEventListener('change', updateUI);
        
        genBtn.addEventListener('click', () => {
            if(!topicEl.value.trim()){ statusEl.textContent = "Please enter a topic."; return; }
            const prompt = `OUTPUT CONTRACT: Produce a COMPLETE, EXCEL-READY VOCABULARY LESSON as a single HTML file with embedded styles. Follow all 7 rules from the FCS Vocabulary Creator documentation precisely. Key Rules: English in blue (.en), Spanish in red (.es). Nouns/Verbs/Descriptives must be full sentences. All content alphabetized by English. Adhere strictly to word counts and level grammar.\n\n`
             + `User Input:\nTopic: ${topicEl.value}\nLevel: ${levelEl.value}\nTotal Words Mode: ${tmodeEl.value}\nMin Words: ${tminEl.value}\nMax Words: ${tmaxEl.value}`;
            generateResult(prompt, genBtn, statusEl, outputEl);
        });
        copyBtn.addEventListener('click', () => copyToClipboard(outputEl, statusEl));
        updateUI();
    })();
    
    // --- CONVERSATION GENERATOR ---
    (function setupConvo() {
        const genBtn = $('c-gen'), copyBtn = $('c-copy'), statusEl = $('c-status'), outputEl = $('c-output');
        genBtn.addEventListener('click', () => {
            const topicEl = $('c-topic');
            if(!topicEl.value.trim()){ statusEl.textContent = "Please enter a topic."; return; }
            const prompt = `OUTPUT CONTRACT: You are creating content for the Fast Conversational Spanish program. Produce one or more conversations and optionally two Fill-in-the-Blank exercises, delivered as a single HTML file with embedded styles. Follow all rules from the FCS Conversation Creator documentation precisely. Key Rules: Return only HTML. Use specified grammar for the level. Format conversations and practices in two columns (English/Spanish). Bold vocabulary and color it blue (.en) and red (.es).\n\n`
             + `User Input:\nTopic: ${topicEl.value}\nLevel: ${$('c-level').value}\nVocabulary List: ${$('c-vocab').value||"auto"}\nNum Convos: ${$('c-numConvos').value}\nNum Speakers: ${$('c-numSpeakers').value}\nAdd FIB: ${$('c-addFib').value}\nFIB Focus: ${$('c-fibFocus').value}\nTone: ${$('c-tone').value}`;
            generateResult(prompt, genBtn, statusEl, outputEl);
        });
        copyBtn.addEventListener('click', () => copyToClipboard(outputEl, statusEl));
    })();

    // --- TEST GENERATOR ---
    (function setupTest() {
        const genBtn = $('t-gen'), copyBtn = $('t-copy'), statusEl = $('t-status'), outputEl = $('t-output');
        genBtn.addEventListener('click', () => {
            const vocabEl = $('t-vocab');
            if(!vocabEl.value.trim()){ statusEl.textContent = "Please paste a vocabulary list."; return; }
            const prompt = `OUTPUT CONTRACT: You are creating a 3-part Spanish test. Produce the output as a single HTML file with embedded styles. Follow all rules from the FCS Test Creator documentation precisely. Key Rules: Return only HTML. Use only the provided vocabulary. Use only grammar from the specified level. Structure is Part 1 (ES->EN), Part 2 (EN->ES), Part 3 (Oral Prompts). Include answer keys at the end if requested.\n\n`
             + `User Input:\nLevel: ${$('t-level').value}\nInclude Answer Keys: ${$('t-anskeys').checked}\nVocabulary List:\n${vocabEl.value}`;
            generateResult(prompt, genBtn, statusEl, outputEl);
        });
        copyBtn.addEventListener('click', () => copyToClipboard(outputEl, statusEl));
    })();

    // Init the app
    initializeControls();
})();
</script>

</body>
</html>
