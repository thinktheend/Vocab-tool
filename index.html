<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FCS Content Creator</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  :root { 
    --bg-color: #f8f9fa; --text-color: #212529; --primary-color: #0057d9;
    --border-color: #dee2e6; --card-bg: #ffffff; --muted-text: #6c757d; --red-color: #c00000;
  }
  body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;margin:0;background-color:var(--bg-color);color:var(--text-color);line-height:1.6; }
  .container { max-width:900px; margin:30px auto; padding:0 20px; }
  h1, .subtitle { text-align:center; }
  h1 { font-size:28px; margin-bottom:8px; }
  .subtitle { color:var(--muted-text); margin-bottom:30px; }
  .card { background-color:var(--card-bg);border:1px solid var(--border-color);border-radius:8px;padding:24px;margin-bottom:24px;box-shadow:0 4px 6px rgba(0,0,0,0.05); }
  .grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; align-items:flex-end; }
  .grid.full { grid-column: 1 / -1; }
  .form-group { display:flex; flex-direction:column; }
  label { font-weight:600; margin-bottom:8px; font-size:14px; }
  input, select, textarea { padding:10px; border-radius:6px; border:1px solid var(--border-color); font-size:16px; width:100%; box-sizing:border-box; }
  .actions { display:flex; gap:12px; margin-top:20px; flex-wrap:wrap; }
  button { padding:12px 20px; border:none; border-radius:6px; font-size:16px; font-weight:600; cursor:pointer; transition:background-color 0.2s; }
  button.primary { background-color:var(--primary-color); color:white; }
  button:disabled { background-color:#aeb8c4; cursor:not-allowed; }
  #status { margin-top:15px; color:var(--muted-text); min-height:1.5em; text-align:center; }
  .output-container { background-color:var(--card-bg);border:1px solid var(--border-color);border-radius:8px;padding:10px 24px;min-height:200px; white-space: pre-wrap; }
  .output-container table { width:100%; border-collapse:collapse; margin:1.5em 0; }
  .output-container th, .output-container td { border:1px solid var(--border-color);padding:12px;text-align:left; }
  .output-container th { background-color:var(--bg-color); font-weight:700; }
  .output-container strong { color:var(--primary-color); }
  .tool-selector { display:flex; gap:10px; justify-content:center; margin-bottom:24px; }
  .tool-selector button { background-color:#e9ecef; color:var(--text-color); border:1px solid var(--border-color); }
  .tool-selector button.active { background-color:var(--primary-color); color:white; border-color:var(--primary-color); }
  .hidden { display:none; }
</style>
</head>
<body>
<div class="container">
  <h1>FCS Content Creator</h1>
  <p class="subtitle">Select a tool to generate Spanish learning materials.</p>
  
  <div class="tool-selector">
    <button id="selectVocab" class="active">Vocabulary Generator</button>
    <button id="selectConvo">Conversation Generator</button>
  </div>

  <!-- ======== VOCABULARY GENERATOR ======== -->
  <div id="vocabGenerator">
    <div class="card">
      <div class="grid">
        <div class="form-group"><label for="vocabTopic">Topic</label><input id="vocabTopic" type="text" placeholder="e.g., At the Airport"></div>
        <div class="form-group"><label for="vocabLevel">Level</label><select id="vocabLevel"><option value="1" selected>Level 1 - Survival</option><option value="2">Level 2 - Beginner</option><option value="3">Level 3 - Intermediate</option><option value="4">Level 4 - Conversational</option><option value="5">Level 5 - Fluent</option></select></div>
        <div class="form-group"><label for="vocabTotalsMode">Totals Mode</label><select id="vocabTotalsMode"><option value="default" selected>Preset by Level</option><option value="custom">Custom</option></select></div>
        <div class="form-group" id="vocabCustomTotals" style="display:none;"><div class="grid"><div><label for="vocabMinTotal">Min</label><input id="vocabMinTotal" type="number" value="35"></div><div><label for="vocabMaxTotal">Max</label><input id="vocabMaxTotal" type="number" value="55"></div></div></div>
      </div>
      <div class="actions">
        <button id="vocabGen" class="primary">Generate Vocabulary</button>
        <button id="vocabExcel" disabled>Download Excel</button>
        <button id="vocabCopy" disabled>Copy Text</button>
      </div>
    </div>
  </div>

  <!-- ======== CONVERSATION GENERATOR ======== -->
  <div id="convoGenerator" class="hidden">
      <div class="card">
        <div class="grid"><div class="grid full">
            <div class="form-group"><label for="convoTopic">Topic</label><input id="convoTopic" placeholder="e.g., Planning a surprise party" type="text"/></div>
            <div class="form-group"><label for="convoLevel">Level (Grammar)</label><select id="convoLevel"><option value="1" selected>Level 1 - Survival (Simple Present)</option><option value="2">Level 2 - Beginner (Core Verbs)</option><option value="3">Level 3 - Intermediate (Past Tenses)</option><option value="4">Level 4 - Conversational (Future/Conditional)</option><option value="5">Level 5 - Fluent (Subjunctive/Commands)</option></select></div>
            <div class="grid full"><div class="form-group"><label for="convoVocab">Custom Vocabulary (optional)</label><textarea id="convoVocab" placeholder="If empty, the AI will generate a level-appropriate list." rows="6"></textarea></div></div>
            <div class="form-group"><label for="numConvos"># of Conversations</label><input id="numConvos" type="number" value="1" min="1"/></div>
            <div class="form-group"><label for="numSpeakers"># of Speakers</label><input id="numSpeakers" type="number" value="2" min="1"/></div>
            <div class="form-group"><label for="turns">Turns per Conversation</label><input id="turns" type="number" value="8" min="2"/></div>
            <div class="form-group"><label for="tone">Tone</label><select id="tone"><option selected>Informal, friendly</option><option>Neutral, casual</option><option>Professional, formal</option></select></div>
        </div></div>
        <div class="actions">
            <button id="convoGen" class="primary">Generate Conversation</button>
            <button id="convoExcel" disabled>Download Excel</button>
            <button id="convoCopy" disabled>Copy Text</button>
        </div>
      </div>
  </div>

  <!-- ======== SHARED OUTPUT AREA ======== -->
  <h2 style="margin-top:40px;">Generated Content</h2>
  <div id="output" class="output-container"><p style="color:var(--muted-text);">Your AI-generated content will appear here...</p></div>
  <div id="status">Ready.</div>
</div>

<script>
"use strict";
(function(){
  const $ = (id) => document.getElementById(id);
  
  let vocabMarkdown = ""; let convoMarkdown = ""; 

  function init(){
    setupToolSelector();
    setupVocabGenerator();
    setupConvoGenerator();
  }
  
  function setupToolSelector(){
    const btns=[$('selectVocab'),$('selectConvo')], divs=[$('vocabGenerator'),$('convoGenerator')];
    btns.forEach((btn, index) => {
      btn.addEventListener('click', () => {
        btns.forEach(b => b.classList.remove('active')); btn.classList.add('active');
        divs.forEach(d => d.classList.add('hidden')); divs[index].classList.remove('hidden');
      });
    });
  }

  // *** THIS IS THE ONLY FUNCTION THAT HAS CHANGED ***
  const copyToClipboard = (text, statusEl) => {
    if (!text) return;
    const tempTextArea = document.createElement('textarea');
    tempTextArea.value = text;
    tempTextArea.style.position = 'fixed';
    tempTextArea.style.left = '-9999px';
    document.body.appendChild(tempTextArea);
    tempTextArea.select();
    try {
      document.execCommand('copy');
      statusEl.textContent = "Copied to clipboard!";
    } catch (err) {
      statusEl.textContent = "Copy failed. Please use Ctrl+C.";
    }
    document.body.removeChild(tempTextArea);
  };
  
  function setupVocabGenerator() {
    const outputDiv=$("output"), genBtn=$("vocabGen"), excelBtn=$("vocabExcel"), copyBtn=$("vocabCopy");
    const statusEl=$("status"), topicEl=$("vocabTopic"), levelEl=$("vocabLevel"), totalsModeEl=$("vocabTotalsMode"), customTotalsEl=$("vocabCustomTotals"), minEl=$("vocabMinTotal"), maxEl=$("vocabMaxTotal");
    
    totalsModeEl.addEventListener('change',()=>{customTotalsEl.style.display=(totalsModeEl.value==='custom')?'block':'none';});
    copyBtn.addEventListener('click',()=>copyToClipboard(vocabMarkdown,statusEl));
    excelBtn.addEventListener('click',()=>{if(!vocabMarkdown)return;statusEl.textContent="Creating formatted Excel...";try{generateVocabExcel(vocabMarkdown,topicEl.value,levelEl.value);statusEl.textContent="Excel download started.";}catch(e){statusEl.textContent="Excel creation failed.";console.error(e);}});

    genBtn.addEventListener('click', async () => {
      const payload={toolType:'vocabulary',topic:topicEl.value.trim(),level:levelEl.value,totalsMode:totalsModeEl.value,minTotal:minEl.value,maxTotal:maxEl.value};
      if (!payload.topic) {statusEl.textContent="Please enter a topic.";return;}
      
      try {
        outputDiv.innerHTML='<p style="color:var(--muted-text);">Generating vocabulary...</p>';
        statusEl.textContent="Connecting to AI...";
        genBtn.disabled=true;excelBtn.disabled=true;copyBtn.disabled=true;
        const response=await fetch('/api/index',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const data=await response.json();
        if(!response.ok)throw new Error(data.message||"Server error.");
        
        vocabMarkdown = data.result;
        outputDiv.innerHTML = marked.parse(vocabMarkdown);
        statusEl.textContent="Generation complete!"; excelBtn.disabled=false; copyBtn.disabled=false;
      }catch(e){outputDiv.innerHTML=`<p style="color:red;"><strong>Error:</strong> ${e.message}</p>`;statusEl.textContent="Failed to generate.";}
      finally {genBtn.disabled=false;}
    });
  }

  function setupConvoGenerator() {
      const outputDiv=$("output"), genBtn=$("convoGen"), excelBtn=$("convoExcel"), copyBtn=$("convoCopy"), statusEl=$("status");
      copyBtn.addEventListener('click',()=>copyToClipboard(convoMarkdown,statusEl));
      excelBtn.addEventListener('click',()=>{if(!convoMarkdown)return;statusEl.textContent="Creating Excel...";try{generateConvoExcel(convoMarkdown,$('convoTopic').value,$('convoLevel').value);statusEl.textContent="Excel download started.";}catch(e){statusEl.textContent="Excel creation failed.";console.error(e);}});
      
      genBtn.addEventListener('click', async () => {
        const payload={toolType:'conversation',topic:$('convoTopic').value.trim(),level:$('convoLevel').value,vocab:$('convoVocab').value.trim(),numConvos:$('numConvos').value,numSpeakers:$('numSpeakers').value,turns:$('turns').value,tone:$('tone').value};
        if(!payload.topic){statusEl.textContent="Please enter a topic.";return;}
        
        try {
            outputDiv.innerHTML='<p style="color:var(--muted-text);">Generating conversation...</p>';
            statusEl.textContent="Connecting to AI...";genBtn.disabled=true;excelBtn.disabled=true;copyBtn.disabled=true;
            const response=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
            const data=await response.json();
            if(!response.ok)throw new Error(data.message||"Server error.");
            
            convoMarkdown=data.result;
            outputDiv.innerHTML=marked.parse(convoMarkdown);
            statusEl.textContent="Generation complete!"; excelBtn.disabled=false; copyBtn.disabled=false;
        }catch(e){outputDiv.innerHTML=`<p style="color:red;"><strong>Error:</strong> ${e.message}</p>`;statusEl.textContent="Failed to generate.";}
        finally {genBtn.disabled=false;}
      });
  }

  function generateVocabExcel(markdown,topic,level) {
    const wb=XLSX.utils.book_new(),ws={},data=[];
    const border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
    const headerFont={sz:12,bold:true};
    const enColor={rgb:"0057D9"},esColor={rgb:"C00000"};
    const defaultFont={sz:12,color:{rgb:"000000"}};

    markdown.split('\n').filter(l=>l.startsWith('|')).forEach(line=>{
        if(line.includes('---'))return;
        const cells=line.split('|').map(c=>c.trim()).filter(Boolean);
        if(cells.length<2)return; let rowData=[];
        for(let i=0;i<2;i++){
            const text=cells[i],isHeader=text.includes('**');
            if(isHeader) rowData.push({v:text.replace(/\*\*/g,''),t:'s',s:{font:headerFont,border:border}});
            else{
                const richText=[],color=i===0?enColor:esColor;
                text.split(/\*\*(.*?)\*\*/g).forEach((part,idx)=>{if(!part)return;richText.push({t:part,f:{sz:12,bold:idx%2===1,color:idx%2===1?color:defaultFont.color}});});
                rowData.push({v:richText,t:'r',s:{border:border}});
            }
        } data.push(rowData);
    });
    
    XLSX.utils.sheet_add_aoa(ws,data,{origin:"A1"});
    ws['!cols']=[{wch:70},{wch:70}];
    XLSX.utils.book_append_sheet(wb,ws,"Vocabulary");
    XLSX.writeFile(wb,`${topic}_L${level}_Vocab.xlsx`);
  }
  
  function generateConvoExcel(markdown,topic,level){
    const wb=XLSX.utils.book_new();
    const data=[]; let currentSpeaker="";
    markdown.split('\n').forEach(line=>{
        if(line.startsWith('#')||line.trim()==='') return;
        const match = line.match(/^(.*?):(.*)/);
        if(match){ currentSpeaker = match[1].trim(); data.push({ "Speaker": currentSpeaker, "Line": match[2].trim() });
        } else if (line.startsWith('(EN)')) { data.push({ "Speaker": "Translation", "Line": line.substring(4).trim() }); }
    });
    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = [{wch:20},{wch:100}];
    XLSX.utils.book_append_sheet(wb,ws,"Conversation");
    XLSX.writeFile(wb,`${topic}_L${level}_Convo.xlsx`);
  }

  window.addEventListener('DOMContentLoaded',init);
})();
</script>
</body>
</html>
