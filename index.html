<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>FCS AI Generator Suite</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  :root { --bg:#f7f9fc; --fg:#111; --muted:#667085; --border:#e5e7eb; --panel:#ffffff; --accent:#0b5cff;
          --en:#1a73e8; --es:#d93025; --head:#0f172a; }
  body { background: var(--bg); color: var(--fg); font-family: Calibri, Arial, sans-serif; font-size: 15px; margin:0; }
  .fcs-wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
  h1 { font-size: 28px; font-weight:700; text-align:center; margin-bottom: 28px; color: var(--head);}
  h2 { font-size: 20px; font-weight:700; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; color: var(--head); }
  .fcs-card { border:1px solid var(--border); border-radius: 12px; padding: 24px; background:var(--panel); margin-bottom: 20px; }
  label { font-weight: 600; font-size: 14px; display: block; margin-bottom: 6px; }
  input[type="text"], select, input[type="number"], textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size:15px; box-sizing:border-box; }
  input:disabled { background-color: #f8f9fa; }
  .hint, .small { font-size: 12px; color: var(--muted); margin-top: 4px; }
  button { padding: 10px 16px; border-radius: 8px; border:1px solid var(--border); background:#f6f8fb; cursor: pointer; font-weight: 600; font-size:15px; transition: all 0.2s; }
  button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
  button:disabled { cursor: not-allowed; opacity: 0.6; }
  .fcs-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  .fcs-tab-btn { flex-grow: 1; text-align: center; } .fcs-generator { display: none; } .fcs-generator.active { display: block; }
  .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; align-items: end; }
  .six { grid-column: span 6; } .twelve { grid-column: span 12; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; } .grid-full { grid-column: 1 / -1; }
  .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top:20px; align-items:center; }
  .status { margin-top:10px; min-height:1.5em; text-align:left; color:var(--muted); font-size:13px; }
  .output-container { border:1px solid var(--border); border-radius:12px; padding:24px; background:#fff; min-height: 240px; margin-top:12px; }
  .output-container h1, .output-container h2 { text-align: center; color: #0f172a !important; }
  .output-container table { width:100%; border-collapse: separate; border-spacing: 0; margin-top: 12px; font-size:10pt;}
  .output-container th, .output-container td { border:1px solid #e5e7eb; padding:8px; vertical-align:top; }
  .output-container th { background: #f5f7fb; }
  .output-container tr:nth-child(even) td { background: #fafafa; }
  .output-container .en { color: var(--en); font-weight: bold; } 
  .output-container .es { color: var(--es); font-weight: bold; }

  /* Small inline TTS buttons for each EN/ES cell */
  .tts-line-btn { display:inline-flex; align-items:center; gap:4px; padding:2px 6px; margin-right:6px; border:1px solid #dbe2ef;
    border-radius:999px; background:#eef2ff; cursor:pointer; font-size:12px; line-height:1; }
  .tts-line-btn[data-tts="es"] { background:#fdeaea; border-color:#f5c2c7; }
  .tts-line-btn:hover { filter:brightness(0.98); }
  .conv-ctrls { display:flex; gap:8px; align-items:center; margin:6px 0 10px; }
  .conv-ctrls button { padding:6px 10px; font-size:12px; }

  @media (max-width: 860px){ .six, .twelve { grid-column: span 12; } .grid-2{grid-template-columns:1fr;} }
</style>
</head>
<body>
<div class="fcs-wrap">
    <h1>FCS AI GENERATOR SUITE</h1>

    <!-- ===== Global Tabs ===== -->
    <div class="fcs-tabs">
        <button id="tab-vocab" class="fcs-tab-btn primary">Vocabulary</button>
        <button id="tab-convo" class="fcs-tab-btn">Conversation</button>
        <button id="tab-test" class="fcs-tab-btn">Test</button>
    </div>

    <!-- ====== VOCABULARY: UI ====== -->
    <div id="gen-vocab" class="fcs-generator active"></div>
    <!-- ====== VOCABULARY: OUTPUT (injected) ====== -->
    <div id="v-output" class="output-container"><p>Your list will appear here...</p></div>

    <!-- ====== CONVERSATION: UI ====== -->
    <div id="gen-convo" class="fcs-generator"></div>
    <!-- ====== CONVERSATION: OUTPUT (unchanged) ====== -->
    <div id="c-output" class="output-container" style="display:none"><p>Your conversation appears here...</p></div>

    <!-- ====== TEST: UI ====== -->
    <div id="gen-test" class="fcs-generator"></div>
    <!-- ====== TEST: OUTPUT (unchanged) ====== -->
    <div id="t-output" class="output-container" style="display:none"><p>Your test will appear here...</p></div>
</div>

<script>
"use strict";
(function(){
  const $=id=>document.getElementById(id);
  const API_URL="/api/index";

  // Tabs
  (function initTabs(){
    const t=document.querySelectorAll(".fcs-tab-btn");
    const blocks={
      vocab:["gen-vocab","v-output"],
      convo:["gen-convo","c-output"],
      test:["gen-test","t-output"]
    };
    t.forEach(o=>{
      o.addEventListener("click",()=>{
        const which=o.id.replace("tab-","");
        t.forEach(b=>b.classList.remove("primary"));
        o.classList.add("primary");
        document.querySelectorAll(".fcs-generator, .output-container").forEach(el=>el.style.display="none");
        blocks[which].forEach(id=>$(id).style.display="block");
      })
    });
  })();

  /* ===== Core fetch + (optional) compliance-retry ===== */
  async function callAPI(prompt){ 
    const resp=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})});
    const json=await resp.json();
    if(!resp.ok) throw new Error(json.details||json.error||"Unknown server error.");
    return json.content;
  }

  async function generateResult(prompt,button,statusEl,outputEl,{retryIfBad=null}={}){
    button.disabled=true;
    statusEl.textContent="Generating...";
    outputEl.innerHTML="<h4>Please wait. AI is working...</h4>";
    try{
      let html=await callAPI(prompt);
      if(typeof retryIfBad === "function"){
        const failMsg = retryIfBad(html);
        if(failMsg){
          statusEl.textContent="Retrying to enforce constraints‚Ä¶";
          const retryPrompt = prompt + `\n\n<!-- VIOLATION NOTICE: ${failMsg}. REGENERATE STRICTLY COMPLYING. -->`;
          html = await callAPI(retryPrompt);
        }
      }
      outputEl.innerHTML=html;
      // Ensure phrases/questions are fully colored even if the model forgets
      forcePhraseQuestionColoring(outputEl);
      statusEl.textContent="Done.";
      await Speech.ensureVoices();
      addPerLineTTS(outputEl);
      addConversationPlayers(outputEl);
    }catch(err){
      console.error("Error:",err);
      outputEl.innerHTML=`<p style="color:red;"><strong>Error:</strong> ${err.message}</p>`;
      statusEl.textContent="Error.";
    }finally{
      button.disabled=false;
    }
  }

  /* ===== Copy helper (fixed: with secure + fallback) ===== */
  function copyToClipboard(container,statusEl){
    const text=(container.innerText||"").trim();
    if(!text){ statusEl.textContent="Nothing to copy."; return; }

    function legacyCopy(txt){
      try{
        const ta=document.createElement("textarea");
        ta.value=txt;
        ta.style.position="fixed"; ta.style.opacity="0"; ta.style.left="-9999px";
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        const ok=document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      }catch{ return false; }
    }

    if(navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(text)
        .then(()=>statusEl.textContent="Copied!")
        .catch(()=>{ legacyCopy(text) ? statusEl.textContent="Copied!" : statusEl.textContent="Copy failed."; });
    }else{
      legacyCopy(text) ? statusEl.textContent="Copied!" : statusEl.textContent="Copy failed.";
    }
  }

  /* ===== Excel download (unchanged) ===== */
  function downloadAsExcel(container,statusEl,filename){
    if(!container.querySelector("table")){statusEl.textContent="No data to export.";return}
    try{
      statusEl.textContent="Creating Excel...";
      const wb=XLSX.utils.book_new(), rows=[], title=container.querySelector("h1")?.innerText||filename;
      rows.push([title]); rows.push([]);
      container.querySelectorAll("h2, table").forEach(el=>{
        if(el.tagName==="H2") rows.push([el.innerText]);
        if(el.tagName==="TABLE"){
          el.querySelectorAll("tr").forEach(tr=>{
            const line=Array.from(tr.querySelectorAll("th, td")).map(td=>td.innerText); rows.push(line);
          });
          rows.push([]);
        }
      });
      const ws=XLSX.utils.aoa_to_sheet(rows);
      ws["!cols"]=rows.reduce((acc,row)=>{row.forEach((cell,i)=>{const w=cell?cell.toString().length+2:10; if(!acc[i]||acc[i].wch<w) acc[i]={wch:w}}); return acc;},[]);
      XLSX.utils.book_append_sheet(wb,ws,"Generated Content");
      XLSX.writeFile(wb,`${(filename||'Export').replace(/\s+/g,"_")}.xlsx`);
      statusEl.textContent="Download started.";
    }catch(e){console.error("Excel Error:",e); statusEl.textContent="Failed to create Excel."}
  }

  /* =========================
     Web Speech API helpers
     ========================= */
  const Speech = {
    voices: [],
    ready: false,
    defaultRate: 0.95,
    defaultRateES: 0.90, // clearer, teaching pace
    ensureVoices() {
      return new Promise((resolve) => {
        if (!('speechSynthesis' in window)) { resolve(); return; }
        const setVoices = () => {
          Speech.voices = window.speechSynthesis.getVoices() || [];
          Speech.ready = Speech.voices.length > 0;
          resolve();
        };
        const existing = window.speechSynthesis.getVoices();
        if (existing && existing.length) setVoices();
        else window.speechSynthesis.onvoiceschanged = setVoices;
      });
    },
    pickVoice(langPrefix) {
      if (!Speech.ready) return null;
      const lp = (langPrefix||'en').toLowerCase();
      const candidates = Speech.voices;

      const preferNames = [
        // Common high-quality names across Chrome/Edge
        'Google espa√±ol', 'Google US Espa√±ol', 'Google espa√±ol de Estados Unidos', 'Google espa√±ol de M√©xico',
        'Microsoft Sabina', 'Microsoft Alvaro', 'Microsoft Dalia', 'Microsoft Helena',
        'es-MX', 'es-ES', 'es-US', 'es-419'
      ];

      const byLang = v => v && v.lang && /^es(-|$)/i.test(v.lang);
      const byName = v => preferNames.some(n => (v.name||'').toLowerCase().includes(n.toLowerCase()));
      const isEnglish = v => v && /^en/i.test(v.lang);

      if (lp.startsWith('es')){
        return candidates.find(v=>byLang(v) && byName(v))
            || candidates.find(byLang)
            || candidates[0]
            || null;
      }
      if (lp.startsWith('en')){
        return candidates.find(isEnglish) || candidates[0] || null;
      }
      return candidates[0] || null;
    },
    stop(){ if ('speechSynthesis' in window) window.speechSynthesis.cancel(); },
    pause(){ if ('speechSynthesis' in window) window.speechSynthesis.pause(); },
    resume(){ if ('speechSynthesis' in window) window.speechSynthesis.resume(); },
    speak(text, langPrefix='en', rate){
      if (!('speechSynthesis' in window)) { alert('Text-to-speech not supported in this browser.'); return; }
      const clean = (text||'').replace(/\s+/g,' ').trim();
      if (!clean) return;
      const voice = Speech.pickVoice(langPrefix);
      const chunks = chunkText(clean, 140);
      chunks.forEach((seg)=>{
        const u = new SpeechSynthesisUtterance(seg);
        if (voice) u.voice = voice;
        u.lang = voice ? voice.lang : (langPrefix.startsWith('es') ? 'es-ES' : 'en-US');
        u.rate = rate || (langPrefix.startsWith('es') ? Speech.defaultRateES : Speech.defaultRate);
        u.pitch = 1.0;
        u.volume = 1.0;
        window.speechSynthesis.speak(u);
      });
    }
  };

  function chunkText(str, maxLen=160){
    const parts = [];
    const sentences = str.replace(/\s+/g,' ').split(/(?<=[\.\!\?])\s+/);
    let buf = '';
    for (const s of sentences){
      if ((buf + ' ' + s).length > maxLen && buf) { parts.push(buf); buf = s; }
      else { buf = buf ? (buf + ' ' + s) : s; }
    }
    if (buf) parts.push(buf);
    return parts;
  }

  /* ===== Inject per-line TTS buttons ===== */
  function addPerLineTTS(root){
    const tables = root.querySelectorAll('table');
    tables.forEach(tbl=>{
      const rows = Array.from(tbl.querySelectorAll('tr'));
      if (!rows.length) return;

      const headerCells = Array.from(rows[0].querySelectorAll('th'));
      const hasHeader = headerCells.length > 0;
      const colLangMap = mapHeaderToLang(headerCells);

      rows.slice(hasHeader ? 1 : 0).forEach(tr=>{
        const sub = tr.querySelector('.subcategory');
        if (sub && sub.getAttribute('colspan')) return;
        const cells = Array.from(tr.querySelectorAll('td'));
        cells.forEach((td, idx)=>{
          const lang = colLangMap[idx];
          if (lang === 'en' || lang === 'es'){
            insertTTSButton(td, lang);
          }
        });
      });
    });
  }

  function mapHeaderToLang(ths){
    const map = [];
    const norm = s => (s||'').toLowerCase();
    ths.forEach((th, i)=>{
      const t = norm(th.textContent);
      if (t.includes('english') || t.includes('(en)')) map[i] = 'en';
      else if (t.includes('espa√±ol') || t.includes('espanol') || t.includes('(es)') || t.includes('prompt (espa√±ol)')) map[i] = 'es';
      else if (t.includes('answer (en)')) map[i] = 'en';
      else if (t.includes('answer (es)')) map[i] = 'es';
      else map[i] = '';
    });
    if (ths.length === 1 && (!map[0] || map[0]==='')){ const t = norm(ths[0].textContent); map[0] = (t.includes('espa√±ol') || t.includes('espanol') || t.includes('(es)')) ? 'es' : 'en'; }
    return map;
  }

  function getCellReadableText(td){
    let txt = '';
    td.childNodes.forEach(n=>{
      const isBtn = n.nodeType===1 && n.tagName==='BUTTON' && n.classList.contains('tts-line-btn');
      if (!isBtn) txt += (n.textContent || '');
    });
    return txt.replace(/\s+/g,' ').trim();
  }

  function insertTTSButton(td, lang){
    if (td.querySelector('.tts-line-btn')) return;
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'tts-line-btn';
    btn.setAttribute('data-tts', lang);
    btn.title = lang === 'es' ? 'Reproducir esta l√≠nea (Espa√±ol)' : 'Play this line (English)';
    btn.textContent = 'üîä';
    td.insertBefore(btn, td.firstChild);
    btn.addEventListener('click', async (e)=>{
      e.stopPropagation();
      await Speech.ensureVoices();
      const text = getCellReadableText(td);
      Speech.stop();
      Speech.speak(text, lang, undefined);
    });
  }

  /* ===== Conversation global players (unchanged) ===== */
  function addConversationPlayers(root){
    const sections = root.querySelectorAll('.section h2');
    sections.forEach(h2=>{
      if(!/Conversation\s+\d+/i.test(h2.textContent||'')) return;
      const table = h2.parentElement.querySelector('table');
      if(!table) return;
      const trSel = 'tbody tr';
      const spanishIdx = (()=>{
        const ths = Array.from(table.querySelectorAll('thead th'));
        if (!ths.length) return 1;
        for (let i=0;i<ths.length;i++){
          const t=(ths[i].textContent||'').toLowerCase();
          if (t.includes('espa√±ol')||t.includes('espanol')) return i;
        }
        return ths.length-1;
      })();

      const ctrl = document.createElement('div');
      ctrl.className = 'conv-ctrls';
      const playBtn = document.createElement('button');
      playBtn.textContent = 'Play Conversation (ES)';
      playBtn.className = 'primary';
      const pauseBtn = document.createElement('button');
      pauseBtn.textContent = 'Pause';
      const stopBtn = document.createElement('button');
      stopBtn.textContent = 'Stop';
      ctrl.append(playBtn,pauseBtn,stopBtn);
      h2.parentElement.insertBefore(ctrl, table);

      const rows = Array.from(table.querySelectorAll(trSel));
      const esTexts = rows.map(r=>{
        const tds = Array.from(r.querySelectorAll('td'));
        const cell = tds[spanishIdx];
        return cell ? getCellReadableText(cell) : '';
      }).filter(Boolean);

      const player = makeQueuePlayer(esTexts, 'es');

      playBtn.addEventListener('click', async ()=>{
        await Speech.ensureVoices();
        if(player.state==='stopped'){ player.start(); playBtn.textContent='Pause/Resume'; }
        else if(player.state==='playing'){ player.pause(); playBtn.textContent='Resume'; }
        else if(player.state==='paused'){ player.resume(); playBtn.textContent='Pause/Resume'; }
      });

      pauseBtn.addEventListener('click', ()=>{
        if(player.state==='playing'){ player.pause(); playBtn.textContent='Resume'; }
        else if(player.state==='paused'){ player.resume(); playBtn.textContent='Pause/Resume'; }
      });

      stopBtn.addEventListener('click', ()=>{
        player.stop(); playBtn.textContent='Play Conversation (ES)';
      });
    });
  }

  function makeQueuePlayer(lines, lang){
    let idx=0, current=null; 
    let state='stopped';
    const buildUtterance = (text)=>{
      const voice = Speech.pickVoice(lang);
      const u = new SpeechSynthesisUtterance(text);
      if (voice) u.voice = voice;
      u.lang = voice ? voice.lang : (lang==='es'?'es-ES':'en-US');
      u.rate = Speech.defaultRateES;
      u.pitch = 1.0;
      u.onend = ()=>{ if(state!=='stopped'){ idx++; playNext(); } };
      return u;
    };
    const playNext = ()=>{
      if (idx>=lines.length){ state='stopped'; return; }
      const text = lines[idx];
      if(!text){ idx++; playNext(); return; }
      current = buildUtterance(text);
      window.speechSynthesis.speak(current);
      state='playing';
    };
    return {
      get state(){ return state; },
      start(){ Speech.stop(); idx=0; playNext(); },
      pause(){ if(state==='playing'){ window.speechSynthesis.pause(); state='paused'; } },
      resume(){ if(state==='paused'){ window.speechSynthesis.resume(); state='playing'; } },
      stop(){ Speech.stop(); state='stopped'; idx=0; current=null; }
    };
  }

  /* ===== Force full blue/red color in Phrases/Questions if needed ===== */
  function forcePhraseQuestionColoring(root){
    const sections = Array.from(root.querySelectorAll('.section'));
    sections.forEach(sec=>{
      const h2=sec.querySelector('h2'); if(!h2) return;
      const name=(h2.textContent||'').toLowerCase();
      if(name.includes('common phrases') || name.includes('frases')){
        const tbl=sec.querySelector('table'); if(!tbl) return;
        tbl.classList.add('phrases-table');
        // style columns
        addScopedStyle(tbl, `
          .phrases-table td:first-child { color:${getComputedStyle(document.documentElement).getPropertyValue('--en')||'#1a73e8'}; font-weight:700; }
          .phrases-table td:last-child { color:${getComputedStyle(document.documentElement).getPropertyValue('--es')||'#d93025'}; font-weight:700; }
        `);
      }
      if(name.includes('common questions') || name.includes('preguntas')){
        const tbl=sec.querySelector('table'); if(!tbl) return;
        tbl.classList.add('questions-table');
        addScopedStyle(tbl, `
          .questions-table td:first-child { color:${getComputedStyle(document.documentElement).getPropertyValue('--en')||'#1a73e8'}; font-weight:700; }
          .questions-table td:last-child { color:${getComputedStyle(document.documentElement).getPropertyValue('--es')||'#d93025'}; font-weight:700; }
        `);
      }
    });
  }
  function addScopedStyle(el, css){
    const style=document.createElement('style'); style.textContent=css; el.parentElement.insertBefore(style, el);
  }

  /* =========================
     ======== VOCABULARY =====
     ========================= */
  (function setupVocab(){
    // --- UI (added section picker & custom cap @ 300) ---
    const vocabUI=`
      <div class="fcs-card">
        <h2>Vocabulary Creator</h2>
        <div class="grid">
          <div class="six"><label for="v-topic">Topic</label><input id="v-topic" type="text" placeholder="e.g., At the Airport"></div>
          <div class="six"><label for="v-level">Level</label>
            <select id="v-level">
              <option value="1" selected>Level 1 ‚Äî Survival</option>
              <option value="2">Level 2 ‚Äî Beginner</option>
              <option value="3">Level 3 ‚Äî Intermediate</option>
              <option value="4">Level 4 ‚Äî Conversational</option>
              <option value="5">Level 5 ‚Äî Fluent</option>
            </select>
          </div>

          <div class="six">
            <label for="v-tmode">Total Words Mode</label>
            <select id="v-tmode"><option value="default" selected>Preset by Level</option><option value="custom">Custom</option></select>
            <div id="v-presetText" class="hint"></div>
          </div>
          <div class="six">
            <div class="grid">
              <div class="six"><label for="v-tmin">Min</label><input id="v-tmin" type="number" min="1" max="300" disabled></div>
              <div class="six"><label for="v-tmax">Max (‚â§300)</label><input id="v-tmax" type="number" min="1" max="300" disabled></div>
            </div>
          </div>

          <div class="twelve">
            <label>Sections to include</label>
            <div id="v-sections" class="grid-2" style="align-items:center">
              <label><input type="checkbox" class="v-sec" value="Nouns" checked> Nouns</label>
              <label><input type="checkbox" class="v-sec" value="Verbs" checked> Verbs</label>
              <label><input type="checkbox" class="v-sec" value="Descriptive Words" checked> Descriptive Words</label>
              <label><input type="checkbox" class="v-sec" value="Common Phrases" checked> Common Phrases</label>
              <label><input type="checkbox" class="v-sec" value="Common Questions" checked> Common Questions</label>
              <label><input type="checkbox" id="v-all" checked> All of these</label>
            </div>
            <div class="hint">Choose specific sections or leave ‚ÄúAll of these‚Äù on.</div>
          </div>

          <div class="twelve">
            <label for="v-vocab-include">Vocabulary to Include (optional)</label>
            <textarea id="v-vocab-include" rows="3" placeholder="Paste a full or partial list of words to include..."></textarea>
          </div>
        </div>

        <div class="actions">
          <button id="v-gen" class="primary">Generate Vocabulary</button>
          <button id="v-excel">Download Excel</button>
          <button id="v-copy">Copy</button>
          <div id="v-status" class="status"></div>
        </div>
      </div>`;
    $('gen-vocab').innerHTML=vocabUI;

    const genBtn=$('v-gen'),excelBtn=$('v-excel'),copyBtn=$('v-copy'),statusEl=$('v-status'),
          levelEl=$("v-level"),tmodeEl=$("v-tmode"),tminEl=$("v-tmin"),tmaxEl=$("v-tmax"),
          presetTextEl=$("v-presetText"),topicEl=$("v-topic"),vocabIncludeEl=$("v-vocab-include");

    const presetRanges={
      "1":{min:33,max:55},
      "2":{min:60,max:85},
      "3":{min:90,max:120},
      "4":{min:120,max:180},
      "5":{min:160,max:240}
    };
    const levelTexts={"1":"Level 1‚ÄîSurvival","2":"Level 2‚ÄîBeginner","3":"Level 3‚ÄîIntermediate","4":"Level 4‚ÄîConversational","5":"Level 5‚ÄîFluent"};

    // All vs specific sections
    const allToggle=$('v-all');
    const secBoxes=()=>Array.from(document.querySelectorAll('.v-sec'));
    function updateSectionLocks(){
      const all=allToggle.checked;
      secBoxes().forEach(cb=>{ cb.disabled=all; cb.checked=all?true:cb.checked; });
    }
    allToggle.addEventListener('change',updateSectionLocks); updateSectionLocks();

    function selectedSections(){
      if(allToggle.checked) return ["Nouns","Verbs","Descriptive Words","Common Phrases","Common Questions"];
      const list=secBoxes().filter(cb=>cb.checked).map(cb=>cb.value);
      return list.length?list:["Nouns","Verbs","Descriptive Words","Common Phrases","Common Questions"];
    }

    function updateUI(){
      const isCustom=tmodeEl.value==='custom';
      const range=presetRanges[levelEl.value];
      tminEl.disabled=!isCustom; tmaxEl.disabled=!isCustom;
      if(!isCustom){ tminEl.value=range.min; tmaxEl.value=range.max; }
      tmaxEl.max=300; tminEl.max=300;
      presetTextEl.textContent=`Preset for ${levelTexts[levelEl.value]}: ${range.min}‚Äì${range.max} Spanish vocabulary words (red).`;
    }
    tmodeEl.addEventListener('change',updateUI); levelEl.addEventListener('change',updateUI); updateUI();

    // --- Generate ---
    genBtn.addEventListener('click', ()=>{
      if(!topicEl.value.trim()){statusEl.textContent="Please enter a topic.";return;}
      // clamp custom max at 300
      if(tmodeEl.value==='custom'){
        const min=Math.max(1, Number(tminEl.value)||1);
        const max=Math.min(300, Math.max(min, Number(tmaxEl.value)||min));
        tminEl.value=min; tmaxEl.value=max;
      }

      const secs=selectedSections();
      const range=tmodeEl.value==='custom'
        ? {min:Number(tminEl.value), max:Number(tmaxEl.value)}
        : presetRanges[levelEl.value];

      const prompt =
`<!DOCTYPE html>
<!-- FCS VOCABULARY OUTPUT -->
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vocabulary ‚Äî ${topicEl.value}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a;}
  *{box-sizing:border-box} body{font-family:Calibri,Arial,sans-serif;font-size:10pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:14px;overflow-x:auto}
  .legend{font-size:9pt;color:var(--muted);text-align:center;margin:6px 0 0 0}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:6px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700} .es{color:var(--es);font-weight:700}
  .subcategory{background:#eef2ff;font-weight:700;text-align:left}
  .badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#f8fafc;font-size:9pt;margin:6px}
  .note{font-size:9pt;color:var(--muted)}
  /* Full-color rule for Phrases/Questions: entire EN/ES cells */
  .phrases td:first-child, .questions td:first-child{ color:var(--en); font-weight:700; }
  .phrases td:last-child, .questions td:last-child{ color:var(--es); font-weight:700; }
  @media(max-width:700px){ .tbl{font-size:9pt;width:auto} }
</style></head>
<body><div class="fcs-doc" lang="en">
  <h1>Vocabulary: ${topicEl.value} ‚Äî ${levelTexts[levelEl.value]}</h1>
  <div class="legend">
    <span class="badge"><span class="en">English</span> / <span class="es" lang="es">Espa√±ol</span></span>
    <span class="badge">English blue; Spanish red (.en/.es). Phrases/Questions: full-cell color.</span>
  </div>

  <!-- STRICT CONTRACT FOR THE MODEL:
    UI.selectedSections = ${JSON.stringify(secs)}
    TARGET_SPANISH_VOCAB_DISTINCT (count only <span class="es"> inside Nouns, Verbs, Descriptive) MUST be between ${range.min} and ${range.max}. Do not exceed 300.
    REQUIRED SECTIONS: include ONLY those chosen in UI.selectedSections, in this order: Nouns, Verbs, Descriptive Words, Common Phrases, Common Questions.
    TABLE RULES: two columns (English | Espa√±ol); no empty <tbody>; alphabetize by English within each section.
    VERBS SECTION: third person only (He, She, It, They). English lines must use ‚Äúis/are going to + [verb] ‚Ä¶‚Äù. Spanish lines must use ‚Äúva a/van a + [infinitive] ‚Ä¶‚Äù (e.g., ‚Äú√âl va a cocinar.‚Äù). Avoid first/second person.
    PHRASES & QUESTIONS: color the entire sentences (EN all blue; ES all red). Use classes "phrases" and "questions" on those tables.
    NO placeholders or comments; return final content only.
    If teacher provided a list, you must include those items (plus level-appropriate extras) and still respect the TARGET_SPANISH_VOCAB_DISTINCT range.
  -->

  ${secs.includes('Nouns') ? `
  <div class="section"><h2>Nouns / Sustantivos</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead>
      <tbody><!-- nouns here; mark the target Spanish noun with <span class="es">only the noun</span> --></tbody></table>
  </div>` : ''}

  ${secs.includes('Verbs') ? `
  <div class="section"><h2>Verbs / Verbos</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead>
      <tbody><!-- verbs here; EN: He/She/It/They is/are going to + verb; ES: (√âl/Ella/It/Ellos/Ellas) va/van a + infinitive; mark only the infinitive verb with <span class="es"> --></tbody></table>
  </div>` : ''}

  ${secs.includes('Descriptive Words') ? `
  <div class="section"><h2>Descriptive Words / Palabras descriptivas</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead>
      <tbody><!-- descriptive here; mark only the adjective/adverb with <span class="es"> --></tbody></table>
  </div>` : ''}

  ${secs.includes('Common Phrases') ? `
  <div class="section"><h2>Common Phrases / Frases comunes</h2>
    <table class="tbl phrases"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead>
      <tbody><!-- full sentences; entire cells colored via CSS (no inner <span class="es"> required) --></tbody></table>
  </div>` : ''}

  ${secs.includes('Common Questions') ? `
  <div class="section"><h2>Common Questions / Preguntas comunes</h2>
    <table class="tbl questions"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead>
      <tbody><!-- Q (bold) + sample answer row (italics) + spacer row; full-cell color via CSS --></tbody></table>
  </div>` : ''}

  ${vocabIncludeEl.value ? `
  <div class="note" style="white-space:pre-wrap;border:1px dashed var(--border);padding:8px;border-radius:8px;margin-top:8px;">
    Teacher Vocabulary (STRICT use):\n${vocabIncludeEl.value.replace(/</g,"&lt;").replace(/>/g,"&gt;")}
  </div>` : ''}

</div></body></html>`;

      // ---- Compliance checker (range + sections + verbs style) ----
      const retryIfBad = (html)=>{
        try{
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const headers = Array.from(doc.querySelectorAll('.section h2')).map(h=>h.textContent.trim());
          const present = new Set(headers.map(h=>h.split('/')[0].trim().toLowerCase()));

          const want = selectedSections().map(s=>s.toLowerCase());
          const nameMap = {
            'nouns':'nouns', 'verbs':'verbs',
            'descriptive words':'descriptive', 'common phrases':'phrases', 'common questions':'questions'
          };
          const displayToKey = s=>nameMap[s.toLowerCase()]||s.toLowerCase();

          const missing = want.filter(w=>{
            if(w==='descriptive words') return !Array.from(present).some(p=>p.includes('descriptive'));
            return !Array.from(present).some(p=>p.includes(w.replace('common ','').trim()));
          });
          const extra = Array.from(present).filter(p=>{
            const key = ['nouns','verbs','descriptive','phrases','questions'].find(k=>p.toLowerCase().includes(k));
            if(!key) return false;
            const disp = Object.keys(nameMap).find(k=>nameMap[k]===key) || key;
            return !want.includes(disp);
          });

          // Count distinct <span class="es"> only in Nouns/Verbs/Descriptive
          const sectionsToCount = ['nouns','verbs','descriptive'];
          let esWords = [];
          doc.querySelectorAll('.section').forEach(sec=>{
            const h2 = sec.querySelector('h2'); if(!h2) return;
            const t=(h2.textContent||'').toLowerCase();
            if(sectionsToCount.some(k=>t.includes(k))){
              sec.querySelectorAll('span.es').forEach(sp=>{
                const w=(sp.textContent||'').toLowerCase().trim();
                if(w) esWords.push(w);
              });
            }
          });
          const distinct = Array.from(new Set(esWords));
          const count = distinct.length;

          const r = (tmodeEl.value==='custom'
            ? {min:Number(tminEl.value), max:Number(tmaxEl.value)}
            : presetRanges[levelEl.value]);
          const problems=[];
          if(missing.length) problems.push(`missing sections: ${missing.join(', ')}`);
          if(extra.length) problems.push(`unexpected sections present: ${extra.join(', ')}`);
          if(count<r.min || count>Math.min(300,r.max)) problems.push(`Spanish vocab distinct count = ${count} (must be ${r.min}‚Äì${Math.min(300,r.max)})`);

          // Verbs pattern check: majority must contain 'va a' or 'van a'
          const verbSec = Array.from(doc.querySelectorAll('.section')).find(s=>{
            const h=s.querySelector('h2'); return h && /verbs/i.test(h.textContent||'');
          });
          if(verbSec){
            const ths=Array.from(verbSec.querySelectorAll('thead th'));
            let esIdx = ths.findIndex(th=>/espa√±ol|espanol/i.test(th.textContent||'')); if(esIdx<0) esIdx=ths.length-1;
            const rows=Array.from(verbSec.querySelectorAll('tbody tr'));
            let total=0, ok=0;
            rows.forEach(tr=>{
              const tds=Array.from(tr.querySelectorAll('td'));
              if(!tds.length) return;
              total++;
              const txt=(tds[esIdx]?.textContent||'').toLowerCase();
              if(/\bva a\b/.test(txt) || /\bvan a\b/.test(txt)) ok++;
            });
            if(total>0 && ok/total < 0.8) problems.push(`verbs not following "va a/van a" pattern (only ${ok}/${total} lines)`);
          }
          return problems.length ? problems.join('; ') : '';
        }catch(e){ return ''; }
      };

      generateResult(prompt,genBtn,statusEl,$('v-output'),{retryIfBad});
    });

    $('v-copy').addEventListener('click',()=>copyToClipboard($('v-output'),statusEl));
    $('v-excel').addEventListener('click',()=>downloadAsExcel($('v-output'),statusEl,topicEl.value||'Vocabulary'));
  })();

  /* =========================
     ===== CONVERSATION UI ===
     ========================= */
  (function setupConvo(){
    const convoUI=`
      <div class="fcs-card"><h2>Conversation Creator</h2>
        <div class="grid-2">
          <div class="grid-full"><label for="c-topic">Topic</label><input id="c-topic" type="text" placeholder="e.g., A funny story about a vacation"/></div>
          <div><label>Level (Grammar)</label>
            <select id="c-level">
              <option value="1" selected>Level 1 ‚Äî Survival</option>
              <option value="2">Level 2 ‚Äî Beginner</option>
              <option value="3">Level 3 ‚Äî Intermediate</option>
              <option value="4">Level 4 ‚Äî Conversational</option>
              <option value="5">Level 5 ‚Äî Fluent</option>
            </select></div>
          <div><label>Sentences per Turn ‚Äî Min</label><input id="c-sentMin" type="number" value="2"/></div>
          <div><label>Sentences per Turn ‚Äî Max</label><input id="c-sentMax" type="number" value="4"/></div>

          <div class="grid-full"><label for="c-vocab">Vocabulary (optional)</label><textarea id="c-vocab" rows="8" placeholder="Put your own vocabulary here..."></textarea></div>
          <div><label>Number of Conversations</label><input id="c-numConvos" type="number" value="2"/></div>
          <div><label># of Speakers</label><input id="c-numSpeakers" type="number" value="2"/></div>
          <div><label>Turns (approx.)</label><input id="c-turns" type="number" value="10"/></div>
          <div><label>Tone</label><select id="c-tone"><option>Neutral, casual</option><option>Informal, friendly</option><option>Instructor, student</option><option>Customer, staff</option><option>Professional, formal</option><option>Street slang</option></select></div>
          <div><label>Country / Region</label><select id="c-country"></select></div>
          <div class="grid-full"><label>Include English Translation</label><select id="c-includeEN"><option value="yes" selected>Yes</option><option value="no">No</option></select></div>
          <div><label>Add Fill-In-The-Blank</label><select id="c-addFib"><option value="no">No</option><option value="yes" selected>Yes</option></select></div>
          <div><label>FIB Focus</label><select id="c-fibFocus"><option>Mixed</option><option>Vocab only</option><option>Grammar only</option><option>Verbs only</option></select></div>
          <div><label>Show FIB Answer Key</label><select id="c-showFIBKey"><option value="yes">Yes</option><option value="no">No</option></select></div>
          <div><label>Show Vocabulary List</label><select id="c-showVocabList"><option value="yes">Yes</option><option value="no">No</option></select></div>
          <div class="grid-full"><label>Optional Teacher Notes</label><textarea id="c-notes" rows="4"></textarea></div>
        </div>
        <div class="actions"><button id="c-gen" class="primary">Generate</button><button id="c-excel">Excel</button><button id="c-copy">Copy</button><div id="c-status" class="status"></div></div>
      </div>`;
    $('gen-convo').innerHTML = convoUI;

    const countrySelect=$('c-country');
    const countries=["-no specific-","Argentina","Bolivia","Chile","Colombia","Costa Rica","Cuba","Dominican Republic","Ecuador","El Salvador","Equatorial Guinea","Guatemala","Honduras","Mexico","Nicaragua","Panama","Paraguay","Peru","Puerto Rico","Spain","Uruguay","Venezuela"];
    countrySelect.innerHTML=countries.map(c=>`<option>${c}</option>`).join('');

    const genBtn=$('c-gen'),excelBtn=$('c-excel'),copyBtn=$('c-copy'),statusEl=$('c-status'),outputEl=$('c-output');

    genBtn.addEventListener('click', ()=>{
      const topic=$('c-topic').value.trim(); if(!topic){statusEl.textContent="Enter a topic.";return;}
      const sentMin = Math.max(1, Number($('c-sentMin').value)||2);
      const sentMax = Math.max(sentMin, Number($('c-sentMax').value)||4);
      const fibCount = Math.max(8, Math.min(30, Math.round(Number($('c-turns').value) * 0.8)));

      const ui = {
        topic: topic,
        level: $('c-level').value,
        sentences_per_turn: { min: sentMin, max: sentMax },
        vocab: $('c-vocab').value || "(auto-generate level-appropriate list if empty)",
        numConvos: Number($('c-numConvos').value)||1,
        numSpeakers: Number($('c-numSpeakers').value)||2,
        turnsApprox: Number($('c-turns').value)||10,
        tone: $('c-tone').value,
        region: $('c-country').value,
        includeEN: $('c-includeEN').value,
        addFIB: $('c-addFib').value,
        fibFocus: $('c-fibFocus').value,
        showFIBKey: $('c-showFIBKey').value,
        showVocabList: $('c-showVocabList').value,
        teacherNotes: $('c-notes').value||""
      };

      const prompt =
`<!DOCTYPE html>
<!-- FCS CONVERSATION OUTPUT (Full HTML; no commentary) -->
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conversation ‚Äî ${ui.topic}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a;--hi:#eef2ff}
  *{box-sizing:border-box}
  body{font-family:Calibri,Arial,sans-serif;font-size:11pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin:14px 0;overflow-x:auto}
  .legend{font-size:9pt;color:var(--muted);text-align:center;margin-top:6px}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:8px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700}
  .es{color:var(--es);font-weight:700}
  .chip{display:inline-block;background:var(--hi);border:1px solid var(--border);border-radius:999px;padding:0 8px;margin-right:6px;font-weight:700}
  .note{font-size:9pt;color:var(--muted)}
  em,i{font-style:normal}
  @media(max-width:700px){
    .tbl{font-size:9pt;width:auto}
    .tbl thead{display:none}
    .tbl td{display:block;width:100%}
    .tbl td+td{margin-top:6px}
  }
</style>
</head>
<body>
<div class="fcs-doc">
  <h1>Conversation: ${ui.topic} ‚Äî Level ${ui.level}</h1>
  <div class="legend">
    <span class="en">EN vocab = blue</span> | <span class="es">ES vocab = red</span>.
    ${ui.includeEN==='yes'
      ? '<strong>Two-column:</strong> English on left, Spanish on right.'
      : '<strong>Spanish-only:</strong> English column omitted.'}
  </div>

  <!-- CONTRACT FOR THE MODEL (STRICT):
    UI = ${JSON.stringify(ui)}
    - Create exactly UI.numConvos conversation sections; each has ~UI.turnsApprox total turns split among UI.numSpeakers speakers.
    - Choose distinct, realistic names from UI.region‚Äôs culture for the speakers (no ‚ÄúA/B‚Äù labels).
    - Every single turn must contain between UI.sentences_per_turn.min and UI.sentences_per_turn.max sentences (inclusive) in both languages (if EN included).
    - No blanks in English lines. Instead, the English translation of the targeted Spanish vocabulary word is bold blue.
    - In Spanish lines of the FIB section, put the English hint in parentheses immediately before the blank, like: (ENGLISH WORD) ________ .
    - Tone must match UI.tone. Keep grammar exactly within Level UI.level scope.
    - Use ONLY teacher vocabulary if provided (plus glue words); otherwise auto-generate level-appropriate vocab.
    - Minimum 10 distinct bold-red Spanish vocabulary words per conversation.
    - If UI.includeEN === "no", omit the English column; else use two columns.
    - If UI.addFIB === "yes", include a FIB section with ${Math.max(8, Math.min(30, Math.round(Number(ui.turnsApprox) * 0.8)))} items; obey UI.fibFocus.
    - If UI.showFIBKey === "yes", include a final Answer Key with numbered answers (no sentences).
    - If UI.showVocabList === "yes", include a ‚ÄúVocabulary Used‚Äù table (EN|ES).
    - SELF-CHECK before returning: counts, columns, per-turn sentence bounds, and required sections.
  -->

  ${Array.from({length: Number(ui.numConvos)}).map((_,i)=>`
  <div class="section">
    <h2>Conversation ${i+1}</h2>
    <div class="legend"><span class="chip">${ui.tone}</span><span class="chip">${ui.region}</span><span class="chip">${ui.numSpeakers} speakers</span><span class="chip">${ui.sentences_per_turn.min}-${ui.sentences_per_turn.max} sentences/turn</span></div>
    <table class="tbl">
      <thead>
        ${ui.includeEN==='yes'
          ? '<tr><th>English</th><th lang="es">Espa√±ol</th></tr>'
          : '<tr><th lang="es">Espa√±ol</th></tr>'}
      </thead>
      <tbody><!-- generate ~${ui.turnsApprox} labeled turns; no ‚ÄúA/B‚Äù, use real names; comply with sentence bounds. --></tbody>
    </table>
  </div>`).join('')}

  <div class="section">
    <h2>Practice ‚Äî Fill-in-the-Blank (${ui.fibFocus})</h2>
    <table class="tbl">
      <thead>
        ${ui.includeEN==='yes'
          ? '<tr><th>(EN ‚Äî NO BLANKS; target word in <span class="en">blue</span>)</th><th lang="es">(ES ‚Äî (ENGLISH WORD) ________ )</th></tr>'
          : '<tr><th lang="es">(ES ‚Äî (ENGLISH WORD) ________ )</th></tr>'}
      </thead>
      <tbody><!-- ${Math.max(8, Math.min(30, Math.round(Number(ui.turnsApprox) * 0.8)))} items --></tbody>
    </table>
  </div>

  ${ui.showVocabList==='yes' ? `
  <div class="section">
    <h2>Vocabulary Used</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead>
      <tbody><!-- key vocabulary (EN | ES). --></tbody></table>
  </div>` : ''}

  ${ui.showFIBKey==='yes' ? `
  <div class="section"><h2>Answer Key</h2>
    <table class="tbl"><thead><tr><th>#</th><th>Answer</th></tr></thead>
      <tbody><!-- numbered answers only --></tbody></table>
  </div>` : ''}

  ${ui.vocab && ui.vocab!=="(auto-generate level-appropriate list if empty)" ? `
  <div class="note" style="white-space:pre-wrap;border:1px dashed var(--border);padding:8px;border-radius:8px;margin-top:8px;">
    Teacher Vocabulary (STRICT use):\n${$('c-vocab').value.replace(/</g,"&lt;").replace(/>/g,"&gt;")}
  </div>` : ''}

  ${ui.teacherNotes ? `<div class="note" style="white-space:pre-wrap;margin-top:8px;">Teacher notes:\n${$('c-notes').value.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>` : ''}

</div>
</body>
</html>`;

      const retryIfBad = (html)=>{
        try{
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const sections = Array.from(doc.querySelectorAll('.section h2')).filter(h=>/Conversation\s+\d+/i.test(h.textContent||''));
          const min = Math.max(1, Number($('c-sentMin').value)||2);
          const max = Math.max(min, Number($('c-sentMax').value)||4);
          const problems=[];
          sections.forEach((h, si)=>{
            const tbl = h.parentElement.querySelector('table');
            if(!tbl) { problems.push(`conv ${si+1}: missing table`); return; }
            const rows = Array.from(tbl.querySelectorAll('tbody tr'));
            if(!rows.length){ problems.push(`conv ${si+1}: no rows`); return; }
            const ths = Array.from(tbl.querySelectorAll('thead th'));
            let esIdx = ths.findIndex(th=>/espa√±ol|espanol/i.test(th.textContent||'')); if(esIdx<0) esIdx=ths.length-1;
            rows.forEach((tr,ri)=>{
              const tds = Array.from(tr.querySelectorAll('td'));
              if(!tds.length) return;
              const text = (tds[esIdx]?.textContent||'').trim();
              if(!text) return;
              const sentences = (text.replace(/\s+/g,' ').match(/[^\.!?]+[\.!?]+/g)||[text]).length;
              if(sentences<min || sentences>max){ problems.push(`conv ${si+1} row ${ri+1}: ${sentences} sentences`); }
            });
          });
          return problems.length ? problems.slice(0,6).join('; ') : '';
        }catch(e){ return ''; }
      };

      generateResult(prompt,genBtn,statusEl,outputEl,{retryIfBad});
    });

    $('c-copy').addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    $('c-excel').addEventListener('click', ()=>downloadAsExcel(outputEl,statusEl,$('c-topic').value||'Conversation'));
  })();

  /* =========================
     ========= TEST ==========
     ========================= */
  (function setupTest(){
    const testUI=`
      <div class="fcs-card">
        <h2>Test Creator</h2>
        <div><label for="t-vocab">Vocabulary List</label><textarea id="t-vocab" rows="6" placeholder="Paste the EXACT vocabulary for the test..."></textarea></div>
        <div><label for="t-level">Level (Grammar)</label>
          <select id="t-level">
            <option value="1" selected>Level 1 ‚Äî Survival</option>
            <option value="2">Level 2 ‚Äî Beginner</option>
            <option value="3">Level 3 ‚Äî Intermediate</option>
            <option value="4">Level 4 ‚Äî Conversational</option>
            <option value="5">Level 5 ‚Äî Fluent</option>
          </select></div>
        <div><label><input type="checkbox" id="t-anskeys" checked> Include Teacher Answer Keys?</label></div>
        <div class="actions"><button id="t-gen" class="primary">Generate</button><button id="t-excel">Excel</button><button id="t-copy">Copy</button><div id="t-status" class="status"></div></div>
      </div>`;
    $('gen-test').innerHTML=testUI;

    const genBtn=$('t-gen'),excelBtn=$('t-excel'),copyBtn=$('t-copy'),statusEl=$('t-status'),outputEl=$('t-output');

    genBtn.addEventListener('click', ()=>{
      const vocabEl=$('t-vocab'); if(!vocabEl.value.trim()){statusEl.textContent="Please paste a vocab list.";return;}
      const prompt =
`<!DOCTYPE html>
<!-- FCS TEST OUTPUT -->
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Test ‚Äî Level ${$('t-level').value}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a}
  *{box-sizing:border-box} body{font-family:Calibri,Arial,sans-serif;font-size:10pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:14px;overflow-x:auto}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:8px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700} .es{color:var(--es);font-weight:700}
  .note{font-size:9pt;color:var(--muted)}
  @media(max-width:700px){ .tbl{font-size:9pt;width:auto} }
</style></head>
<body><div class="fcs-doc">
  <h1>FCS Conversation Test ‚Äî Level ${$('t-level').value}</h1>
  <div class="note"><span class="en">English terms = blue</span>; <span class="es">Spanish terms = red</span> whenever vocabulary appears inline.</div>

  <div class="section">
    <h2>Part 1 ‚Äî Spanish ‚Üí English</h2>
    <table class="tbl"><thead><tr><th>#</th><th lang="es">Espa√±ol</th>${$('t-anskeys').checked ? '<th>Answer (EN)</th>' : ''}</tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Part 2 ‚Äî English ‚Üí Spanish</h2>
    <table class="tbl"><thead><tr><th>#</th><th>English</th>${$('t-anskeys').checked ? '<th lang="es">Answer (ES)</th>' : ''}</tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Part 3 ‚Äî Live Conversation Prompts</h2>
    <table class="tbl"><thead><tr><th>#</th><th lang="es">Prompt (Espa√±ol)</th></tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  ${$('t-anskeys').checked ? `
  <div class="section"><h2>Answer Key</h2><!-- answers only --></div>` : ''}

  <div class="note">Vocabulary pasted by teacher:</div>
  <div class="note" style="white-space:pre-wrap;border:1px dashed var(--border);padding:8px;border-radius:8px;">${$('t-vocab').value.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>

</div></body></html>`;
      generateResult(prompt,genBtn,statusEl,outputEl);
    });

    $('t-copy').addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    $('t-excel').addEventListener('click',()=>downloadAsExcel(outputEl,statusEl,'Test'));
  })();
})();
</script>
</body>
</html>
