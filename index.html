<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>FCS AI Generator Suite</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  :root {
    --bg:#f7f9fc; --fg:#111; --muted:#667085;
    --border:#e5e7eb; --panel:#ffffff; --accent:#0b5cff;
    --en:#1a73e8; --es:#d93025; --head:#0f172a;
    --noun:#e0f2fe; --verb:#dcfce7; --desc:#fef9c3; --phr:#fae8ff; --ques:#ffe4e6;
  }
  body { background:var(--bg); color:var(--fg); font-family:Calibri,Arial,sans-serif; font-size:15px; margin:0; }
  .fcs-wrap { max-width:980px; margin:28px auto; padding:0 16px; }
  h1 { font-size:28px; font-weight:700; text-align:center; margin-bottom:28px; color:var(--head); }
  h2 { font-size:20px; font-weight:700; margin:20px 0 10px; border-bottom:1px solid var(--border); color:var(--head); }
  .fcs-card { border:1px solid var(--border); border-radius:12px; padding:24px; background:var(--panel); margin-bottom:20px; }
  label { font-weight:600; font-size:14px; display:block; margin-bottom:6px; }
  input, select, textarea { width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; box-sizing:border-box; }
  textarea { resize:vertical; }
  .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:20px; align-items:center; }
  button { padding:10px 16px; border-radius:8px; border:1px solid var(--border); cursor:pointer; font-weight:600; font-size:15px; transition:0.2s; }
  button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
  button:hover { transform:translateY(-2px); box-shadow:0 4px 10px rgba(0,0,0,0.08); }
  button:disabled { cursor:not-allowed; opacity:0.6; }
  .grid { display:grid; grid-template-columns:repeat(12,1fr); gap:16px; align-items:end; }
  .six { grid-column:span 6; } .twelve { grid-column:span 12; }
  .grid-2 { grid-template-columns:1fr 1fr; gap:12px; }
  .status { margin-top:10px; min-height:1.5em; color:var(--muted); font-size:13px; }
  .output-container { border:1px solid var(--border); border-radius:12px; padding:24px; background:#fff; min-height:240px; margin-top:20px; }
  .output-container h1, .output-container h2 { text-align:center; color:var(--head); }
  .output-container table { width:100%; border-collapse:separate; border-spacing:0; margin-top:12px; font-size:10pt; }
  .output-container th, .output-container td { border:1px solid var(--border); padding:8px; vertical-align:top; }
  .output-container th { background:#f5f7fb; font-weight:700; }
  .output-container tr:nth-child(even) td { background:#fafafa; }
  .output-container .en { color:var(--en); font-weight:700; }
  .output-container .es { color:var(--es); font-weight:700; }
  .tts-line-btn { display:inline-flex; align-items:center; gap:4px; padding:2px 6px; margin-right:6px; border:1px solid #dbe2ef; border-radius:999px; background:#eef2ff; cursor:pointer; font-size:12px; line-height:1; }
  .tts-line-btn[data-tts="es"]{background:#fdeaea;border-color:#f5c2c7;}
  .tts-line-btn:hover { filter:brightness(0.98); }
  @media(max-width:860px){ .grid{grid-template-columns:1fr;} .six,.twelve{grid-column:span 12;} .grid-2{grid-template-columns:1fr;} }
</style>
</head>
<body>
<div class="fcs-wrap">
  <h1>FCS AI GENERATOR SUITE</h1>
  <div class="fcs-tabs">
    <button id="tab-vocab" class="primary">Vocabulary</button>
    <button id="tab-convo">Conversation</button>
    <button id="tab-test">Test</button>
  </div>

  <div id="gen-vocab" class="fcs-generator"></div>
  <div id="gen-convo" class="fcs-generator" style="display:none"></div>
  <div id="gen-test" class="fcs-generator" style="display:none"></div>
</div>

<script>
"use strict";
(function(){
  const $=id=>document.getElementById(id);
  const API_URL="/api/index";

  // â€”â€”â€”â€”â€” Tabs â€”â€”â€”â€”â€”
  document.querySelectorAll(".fcs-tabs button").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll(".fcs-tabs button").forEach(b=>b.classList.remove("primary"));
      btn.classList.add("primary");
      const target = btn.id.replace("tab-","gen-");
      document.querySelectorAll(".fcs-generator").forEach(div=>{
        div.style.display = (div.id===target) ? "block":"none";
      });
    });
  });

  async function callAPI(prompt){
    const resp=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})});
    const data=await resp.json();
    if(!resp.ok) throw new Error(data.error||"Error");
    return data.content;
  }

  // â€”â€”â€”â€”â€” Web Speech (slow, per-line) â€”â€”â€”â€”â€”
  const Speech = {
    voices: [], ready:false, defaultRate:0.8,
    ensureVoices(){
      return new Promise(resolve=>{
        if(!('speechSynthesis' in window)){ resolve(); return; }
        const load=()=>{ this.voices=speechSynthesis.getVoices(); this.ready=this.voices.length>0; resolve(); };
        const v=speechSynthesis.getVoices(); v.length?load():speechSynthesis.onvoiceschanged=load;
      });
    },
    pickVoice(prefix){
      if(!this.ready) return null;
      const lp=(prefix||'en').toLowerCase();
      const exact=this.voices.find(v=>v.lang?.toLowerCase().startsWith(lp));
      if(exact) return exact;
      if(lp.startsWith('es')){
        return this.voices.find(v=>v.lang?.toLowerCase().startsWith('es')) ||
               this.voices.find(v=>v.lang?.toLowerCase().startsWith('en')) || null;
      }
      return this.voices.find(v=>v.lang?.toLowerCase().startsWith('en')) || this.voices[0] || null;
    },
    stop(){ if('speechSynthesis' in window) speechSynthesis.cancel(); },
    speak(text,lang){
      if(!('speechSynthesis' in window)) return;
      const clean=(text||'').replace(/\s+/g,' ').trim(); if(!clean) return;
      this.stop();
      const voice=this.pickVoice(lang);
      const chunks=clean.match(/[^.!?]+[.!?]+/g) || [clean];
      chunks.forEach(seg=>{
        const u=new SpeechSynthesisUtterance(seg.trim());
        if(voice) u.voice=voice;
        u.lang=voice?voice.lang:(lang.startsWith('es')?'es-ES':'en-US');
        u.rate=this.defaultRate; speechSynthesis.speak(u);
      });
    }
  };

  function addTTSButtons(root){
    root.querySelectorAll('table').forEach(tbl=>{
      const header=[...(tbl.rows[0]?.cells||[])];
      const colLang=[];
      header.forEach((th,i)=>{
        const t=(th.textContent||'').toLowerCase();
        if(t.includes('english')||t.includes('(en)')||t.includes('answer (en)')) colLang[i]='en';
        else if(t.includes('espaÃ±ol')||t.includes('(es)')||t.includes('answer (es)')||t.includes('prompt (espaÃ±ol)')) colLang[i]='es';
        else colLang[i]='';
      });
      const rows=[...tbl.rows].slice(header.length?1:0);
      rows.forEach(tr=>{
        if(tr.querySelector('.subcategory')?.getAttribute('colspan')) return;
        [...tr.cells].forEach((td,i)=>{
          if(colLang[i]==='en' || colLang[i]==='es'){
            if(!td.querySelector('.tts-line-btn')){
              const btn=document.createElement('button');
              btn.type='button'; btn.className='tts-line-btn'; btn.dataset.tts=colLang[i]; btn.textContent='ðŸ”Š';
              td.insertBefore(btn,td.firstChild);
              btn.addEventListener('click', async e=>{
                e.stopPropagation(); await Speech.ensureVoices();
                const text=[...td.childNodes].filter(n=>!(n.nodeType===1 && n.classList?.contains('tts-line-btn'))).map(n=>n.textContent).join('').trim();
                Speech.speak(text,colLang[i]);
              });
            }
          }
        });
      });
    });
  }

  // Utility: ensure no literal </script> sneaks into our page while building prompt strings
  const escapeScriptEnd = s => s.replace(/<\/script>/gi, '<\\/script>');

  // â€”â€”â€”â€”â€” Vocabulary â€”â€”â€”â€”â€”
  (function setupVocab(){
    const el=$('gen-vocab');
    el.innerHTML=`
      <div class="fcs-card">
        <h2>Vocabulary Creator</h2>
        <div class="grid">
          <div class="six"><label for="v-topic">Topic</label><input id="v-topic" type="text" placeholder="e.g., At the Airport"></div>
          <div class="six"><label for="v-level">Level</label>
            <select id="v-level">
              <option value="1" selected>Level 1 â€” Survival</option>
              <option value="2">Level 2 â€” Beginner</option>
              <option value="3">Level 3 â€” Intermediate</option>
              <option value="4">Level 4 â€” Conversational</option>
              <option value="5">Level 5 â€” Fluent</option>
            </select>
          </div>
          <div class="six">
            <label for="v-tmode">Total Words Mode</label>
            <select id="v-tmode"><option value="default" selected>Preset by Level</option><option value="custom">Custom</option></select>
            <div id="v-presetText" class="hint"></div>
          </div>
          <div class="six">
            <div class="grid">
              <div class="six"><label for="v-tmin">Min</label><input id="v-tmin" type="number" min="1" disabled></div>
              <div class="six"><label for="v-tmax">Max</label><input id="v-tmax" type="number" min="1" disabled></div>
            </div>
          </div>
          <div class="twelve">
            <label for="v-vocab-include">Vocabulary to Include (optional)</label>
            <textarea id="v-vocab-include" rows="3" placeholder="Paste a full or partial list of words to include..."></textarea>
          </div>
        </div>
        <div class="actions">
          <button id="v-gen" class="primary">Generate Vocabulary</button>
          <button id="v-excel">Download Excel</button>
          <button id="v-copy">Copy</button>
          <div id="v-status" class="status"></div>
        </div>
      </div>
      <div id="v-output" class="output-container"><p>Your list will appear here...</p></div>`;

    const genBtn=$('v-gen'), statusEl=$('v-status'), outputEl=$('v-output'),
      levelEl=$('v-level'), tmodeEl=$('v-tmode'), tminEl=$('v-tmin'), tmaxEl=$('v-tmax'),
      presetTextEl=$('v-presetText'), topicEl=$('v-topic'), vocabIncludeEl=$('v-vocab-include');

    const preset={"1":{min:35,max:55},"2":{min:60,max:85},"3":{min:90,max:120},"4":{min:120,max:180},"5":{min:160,max:240}};
    const levelNames={"1":"Level 1â€”Survival","2":"Level 2â€”Beginner","3":"Level 3â€”Intermediate","4":"Level 4â€”Conversational","5":"Level 5â€”Fluent"};
    const updateUI=()=>{
      const custom=tmodeEl.value==='custom', r=preset[levelEl.value];
      tminEl.disabled=!custom; tmaxEl.disabled=!custom;
      if(!custom){ tminEl.value=r.min; tmaxEl.value=r.max; }
      presetTextEl.textContent=`Preset for ${levelNames[levelEl.value]}: ${r.min}â€“${r.max} words.`;
    };
    tmodeEl.addEventListener('change',updateUI); levelEl.addEventListener('change',updateUI); updateUI();

    genBtn.addEventListener('click', async ()=>{
      if(!topicEl.value.trim()){ statusEl.textContent="Please enter a topic."; return; }
      statusEl.textContent="Generatingâ€¦";

      const r=preset[levelEl.value];
      const min = tmodeEl.value==='custom' ? (Number(tminEl.value)||r.min) : r.min;
      const max = tmodeEl.value==='custom' ? (Number(tmaxEl.value)||r.max) : r.max;

      const prompt = `
<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vocabulary â€” ${topicEl.value}</title>
<style>
  body { font-family: Calibri, Arial, sans-serif; font-size: 10pt; margin:0; padding:18px;}
  h1,h2{ text-align:center; }
  table{ border-collapse:collapse; width:100%; margin-top:12px;}
  th,td{ border:1px solid #ccc; padding:6px; vertical-align:top;}
  th{ background:#f4f4f4;}
  .en{ color:#1a73e8; font-weight:bold;}
  .es{ color:#d93025; font-weight:bold;}
  .subcategory{ background:#e8edf7; font-weight:bold; text-align:left;}
  .note{ font-size:9pt; color:#666; text-align:center;}
  /* section tints */
  .sec-noun .subcategory{ background: #dff2ff;}
  .sec-verb .subcategory{ background: #e8fbe8;}
  .sec-desc .subcategory{ background: #fff5cc;}
  .sec-phr  .subcategory{ background: #fae8ff;}
  .sec-ques .subcategory{ background: #ffe4e6;}
</style>
<body>
  <h1>${topicEl.value} â€” ${levelNames[levelEl.value]}</h1>
  <p class="note">English is <span class="en">blue</span>; Spanish is <span class="es">red</span>. Use full sentences. Alphabetize by English.</p>

  <div class="sec-noun">
    <h2>Nouns / Sustantivos</h2>
    <table><thead><tr><th>English</th><th>EspaÃ±ol</th><th>Definition / Example</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="sec-verb">
    <h2>Verbs / Verbos</h2>
    <table><thead><tr><th>English</th><th>EspaÃ±ol</th><th>Definition / Example</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="sec-desc">
    <h2>Descriptive Words / Palabras descriptivas</h2>
    <table><thead><tr><th>English</th><th>EspaÃ±ol</th><th>Definition / Example</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="sec-phr">
    <h2>Common Phrases / Frases comunes</h2>
    <table><thead><tr><th>English</th><th>EspaÃ±ol</th><th>Meaning / Example</th></tr></thead><tbody></tbody></table>
  </div>
  <div class="sec-ques">
    <h2>Common Questions / Preguntas comunes</h2>
    <table><thead><tr><th>English</th><th>EspaÃ±ol</th><th>Sample Answer</th></tr></thead><tbody></tbody></table>
  </div>

  <h2>Counts Summary</h2>
  <table><thead><tr><th>Category</th><th>Count</th></tr></thead>
    <tbody>
      <tr><td>Nouns</td><td></td></tr>
      <tr><td>Verbs</td><td></td></tr>
      <tr><td>Descriptive</td><td></td></tr>
      <tr><td>Phrases</td><td></td></tr>
      <tr><td>Questions</td><td></td></tr>
      <tr><td><strong>Total Core (N+V+D)</strong></td><td></td></tr>
    </tbody>
  </table>

  <script id="manifest" type="application/json">
  {"topic": ${JSON.stringify(topicEl.value)}, "level": ${JSON.stringify(levelEl.value)}, "min": ${min}, "max": ${max}, "include": ${JSON.stringify(vocabIncludeEl.value)}}
  <\/script>
</body></html>`;
      try{
        const safe = escapeScriptEnd(prompt);
        const html = await callAPI(safe);
        outputEl.innerHTML = html;
        statusEl.textContent = "Done.";
        await Speech.ensureVoices();
        addTTSButtons(outputEl);
      }catch(err){
        outputEl.innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
        statusEl.textContent = "Error.";
      }
    });

    $('v-copy').addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    $('v-excel').addEventListener('click',()=>{
      const name = ($('v-topic').value.trim() || 'Vocabulary');
      downloadAsExcel(outputEl,statusEl,name);
    });
  })();

  // â€”â€”â€”â€”â€” Conversation â€”â€”â€”â€”â€”
  (function setupConvo(){
    const c=$('gen-convo');
    c.innerHTML=`
      <div class="fcs-card"><h2>Conversation Creator</h2>
        <div class="grid grid-2">
          <div class="twelve"><label for="c-topic">Topic</label><input id="c-topic" type="text" placeholder="e.g., A funny story about a vacation"/></div>
          <div class="six"><label>Level (Grammar)</label>
            <select id="c-level">
              <option value="1" selected>Level 1 â€” Survival</option>
              <option value="2">Level 2 â€” Beginner</option>
              <option value="3">Level 3 â€” Intermediate</option>
              <option value="4">Level 4 â€” Conversational</option>
              <option value="5">Level 5 â€” Fluent</option>
            </select></div>
          <div class="twelve"><label for="c-vocab">Vocabulary (optional)</label><textarea id="c-vocab" rows="6" placeholder="Put your own vocabulary here..."></textarea></div>
          <div class="six"><label>Number of Conversations</label><input id="c-numConvos" type="number" value="2"/></div>
          <div class="six"><label># of Speakers</label><input id="c-numSpeakers" type="number" value="2"/></div>
          <div class="six"><label>Minutes</label><input id="c-minutes" type="number" value="5"/></div>
          <div class="six"><label>Turns</label><input id="c-turns" type="number" value="10"/></div>
          <div class="six"><label>Tone</label><select id="c-tone"><option>Neutral, casual</option><option>Informal, friendly</option><option>Instructor, student</option><option>Customer, staff</option><option>Professional, formal</option><option>Street slang</option></select></div>
          <div class="six"><label>Country / Region</label><select id="c-country"></select></div>
          <div class="six"><label>Include English Translation</label><select id="c-includeEN"><option value="yes" selected>Yes</option><option value="no">No</option></select></div>
          <div class="six"><label>Add Fill-In-The-Blank</label><select id="c-addFib"><option value="no">No</option><option value="yes" selected>Yes</option></select></div>
          <div class="six"><label>FIB Focus</label><select id="c-fibFocus"><option>Mixed</option><option>Vocab only</option><option>Grammar only</option><option>Verbs only</option></select></div>
          <div class="six"><label>Show FIB Answer Key</label><select id="c-showFIBKey"><option value="yes">Yes</option><option value="no">No</option></select></div>
          <div class="six"><label>Show Vocabulary List</label><select id="c-showVocabList"><option value="yes">Yes</option><option value="no">No</option></select></div>
          <div class="twelve"><label>Optional Teacher Notes</label><textarea id="c-notes" rows="4"></textarea></div>
        </div>
        <div class="actions"><button id="c-gen" class="primary">Generate</button><button id="c-excel">Excel</button><button id="c-copy">Copy</button><div id="c-status" class="status"></div></div>
      </div>
      <div id="c-output" class="output-container"><p>Your conversation appears here...</p></div>`;

    const countrySelect=$('c-country');
    const countries=["-no specific-","Argentina","Bolivia","Chile","Colombia","Costa Rica","Cuba","Dominican Republic","Ecuador","El Salvador","Equatorial Guinea","Guatemala","Honduras","Mexico","Nicaragua","Panama","Paraguay","Peru","Puerto Rico","Spain","Uruguay","Venezuela"];
    countrySelect.innerHTML=countries.map(c=>`<option>${c}</option>`).join('');

    const genBtn=$('c-gen'), statusEl=$('c-status'), outputEl=$('c-output');

    genBtn.addEventListener('click', async ()=>{
      if(!$('c-topic').value.trim()){ statusEl.textContent="Enter a topic."; return; }
      statusEl.textContent="Generatingâ€¦";
      const fibCount=Math.max(8,Math.min(20, Math.round(Number($('c-turns').value)*0.8)));
      const manifest={
        numConvos:Number($('c-numConvos').value),
        speakers:Number($('c-numSpeakers').value),
        turns:Number($('c-turns').value),
        minutes:Number($('c-minutes').value),
        tone:$('c-tone').value,
        country:$('c-country').value,
        includeEN:$('c-includeEN').value,
        addFIB:$('c-addFib').value,
        fibFocus:$('c-fibFocus').value,
        showFIBKey:$('c-showFIBKey').value,
        showVocabList:$('c-showVocabList').value,
        customVocab:$('c-vocab').value.trim(),
        notes:$('c-notes').value.trim()
      };
      const prompt=`
<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conversation â€” ${$('c-topic').value}</title>
<body>
<h1>Conversation: ${$('c-topic').value} â€” Level ${$('c-level').value}</h1>
<p>English vocab must be <span class="en" style="color:#1a73e8;font-weight:bold">blue</span>; Spanish vocab <span class="es" style="color:#d93025;font-weight:bold">red</span>. Fill Dialogue, Practice, Vocabulary Used, and Answer Key (if requested). No blanks in dialogues.</p>
<div id="dialogues"></div>
<div id="practice"></div>
<div id="vocab"></div>
<div id="key"></div>
<script id="manifest" type="application/json">${JSON.stringify(manifest)}<\/script>
</body></html>`;
      try{
        const safe = escapeScriptEnd(prompt);
        const html=await callAPI(safe);
        outputEl.innerHTML=html;
        statusEl.textContent="Done.";
        await Speech.ensureVoices(); addTTSButtons(outputEl);
      }catch(err){
        outputEl.innerHTML=`<p style="color:red;">Error: ${err.message}</p>`;
        statusEl.textContent="Error.";
      }
    });

    $('c-copy').addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    $('c-excel').addEventListener('click', ()=>downloadAsExcel(outputEl,statusEl,$('c-topic').value||'Conversation'));
  })();

  // â€”â€”â€”â€”â€” Test â€”â€”â€”â€”â€”
  (function setupTest(){
    const t=$('gen-test');
    t.innerHTML=`
      <div class="fcs-card"><h2>Test Creator</h2>
        <div><label for="t-vocab">Vocabulary List</label><textarea id="t-vocab" rows="6" placeholder="Paste the EXACT vocabulary for the test..."></textarea></div>
        <div><label for="t-level">Level (Grammar)</label>
          <select id="t-level">
            <option value="1" selected>Level 1 â€” Survival</option>
            <option value="2">Level 2 â€” Beginner</option>
            <option value="3">Level 3 â€” Intermediate</option>
            <option value="4">Level 4 â€” Conversational</option>
            <option value="5">Level 5 â€” Fluent</option>
          </select></div>
        <div><label><input type="checkbox" id="t-anskeys" checked> Include Teacher Answer Keys?</label></div>
        <div class="actions"><button id="t-gen" class="primary">Generate</button><button id="t-excel">Excel</button><button id="t-copy">Copy</button><div id="t-status" class="status"></div></div>
      </div>
      <div id="t-output" class="output-container"><p>Your test will appear here...</p></div>`;

    const genBtn=$('t-gen'), statusEl=$('t-status'), outputEl=$('t-output');

    genBtn.addEventListener('click', async ()=>{
      const vocab=$('t-vocab').value.trim();
      if(!vocab){ statusEl.textContent="Please paste a vocab list."; return; }
      statusEl.textContent="Generatingâ€¦";
      const prompt=`
<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Test â€” Level ${$('t-level').value}</title>
<body>
<h1>FCS Conversation Test â€” Level ${$('t-level').value}</h1>
<p>Use ONLY provided vocabulary. When vocab appears inline, English is <span class="en" style="color:#1a73e8;font-weight:bold">blue</span>, Spanish is <span class="es" style="color:#d93025;font-weight:bold">red</span>.</p>
<div id="part1"></div><div id="part2"></div><div id="part3"></div><div id="answers"></div>
<script id="manifest" type="application/json">
{"level":"${$('t-level').value}","anskeys":${$('t-anskeys').checked},"vocab":${JSON.stringify(vocab)}}
<\/script>
</body></html>`;
      try{
        const safe = escapeScriptEnd(prompt);
        const html=await callAPI(safe);
        outputEl.innerHTML=html;
        statusEl.textContent="Done.";
        await Speech.ensureVoices(); addTTSButtons(outputEl);
      }catch(err){
        outputEl.innerHTML=`<p style="color:red;">Error: ${err.message}</p>`;
        statusEl.textContent="Error.";
      }
    });

    $('t-copy').addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    $('t-excel').addEventListener('click', ()=>downloadAsExcel(outputEl,statusEl,'Test'));
  })();

  // â€”â€”â€” Helpers â€”â€”â€”
  function copyToClipboard(container,statusEl){
    if(!container.innerHTML || container.innerText.includes("will appear here")){
      statusEl.textContent="Nothing to copy."; return;
    }
    navigator.clipboard.writeText(container.innerText).then(()=>statusEl.textContent="Copied!",()=>statusEl.textContent="Copy failed.");
  }
  function downloadAsExcel(container,statusEl,filename){
    if(!container.querySelector("table")){statusEl.textContent="No data to export.";return}
    try{
      statusEl.textContent="Creating Excel...";
      const wb=XLSX.utils.book_new(), rows=[], title=container.querySelector("h1")?.innerText||filename;
      rows.push([title]); rows.push([]);
      container.querySelectorAll("h2, table").forEach(el=>{
        if(el.tagName==="H2") rows.push([el.innerText]);
        if(el.tagName==="TABLE"){
          el.querySelectorAll("tr").forEach(tr=>{
            const line=Array.from(tr.querySelectorAll("th, td")).map(td=>td.innerText); rows.push(line);
          });
          rows.push([]);
        }
      });
      const ws=XLSX.utils.aoa_to_sheet(rows);
      ws["!cols"]=rows.reduce((acc,row)=>{row.forEach((cell,i)=>{const w=cell?cell.toString().length+2:10; if(!acc[i]||acc[i].wch<w) acc[i]={wch:w}}); return acc;},[]);
      XLSX.utils.book_append_sheet(wb,ws,"Generated Content");
      XLSX.writeFile(wb,`${(filename||'Export').replace(/\s+/g,"_")}.xlsx`);
      statusEl.textContent="Download started.";
    }catch(e){statusEl.textContent="Failed to create Excel."}
  }
})();
</script>
</body>
</html>
