<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>FCS AI Generator Suite</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  :root { --bg:#f7f9fc; --fg:#111; --muted:#667085; --border:#e5e7eb; --panel:#ffffff; --accent:#0b5cff;
          --en:#1a73e8; --es:#d93025; --head:#0f172a; }
  body { background: var(--bg); color: var(--fg); font-family: Calibri, Arial, sans-serif; font-size: 15px; margin:0; }
  .fcs-wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
  h1 { font-size: 28px; font-weight:700; text-align:center; margin-bottom: 28px; color: var(--head); }
  h2 { font-size: 20px; font-weight:700; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; color: var(--head); }
  .fcs-card { border:1px solid var(--border); border-radius: 12px; padding: 24px; background:var(--panel); margin-bottom: 20px; }
  label { font-weight: 600; font-size: 14px; display: block; margin-bottom: 6px; }
  input[type="text"], select, input[type="number"], textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size:15px; box-sizing:border-box; }
  input:disabled { background-color: #f8f9fa; }
  .hint, .small { font-size: 12px; color: var(--muted); margin-top: 4px; }
  button { padding: 10px 16px; border-radius: 8px; border:1px solid var(--border); background:#f6f8fb; cursor: pointer; font-weight: 600; font-size:15px; transition: all 0.2s; }
  button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
  button:disabled { cursor: not-allowed; opacity: 0.6; }
  .fcs-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  .fcs-tab-btn { flex-grow: 1; text-align: center; } .fcs-generator { display: none; } .fcs-generator.active { display: block; }
  .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; align-items: end; }
  .six { grid-column: span 6; } .twelve { grid-column: span 12; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; } .grid-full { grid-column: 1 / -1; }
  .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top:20px; align-items:center; }
  .status { margin-top:10px; min-height:1.5em; text-align:left; color:var(--muted); font-size:13px; }
  .output-container { border:1px solid var(--border); border-radius:12px; padding:24px; background:#fff; min-height: 240px; margin-top:12px; }
  .output-container h1, .output-container h2 { text-align: center; color: #0f172a !important; }
  .output-container table { width:100%; border-collapse: separate; border-spacing: 0; margin-top: 12px; font-size:10pt;}
  .output-container th, .output-container td { border:1px solid #e5e7eb; padding:8px; vertical-align:top; }
  .output-container th { background: #f5f7fb; }
  .output-container tr:nth-child(even) td { background: #fafafa; }
  .output-container .en { color: var(--en); font-weight: bold; }
  .output-container .es { color: var(--es); font-weight: bold; }
  .output-container .full-black { color: var(--fg); font-weight: 700; }

  .tts-line-btn { display:inline-flex; align-items:center; gap:4px; padding:2px 6px; margin-right:6px; border:1px solid #dbe2ef;
    border-radius:999px; background:#eef2ff; cursor:pointer; font-size:12px; line-height:1; }
  .tts-line-btn[data-tts="es"] { background:#fdeaea; border-color:#f5c2c7; }
  .tts-line-btn:hover { filter:brightness(0.98); }

  .conv-ctrls { display:flex; gap:8px; align-items:center; margin:6px 0 10px; }
  .conv-ctrls button { padding:6px 10px; font-size:12px; }

  @media (max-width: 860px){ .six, .twelve { grid-column: span 12; } .grid-2{grid-template-columns:1fr;} }
</style>
</head>
<body>
<div class="fcs-wrap">
  <h1>FCS AI GENERATOR SUITE</h1>
  <div class="fcs-tabs">
    <button id="tab-vocab" class="fcs-tab-btn primary">Vocabulary</button>
    <button id="tab-convo" class="fcs-tab-btn">Conversation</button>
    <button id="tab-test" class="fcs-tab-btn">Test</button>
  </div>

  <div id="gen-vocab" class="fcs-generator active"></div>
  <div id="gen-convo" class="fcs-generator"></div>
  <div id="gen-test" class="fcs-generator"></div>
</div>

<script>
"use strict";
(function(){
  const $=id=>document.getElementById(id);
  const API_URL="/api/index";

  /* Tabs */
  (function initTabs(){
    const t=document.querySelectorAll(".fcs-tab-btn"), e=document.querySelectorAll(".fcs-generator");
    t.forEach(o=>{o.addEventListener("click",()=>{const n=o.id.replace("tab-","gen-");t.forEach(t=>t.classList.remove("primary")),o.classList.add("primary"),e.forEach(t=>{t.style.display=t.id===n?"block":"none"})})})
  })();

  async function callAPI(prompt){
    const resp=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})});
    const json=await resp.json();
    if(!resp.ok) throw new Error(json.details||json.error||"Unknown server error.");
    return json.content;
  }

  async function generateSimple(basePrompt, button, statusEl, outputEl){
    try{
      button.disabled=true;
      statusEl.textContent="Generating...";
      outputEl.innerHTML="<h4>Please wait. AI is working...</h4>";
      const html = await callAPI(basePrompt);
      outputEl.innerHTML = html;
      statusEl.textContent = "Done.";
    }catch(err){
      console.error(err);
      statusEl.textContent = "Generation failed.";
    }finally{
      button.disabled=false;
    }
  }

  function downloadAsExcel(container,statusEl,filename){
    try{
      const firstTable = container.querySelector("table");
      if(!firstTable){ statusEl.textContent="No data to export."; return; }
      statusEl.textContent="Creating Excel...";
      const wb=XLSX.utils.book_new(), rows=[], title=container.querySelector("h1")?container.querySelector("h1").innerText:(filename||'Export');
      rows.push([title]); rows.push([]);
      container.querySelectorAll("h2, table").forEach(el=>{
        if(el.tagName==="H2"){ rows.push([el.innerText]); }
        if(el.tagName==="TABLE"){
          el.querySelectorAll("tr").forEach(tr=>{
            const line=Array.from(tr.querySelectorAll("th, td")).map(td=>td.innerText);
            rows.push(line);
          });
          rows.push([]);
        }
      });
      const ws=XLSX.utils.aoa_to_sheet(rows);
      ws["!cols"]=rows.reduce((acc,row)=>{row.forEach((cell,i)=>{const w=(cell?cell.toString():"").length+2; if(!acc[i]||acc[i].wch<w) acc[i]={wch:w}}); return acc;},[]);
      XLSX.utils.book_append_sheet(wb,ws,"Generated Content");
      XLSX.writeFile(wb,`${(filename||'Export').replace(/\s+/g,"_")}.xlsx`);
      statusEl.textContent="Download started.";
    }catch(e){ console.error("Excel Error:",e); statusEl.textContent="Failed to create Excel."; }
  }

  function copyToClipboard(container,statusEl){
    try{
      const txt = container.innerText.trim();
      if(!txt){ statusEl.textContent="Nothing to copy."; return; }
      navigator.clipboard.writeText(txt).then(
        ()=>statusEl.textContent="Copied!",
        ()=>{
          const t=document.createElement("textarea");
          t.value=txt; document.body.appendChild(t); t.select();
          try{ document.execCommand("copy") ? statusEl.textContent="Copied!" : statusEl.textContent="Copy failed."; }
          catch(e){ statusEl.textContent="Copy failed."; }
          document.body.removeChild(t);
        }
      );
    }catch(e){ statusEl.textContent="Copy failed."; }
  }
  function copyText(text,statusEl){
    const t=(text||"").trim();
    if(!t){ statusEl.textContent="Nothing to copy."; return; }
    navigator.clipboard.writeText(t).then(
      ()=>statusEl.textContent="Prompt copied!",
      ()=>{
        const ta=document.createElement("textarea");
        ta.value=t; document.body.appendChild(ta); ta.select();
        try{ document.execCommand("copy") ? statusEl.textContent="Prompt copied!" : statusEl.textContent="Copy failed."; }
        catch(e){ statusEl.textContent="Copy failed."; }
        document.body.removeChild(ta);
      }
    );
  }

  /* ===== Level rules (used ONLY by Conversation) ===== */
  function getLevelRulesLines(level){
    switch(String(level)){
      case '1':
        return ['LEVEL 1 — Survival (≈ CEFR A1) (MUST FOLLOW):','• Basic present tense; ser/estar recognition; simple WH- questions.','• Glue words: y, o, pero, porque; prepositions: a, en, de, con.','• Concrete everyday vocabulary only.'];
      case '2':
        return ['LEVEL 2 — Beginner (≈ CEFR A2) (MUST FOLLOW):','• Present tense production; tener que, necesitar, querer, ir a, poder, acabar de, gustar.','• Ser vs. estar; simple object pronouns; reflexives with regular verbs.','• Polite conditional with poder/gustar/deber; basic time words.'];
      case '3':
        return ['LEVEL 3 — Intermediate (≈ CEFR B1) (MUST FOLLOW):','• Pretérito + imperfecto; present progressive.','• Narrative sequencing (primero, después, luego, finalmente).','• Add comparisons and richer connectors.'];
      case '4':
        return ['LEVEL 4 — Conversational (≈ CEFR B2) (MUST FOLLOW):','• Simple future & conditional; present perfect & present perfect progressive.','• All uses of “se”.','• Nuanced connectors (aunque, sin embargo, por lo tanto).'];
      case '5':
        return ['LEVEL 5 — Fluent (≈ CEFR C1) (MUST FOLLOW):','• Imperatives; subjunctive (present/past) where required.','• Expanded progressives & perfects; persuasion and hedging.','• Complex discourse markers (aun así, por ende, no obstante).'];
      case '6':
        return ['LEVEL 6 — Native (≈ CEFR C2) (MUST FOLLOW):','• Native-like register and idioms; precise aspect & mood.','• Cohesive devices across long discourse; subtle pragmatics.','• Still obey UI constraints.'];
      default: return [];
    }
  }

  /* =========================
     Vocabulary (NO LEVELS — only Word Count Plan)
     ========================= */
  (function setupVocab(){
    const vocabUI =
      `<div class="fcs-card">
        <h2>Vocabulary Creator</h2>
        <div class="grid">
          <div class="six"><label for="v-topic">Topic</label><input id="v-topic" type="text" placeholder="e.g., At the Airport"></div>

          <div class="six"><label for="v-plan">Word Count Plan</label>
            <select id="v-plan">
              <option value="1" selected>Word Count 1</option>
              <option value="2">Word Count 2</option>
              <option value="3">Word Count 3</option>
              <option value="4">Word Count 4</option>
              <option value="5">Word Count 5</option>
              <option value="custom">Custom</option>
            </select>
            <div id="v-presetText" class="hint"></div>
          </div>

          <div class="twelve">
            <label>Sections to Include (multi-select)</label>
            <div id="v-sections" style="display:flex; flex-wrap:wrap; gap:14px;">
              <label><input type="checkbox" id="v-sec-all" checked> All</label>
              <label><input type="checkbox" class="v-sec" value="nouns" checked> Nouns</label>
              <label><input type="checkbox" class="v-sec" value="verbs" checked> Verbs</label>
              <label><input type="checkbox" class="v-sec" value="adjectives" checked> Adjectives</label>
              <label><input type="checkbox" class="v-sec" value="adverbs" checked> Adverbs</label>
              <label><input type="checkbox" class="v-sec" value="phrases" checked> Common Phrases</label>
              <label><input type="checkbox" class="v-sec" value="questions" checked> Common Questions</label>
            </div>
            <div class="hint">Uncheck to generate only the sections you need. “All” toggles everything.</div>
          </div>

          <div class="six">
            <div class="grid">
              <div class="six"><label for="v-tmin">Min (custom)</label><input id="v-tmin" type="number" min="1" max="300" disabled></div>
              <div class="six"><label for="v-tmax">Max (custom)</label><input id="v-tmax" type="number" min="1" max="300" disabled></div>
            </div>
          </div>

          <div class="twelve">
            <label for="v-vocab-include">Vocabulary to Include (optional)</label>
            <textarea id="v-vocab-include" rows="3" placeholder="Paste a full or partial list of words to include..."></textarea>
          </div>
        </div>
        <div class="actions">
          <button id="v-gen" class="primary">Generate Vocabulary</button>
          <button id="v-excel">Download Excel</button>
          <button id="v-copy">Copy</button>
          <button id="v-prompt">Prompt</button>
          <div id="v-status" class="status"></div>
        </div>
      </div>
      <div id="v-output" class="output-container"><p>Your list will appear here...</p></div>`;
    $('gen-vocab').innerHTML=vocabUI;

    const genBtn=$('v-gen'),excelBtn=$('v-excel'),copyBtn=$('v-copy'),promptBtn=$('v-prompt'),statusEl=$('v-status'),outputEl=$('v-output'),
          planEl=$("v-plan"),tminEl=$("v-tmin"),tmaxEl=$("v-tmax"),
          presetTextEl=$("v-presetText"),topicEl=$("v-topic"),vocabIncludeEl=$("v-vocab-include");

    const allBox = $('v-sec-all');
    const childBoxes = Array.from(document.querySelectorAll('.v-sec'));
    function setChildren(checked){ childBoxes.forEach(b=>b.checked=checked); }
    function syncAll(){ allBox.checked = childBoxes.every(b=>b.checked); }
    allBox.addEventListener('change', ()=> setChildren(allBox.checked));
    childBoxes.forEach(b=> b.addEventListener('change', syncAll));
    function selectedSections(){
      if (allBox.checked) return ['nouns','verbs','adjectives','adverbs','phrases','questions'];
      const vals = childBoxes.filter(b=>b.checked).map(b=>b.value);
      return vals.length ? vals : ['nouns','verbs','adjectives','adverbs','phrases','questions'];
    }

    // WORD COUNT PLANS ONLY (no levels referenced here)
    const presetRanges={
      "1":{min:33,max:55},
      "2":{min:60,max:85},
      "3":{min:90,max:120},
      "4":{min:160,max:220},
      "5":{min:210,max:280}
    };

    function updateUI(){
      const isCustom=planEl.value==='custom';
      tminEl.disabled=!isCustom; tmaxEl.disabled=!isCustom;
      if(!isCustom){
        const r=presetRanges[planEl.value];
        tminEl.value=r.min; tmaxEl.value=r.max;
        presetTextEl.textContent=`Preset for Word Count ${planEl.value}: ${r.min}–${r.max} total Spanish vocabulary items (target upper bound).`;
      }else{
        presetTextEl.textContent=`Custom: set Min/Max (1–300).`;
      }
    }
    planEl.addEventListener('change',updateUI); updateUI();

    /* ---------- PROMPT (the exact text you copy to ChatGPT) — NO LEVELS ---------- */
    function buildVocabInstruction(){
      let minCount, maxCount;
      if (planEl.value==='custom'){
        minCount = Math.max(1, Math.min(300, Number(tminEl.value) || 1));
        maxCount = Math.max(minCount, Math.min(300, Number(tmaxEl.value) || minCount));
      } else {
        const r = presetRanges[planEl.value];
        minCount = r.min; maxCount = r.max;
      }
      const topic = (topicEl.value || '').trim();

      return [
`You are an expert assistant for the FCS program.`,
`Topic: “${topic}”.`,
`Vocabulary range: ${minCount}–${maxCount} distinct Spanish vocabulary words (target the upper bound).`,
``,
`Requirements:`,
``,
`Organize the output into 7 parts:`,
``,
`1. Nouns`,
``,
`Present as bold article + noun (English & Spanish).`,
``,
`Subdivision rule:`,
``,
`If there are more than 20 nouns, subdivide into logical thematic categories (e.g., Nouns — Equipment, Nouns — People, Nouns — Places).`,
``,
`If there are 20 nouns or fewer, keep in a single block.`,
``,
`Alphabetize English terms within each category.`,
``,
`All nouns must be relevant to the chosen topic.`,
``,
`2. Verbs in Sentences`,
``,
`Always third-person sentences in English with “is/are going + to + verb.”`,
``,
`Reflexive verbs must place pronoun after the infinitive (e.g., va a descansarse).`,
``,
`Bold “to + verb” in English and the infinitive in Spanish.`,
``,
`Sentences must include a mixture of three types (but do not label them in the output):`,
``,
`Sentences where nouns from Part 1 are the objects.`,
``,
`Sentences where nouns from Part 1 are the subjects.`,
``,
`Sentences with no nouns from Part 1, only 3rd person subject (he/she/it/they) but still relevant to the topic.`,
``,
`All verbs must be relevant to the topic or topic situations.`,
``,
`3. Adjectives`,
``,
`Sentences pairing nouns from Part 1 with “is/are + adjective.”`,
``,
`Only the adjective should be bold, not the noun.`,
``,
`Each major noun must be shown with two or more adjectives, often opposites or related pairs (e.g., The water is cold / The water is warm).`,
``,
`Adjectives must be relevant to the topic.`,
``,
`4. Adverbs`,
``,
`Sentences reusing verbs from Part 2, each modified with an adverb.`,
``,
`Only the adverb should be bold, not the verb or noun.`,
``,
`Adverbs must be appropriate for describing the topic.`,
``,
`5. Common Phrases`,
``,
`Whole phrase in English only in the left column, Spanish only in the right column.`,
``,
`All phrases must be common expressions in the topic.`,
``,
`6. Common Questions`,
``,
`Whole question in English only in the left column, Spanish only in the right column.`,
``,
`Do not include answers.`,
``,
`All questions must be relevant to the topic.`,
``,
`7. Full Vocabulary Index`,
``,
`List all nouns, verbs, adjectives, adverbs, phrases, and questions.`,
``,
`Alphabetized in groups.`,
``,
`Present in a two-column Markdown table (English | Español).`,
``,
`Each vocabulary item in bold in both English & Spanish.`,
``,
`Do not include sentences here — just the word or phrase.`,
``,
`Formatting Rules`,
``,
`Use Markdown tables for Parts 1–7.`,
``,
`English on left, Spanish on right.`,
``,
`No HTML.`,
``,
`Alphabetize English terms within each section.`,
``,
`Ensure the total vocabulary count (Nouns + Verbs + Adjectives + Adverbs + Phrases + Questions) is within the requested range.`,
``,
`All vocabulary, sentences, phrases, and questions must be clearly relevant to the topic.`
      ].join('\n');
    }

    /* ---- HTML generation prompt (renders same content as the copied prompt) ---- */
    function buildVocabPrompt(){
      const rawPrompt = buildVocabInstruction();
      const topic = (topicEl.value || '').trim();

      return `<!DOCTYPE html>
<!-- FCS VOCABULARY OUTPUT
  IMPORTANT CONTRACT TO THE MODEL:
  First internally answer the following (Markdown) prompt EXACTLY as ChatGPT would.
  THEN render the SAME content (words, counts, organization, section titles) as styled HTML.

  ===== THE ORIGINAL PROMPT YOU MUST FOLLOW (for content parity) =====
${rawPrompt}

  ===== HTML RENDERING RULES =====
  • Create 7 .section blocks in this exact order with <h2> titles:
    1) Nouns
    2) Verbs in Sentences
    3) Adjectives
    4) Adverbs
    5) Common Phrases
    6) Common Questions
    7) Full Vocabulary Index
  • Each section uses one table (.tbl) with exactly two columns: <th>English</th> | <th lang="es">Español</th>.
  • Nouns: list nouns (no sentences). If >20 nouns, insert bold subcategory header rows INSIDE the same table as:
      <tr class="subcat"><td colspan="2"><strong>Nouns — [Category EN] / [Categoría ES]</strong></td></tr>
    Spanish noun in each row MUST be wrapped in <span class="es">…</span> (red).
  • Verbs in Sentences: write English as He/She/It/They “is/are going to” + <span class="en">to + verb</span>;
    Spanish uses the equivalent perífrasis and wraps the infinitive with <span class="es">…</span>.
  • Adjectives: sentences “is/are + adjective”. Highlight ONLY the adjective with one <span class="en">…</span> (EN) and one <span class="es">…</span> (ES).
  • Adverbs: sentences reuse verbs from Part 2; highlight ONLY the adverb with one <span class="en">…</span> and one <span class="es">…</span>.
  • Common Phrases & Common Questions: full cells (no extra coloring spans).
  • Full Vocabulary Index: two-column table of just the words/phrases (no sentences). Each item is <strong>bold</strong> in both columns.
  • Alphabetize English within each section (and within each noun subcategory).
  • Keep Spanish vocabulary total within the requested range; target the upper bound.
-->
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vocabulary — ${topic}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a;}
  *{box-sizing:border-box} body{font-family:Calibri,Arial,sans-serif;font-size:10pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:14px;overflow-x:auto}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:6px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700} .es{color:var(--es);font-weight:700}
  .full-black{color:var(--ink);font-weight:700}
  @media(max-width:700px){ .tbl{font-size:9pt;width:auto} }
</style>
</head>
<body><div class="fcs-doc" lang="en">
  <h1>Vocabulary: ${topic}</h1>

  <div class="section"><h2>Nouns</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Español</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="section"><h2>Verbs in Sentences</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Español</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="section"><h2>Adjectives</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Español</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="section"><h2>Adverbs</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Español</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="section"><h2>Common Phrases</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Español</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="section"><h2>Common Questions</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Español</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="section"><h2>Full Vocabulary Index</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Español</th></tr></thead><tbody></tbody></table>
  </div>

</div></body></html>`;
    }

    /* ---- Buttons ---- */
    $('v-gen').addEventListener('click', async ()=>{
      if(!topicEl.value.trim()){ $('v-status').textContent="Please enter a topic."; return; }
      const prompt = buildVocabPrompt();
      await generateSimple(prompt, $('v-gen'), $('v-status'), $('v-output'));
    });

    $('v-prompt').addEventListener('click', ()=>{
      if(!topicEl.value.trim()){ $('v-status').textContent="Please enter a topic."; return; }
      const instruction = buildVocabInstruction();
      copyText(instruction, $('v-status'));
    });

    $('v-copy').addEventListener('click',()=>copyToClipboard($('v-output'),$('v-status')));
    $('v-excel').addEventListener('click',()=>downloadAsExcel($('v-output'),$('v-status'),$('v-topic').value||'Vocabulary'));
  })();
/* =========================
     Conversation (UPDATED; keeps TURNS field)
     ========================= */
  (function setupConvo(){
    const convoUI =
      `<div class="fcs-card"><h2>Conversation Creator</h2>
        <div class="grid-2">
          <div class="grid-full"><label for="c-topic">Topic</label><input id="c-topic" type="text" placeholder="e.g., A funny story about a vacation"/></div>

          <div><label>Level (Grammar)</label>
            <select id="c-level">
              <option value="1" selected>Level 1 — Survival</option>
              <option value="2">Level 2 — Beginner</option>
              <option value="3">Level 3 — Intermediate</option>
              <option value="4">Level 4 — Conversational</option>
              <option value="5">Level 5 — Fluent</option>
              <option value="6">Level 6 — Native</option>
            </select>
          </div>

          <div><label># of Conversations</label><input id="c-numConvos" type="number" value="1" min="1"/></div>
          <div><label># of Speakers</label><input id="c-numSpeakers" type="number" value="2" min="1"/></div>

          <div class="grid-full" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;">
            <div><label>Turns</label><input id="c-turns" type="number" value="10" min="1"/></div>
            <div>
              <label for="c-length">Output length</label>
              <select id="c-length">
                <option value="verySmall">Very Small (3–5 sentences/turn; ≥5 words/sentence)</option>
                <option value="small">Small (5–7 sentences/turn; ≥7 words/sentence)</option>
                <option value="medium" selected>Medium (8–15 sentences/turn; ≥10 words/sentence)</option>
                <option value="large">Large (16–25 sentences/turn; ≥12 words/sentence)</option>
                <option value="veryLarge">Very Large (26–35 sentences/turn; ≥15 words/sentence)</option>
                <option value="paragraph">Paragraph (50–70 sentences/turn; ≥15 words/sentence)</option>
              </select>
            </div>
          </div>

          <div><label>Tone</label>
            <select id="c-tone"><option>Neutral, casual</option><option>Informal, friendly</option><option>Instructor, student</option><option>Customer, staff</option><option>Professional, formal</option><option>Street slang</option></select>
          </div>
          <div><label>Country / Region</label><select id="c-country"></select></div>

          <div class="grid-full"><label>Include English Translation</label><select id="c-includeEN"><option value="yes" selected>Yes</option><option value="no">No</option></select></div>

          <!-- New FIB checklist -->
          <div class="grid-full">
            <label>Fill-in-the-Blank Options</label>
            <div id="c-fib-group" style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
              <label><input type="checkbox" id="c-fib-none" checked> none</label>
              <label><input type="checkbox" id="c-fib-mixed"> mixed</label>
              <label><input type="checkbox" class="fib-opt" value="nouns"> nouns</label>
              <label><input type="checkbox" class="fib-opt" value="verbs"> verbs</label>
              <label><input type="checkbox" class="fib-opt" value="adjectives/adverbs"> adjectives/adverbs</label>
              <label><input type="checkbox" class="fib-opt" value="pronouns"> pronouns (object pronouns)</label>
              <label><input type="checkbox" class="fib-opt" value="glue words"> glue words</label>
            </div>
            <div class="hint">
              “mixed” checks all content options; “none” clears them. Glue words include possessive pronouns, demonstratives, conjunctions,
              adverbs, quantifiers, prepositions, and comparisons (more than, as much as, better, etc.).
            </div>
          </div>

          <div class="grid-full"><label for="c-vocab">Vocabulary (optional)</label><textarea id="c-vocab" rows="6" placeholder="Put your own vocabulary here..."></textarea></div>
          <div class="grid-full"><label>Optional Teacher Notes</label><textarea id="c-notes" rows="4"></textarea></div>
        </div>

        <div class="actions"><button id="c-gen" class="primary">Generate</button><button id="c-excel">Excel</button><button id="c-copy">Copy</button><button id="c-prompt">Prompt</button><div id="c-status" class="status"></div></div>
      </div>
      <div id="c-output" class="output-container"><p>Your conversation appears here...</p></div>`;
    $('gen-convo').innerHTML=convoUI;

    const countrySelect=$('c-country');
    const countries=["-no specific-","Argentina","Bolivia","Chile","Colombia","Costa Rica","Cuba","Dominican Republic","Ecuador","El Salvador","Equatorial Guinea","Guatemala","Honduras","Mexico","Nicaragua","Panama","Paraguay","Peru","Puerto Rico","Spain","Uruguay","Venezuela"];
    countrySelect.innerHTML=countries.map(c=>`<option>${c}</option>`).join('');

    // FIB selection logic
    const noneBox = $('c-fib-none');
    const mixedBox = $('c-fib-mixed');
    const fibBoxes = Array.from(document.querySelectorAll('#c-fib-group .fib-opt'));
    function syncFibFromNone(){ if(noneBox.checked){ mixedBox.checked=false; fibBoxes.forEach(b=>b.checked=false); } }
    function syncFibFromMixed(){ if(mixedBox.checked){ noneBox.checked=false; fibBoxes.forEach(b=>b.checked=true); } }
    function syncFibFromOption(){ if (fibBoxes.some(b=>b.checked)) { noneBox.checked=false; mixedBox.checked=fibBoxes.every(b=>b.checked); } else { noneBox.checked=true; mixedBox.checked=false; } }
    noneBox.addEventListener('change', syncFibFromNone);
    mixedBox.addEventListener('change', syncFibFromMixed);
    fibBoxes.forEach(b=>b.addEventListener('change', syncFibFromOption));

    // Output length presets
    const LENGTH_PRESETS = {
      verySmall: { minSent:3, maxSent:5, minWords:5 },
      small:     { minSent:5, maxSent:7, minWords:7 },
      medium:    { minSent:8, maxSent:15, minWords:10 },
      large:     { minSent:16, maxSent:25, minWords:12 },
      veryLarge: { minSent:26, maxSent:35, minWords:15 },
      paragraph: { minSent:50, maxSent:70, minWords:15 }
    };
    function getLengthPreset(){ return LENGTH_PRESETS[ $('c-length').value || 'medium' ] || LENGTH_PRESETS.medium; }

    const genBtn=$('c-gen'),excelBtn=$('c-excel'),copyBtn=$('c-copy'),promptBtn=$('c-prompt'),statusEl=$('c-status'),outputEl=$('c-output');

    /* ---------- Instruction text (copy) ---------- */
    function buildConvoInstruction(){
      const topic=$('c-topic').value.trim();
      const turns = Math.max(1, Number($('c-turns').value)||10);
      const fibTags = fibBoxes.filter(b=>b.checked).map(b=>b.value);
      const fibActive = fibTags.length>0 && !noneBox.checked;
      const lengthPreset = getLengthPreset();
      const ui = {
        topic,
        level: $('c-level').value,
        numConvos: Math.max(1, Number($('c-numConvos').value)||1),
        numSpeakers: Math.max(1, Number($('c-numSpeakers').value)||1),
        turns,
        tone: $('c-tone').value,
        region: $('c-country').value,
        includeEN: $('c-includeEN').value,
        length: lengthPreset,
        fibOptions: fibActive ? fibTags : [],
        vocab: $('c-vocab').value || "(auto-generate level-appropriate list if empty)",
        teacherNotes: $('c-notes').value||""
      };

      const levelLines = getLevelRulesLines(ui.level);
      const header = [
        `You are an expert assistant for FCS.`,
        `IMPORTANT: Do NOT return HTML. Produce TWO PARTS (Word + CSV).`,
        `Topic: "${ui.topic}". Level: ${ui.level}. Tone: "${ui.tone}". Region: "${ui.region}".`,
        ui.vocab && ui.vocab !== "(auto-generate level-appropriate list if empty)" ? `Teacher vocabulary: ${ui.vocab.replace(/[\r\n]+/g,'; ')}` : `Vocabulary: auto-generate.`,
        `LEVEL RULES:\n- ${levelLines.join('\n- ')}`
      ];

      const baseRules = [
        `Create EXACTLY ${ui.numConvos} conversation section(s) titled "Conversation 1", "Conversation 2", ...`,
        `Use exactly ${ui.numSpeakers} distinct speaker name(s) appropriate to the region.`,
        `Each conversation has EXACTLY ${ui.turns} turns (rows).`,
        (ui.includeEN==='yes'
          ? `Tables have two columns: "English" | "Español".`
          : `Tables have one column: "Español" only.`),
        `Each turn contains between ${ui.length.minSent} and ${ui.length.maxSent} sentences in each column that exists, and every sentence has at least ${ui.length.minWords} words.`,
        (ui.numConvos===1 && ui.numSpeakers===1
          ? `Because #Conversations=1 and #Speakers=1, produce a MONOLOGUE across all ${ui.turns} turns. Prefer the UPPER bound of sentences/turn and write longer, multi-clause sentences.`
          : `Keep flow natural; avoid robotic symmetry.`)
      ];

      const fibRules = (!fibActive) ? [`No Fill-in-the-Blank section.`] : [
        `Include a Fill-in-the-Blank section with about ${Math.max(8, Math.min(40, Math.round(ui.turns * 0.9)))} items.`,
        `FIB content focus (select all that apply): ${fibTags.join(', ')}.`,
        `FIB formatting (STRICT):`,
        `• English column: full sentence; color ONLY the target English word with <span class="en">…</span>.`,
        `• Spanish column: full Spanish sentence; replace the Spanish target word with "________"; immediately BEFORE the blank include the English word in parentheses.`,
        `MANDATORY: Include a numbered Answer Key after FIB.`,
        `MANDATORY: Include a "Vocabulary Used" list containing ONLY words/phrases (no full sentences), with English | Español columns, covering the entire output (conversations + FIB).`
      ];

      const partA = [
        `PART A — READABLE VIEW (Word):`,
        (ui.includeEN==='yes'
          ? `- Under each "Conversation X", provide a Markdown table: "English" | "Español".`
          : `- Under each "Conversation X", provide a single-column Markdown table: "Español".`),
        `- Keep names and punctuation natural.`
      ];

      const partB = [
        `PART B — CSV:`,
        `1) CSV_CONVERSATIONS — header: "Conversation","Turn","Speaker","English","Español". Include every turn.`,
        fibActive ? `2) CSV_FIB — header: "English","Español".` : null,
        fibActive ? `3) CSV_VOCAB_USED — header: "English","Español".` : null,
        fibActive ? `4) CSV_ANSWER_KEY — header: "#","Answer".` : null
      ].filter(Boolean);

      const footer = [
        `GLOBAL: No HTML. Stay on topic "${ui.topic}". Obey level & UI exactly.`
      ];

      return [...header, '', 'Rules (strict):', ...baseRules, ...fibRules, '', ...partA, '', ...partB, '', ...footer].join('\n');
    }

    /* ---- HTML prompt (generation) ---- */
    function buildConvoPrompt(){
      const topic=$('c-topic').value.trim();
      const turns = Math.max(1, Number($('c-turns').value)||10);
      const fibTags = fibBoxes.filter(b=>b.checked).map(b=>b.value);
      const fibActive = fibTags.length>0 && !noneBox.checked;
      const lengthPreset = getLengthPreset();

      const ui = {
        topic,
        level: $('c-level').value,
        sentences_per_turn: { min: lengthPreset.minSent, max: lengthPreset.maxSent, minWords: lengthPreset.minWords },
        vocab: $('c-vocab').value || "(auto-generate level-appropriate list if empty)",
        numConvos: Math.max(1, Number($('c-numConvos').value)||1),
        numSpeakers: Math.max(1, Number($('c-numSpeakers').value)||1),
        turns,
        tone: $('c-tone').value,
        region: $('c-country').value,
        includeEN: $('c-includeEN').value,
        fibOptions: fibActive ? fibTags : [],
        fibActive,
        teacherNotes: $('c-notes').value||""
      };

      const levelLines = getLevelRulesLines(ui.level);
      const isMono = (ui.numConvos===1 && ui.numSpeakers===1);

      const rules = [
        `Create EXACTLY UI.numConvos conversation sections: "Conversation 1"...`,
        `Each conversation has EXACTLY UI.turns turns (rows).`,
        `Use EXACTLY UI.numSpeakers distinct speaker name(s); if UI.numSpeakers === 1, use the same speaker name for all turns (monologue).`,
        `Each turn has between UI.sentences_per_turn.min and UI.sentences_per_turn.max sentences in Spanish${ui.includeEN==='yes'?' and English':''}. Each sentence must have ≥ UI.sentences_per_turn.minWords words. Prefer the UPPER bound and longer, multi-clause sentences${isMono?' for a very long monologue':''}.`,
        (ui.includeEN==='yes'
          ? 'Headers must be exactly "English" and "Español".'
          : 'Single column header must be "Español".'),
        `Tone: "${ui.tone}". Region/culture cues: "${ui.region}". Level: ${ui.level}.`,
        `LEVEL RULES:\n- ${levelLines.join('\n- ')}`,
        (ui.fibActive ? `Include Fill-in-the-Blank focused on: ${ui.fibOptions.join(', ')}.` : ''),
        (ui.fibActive ? `FIB formatting: English has <span class="en">target</span>; Spanish replaces target with "________" and includes (English target) immediately before the blank.` : ''),
        (ui.fibActive ? 'MANDATORY: Include "Vocabulary Used" (words only) and "Answer Key".' : ''),
        'No empty <tbody>. SELF-CHECK all constraints before returning.'
      ].filter(Boolean);

      const conversationsHTML = Array.from({length: ui.numConvos}).map((_,i)=>`
  <div class="section">
    <h2>Conversation ${i+1}</h2>
    <table class="tbl">
      <thead>
        ${ui.includeEN==='yes'
          ? '<tr><th>English</th><th lang="es">Español</th></tr>'
          : '<tr><th lang="es">Español</th></tr>'}
      </thead>
      <tbody></tbody>
    </table>
  </div>`).join('');

      const fibLabel = ui.fibActive ? ui.fibOptions.join(', ') : '';

      const fibHTML = ui.fibActive ? `
  <div class="section">
    <h2>Practice — Fill-in-the-Blank (${fibLabel})</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Español</th></tr></thead><tbody></tbody></table>
  </div>` : '';

      const vocabUsedHTML = ui.fibActive ? `
  <div class="section">
    <h2>Vocabulary Used</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Español</th></tr></thead><tbody></tbody></table>
  </div>` : '';

      const answerKeyHTML = ui.fibActive ? `
  <div class="section">
    <h2>Answer Key</h2>
    <table class="tbl"><thead><tr><th>#</th><th>Answer</th></tr></thead><tbody></tbody></table>
  </div>` : '';

      const prompt =
`<!DOCTYPE html>
<!-- FCS CONVERSATION OUTPUT (full HTML) -->
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conversation — ${ui.topic}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a;--hi:#eef2ff}
  *{box-sizing:border-box}
  body{font-family:Calibri,Arial,sans-serif;font-size:11pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin:14px 0;overflow-x:auto}
  .legend{font-size:9pt;color:var(--muted);text-align:center;margin-top:6px}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:8px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700}
  .es{color:var(--es);font-weight:700}
  @media(max-width:700px){ .tbl{font-size:9pt;width:auto}.tbl thead{display:none}.tbl td{display:block;width:100%}.tbl td+td{margin-top:6px} }
</style>
</head>
<body>
<div class="fcs-doc">
  <h1>Conversation: ${ui.topic} — Level ${ui.level}</h1>
  <div class="legend"><span class="en">EN vocab = blue</span> | <span class="es">ES vocab = red</span>.</div>

  <!-- CONTRACT (STRICT):
    UI = ${JSON.stringify(ui)}
    ${rules.map((r,i)=>`- ${r}`).join('\n    ')}
  -->

  ${conversationsHTML}

  ${fibHTML}
  ${vocabUsedHTML}
  ${answerKeyHTML}

  ${ui.vocab && ui.vocab!=="(auto-generate level-appropriate list if empty)" ?
  `<div class="legend" style="white-space:pre-wrap;border:1px dashed var(--border);padding:8px;border-radius:8px;margin-top:8px;">
    Teacher Vocabulary (STRICT use):\n${ui.vocab.replace(/</g,"&lt;").replace(/>/g,"&gt;")}
  </div>` : ''}

  ${ui.teacherNotes ? `<div class="legend" style="white-space:pre-wrap;margin-top:8px;">Teacher notes:\n${ui.teacherNotes.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>` : ''}

</div>
</body>
</html>`;
      return { prompt, ui };
    }

    // Validator to enforce: turns, per-turn sentence count, min words/sentence, table headers; FIB blanks; Vocabulary Used words only.
    function buildValidator(ui){
      return function(html){
        try{
          const doc = new DOMParser().parseFromString(html,'text/html');
          const problems = [];

          const convH2s = Array.from(doc.querySelectorAll('.section h2')).filter(h=>/Conversation\s+\d+/i.test(h.textContent||''));
          if (convH2s.length !== ui.numConvos) problems.push(`need exactly ${ui.numConvos} conversation sections, found ${convH2s.length}`);

          convH2s.forEach((h2, idx)=>{
            const tbl = h2.parentElement.querySelector('table'); if(!tbl){problems.push(`conv ${idx+1}: missing table`); return;}
            const ths = Array.from(tbl.querySelectorAll('thead th')).map(th=>th.textContent.trim().toLowerCase());
            if (ui.includeEN==='yes'){
              if (!ths.includes('english') || !ths.find(t=>t.includes('español')||t.includes('espanol'))) problems.push(`conv ${idx+1}: must have English | Español headers`);
            } else {
              if (ths.length!==1 || !(ths[0].includes('español')||ths[0].includes('espanol'))) problems.push(`conv ${idx+1}: must have only Español column`);
            }

            const rows = Array.from(tbl.querySelectorAll('tbody tr'));
            if (rows.length !== ui.turns) problems.push(`conv ${idx+1}: must have exactly ${ui.turns} turns (rows), found ${rows.length}`);

            // sentence counts per turn + min words
            rows.forEach((tr, ri)=>{
              const tds = Array.from(tr.querySelectorAll('td'));
              const esIdx = (ui.includeEN==='yes') ? 1 : 0;
              const esText = (tds[esIdx]?.textContent||'').trim();
              const enText = (ui.includeEN==='yes') ? (tds[0]?.textContent||'').trim() : '';

              function splitSentences(s){
                const clean = s.replace(/\s+/g,' ').trim();
                if (!clean) return [];
                return clean.split(/(?<=[\.\!\?…])\s+/).filter(Boolean);
              }
              function checkSentences(label, sents){
                if (sents.length < ui.sentences_per_turn.min || sents.length > ui.sentences_per_turn.max)
                  problems.push(`conv ${idx+1} row ${ri+1} (${label}): ${sents.length} sentences (must be ${ui.sentences_per_turn.min}-${ui.sentences_per_turn.max})`);
                const tooShort = sents.find(seg=>{
                  const words = seg.replace(/[^\p{L}\p{N}\sáéíóúüñÁÉÍÓÚÜÑ\-’']/gu,'').trim().split(/\s+/).filter(Boolean);
                  return words.length < ui.sentences_per_turn.minWords;
                });
                if (tooShort) problems.push(`conv ${idx+1} row ${ri+1} (${label}): a sentence has fewer than ${ui.sentences_per_turn.minWords} words`);
              }

              const esSents = splitSentences(esText); checkSentences('ES', esSents);
              if (ui.includeEN==='yes'){ const enSents = splitSentences(enText); checkSentences('EN', enSents); }
            });

            // speakers count; if mono (1 & 1) enforce one speaker only
            const speakerNames = new Set(Array.from(tbl.querySelectorAll('tbody td'))
              .map(td=>(td.textContent||'').trim().match(/^([A-Za-zÁÉÍÓÚÜÑáéíóúüñ'’\-]+)\s*:/))
              .filter(Boolean).map(m=>m[1]));
            if (speakerNames.size && speakerNames.size !== ui.numSpeakers){
              problems.push(`conv ${idx+1}: expected ${ui.numSpeakers} distinct speaker(s), found ${speakerNames.size}`);
            }
          });

          // FIB check (if active)
          if (ui.fibActive){
            const fibH2 = Array.from(doc.querySelectorAll('.section h2')).find(h=>/Fill\-in\-the\-Blank|Practice/i.test(h.textContent||''));
            if(!fibH2){ problems.push('missing Fill-in-the-Blank section'); }
            else{
              const table = fibH2.parentElement.querySelector('table');
              if(!table){ problems.push('FIB: missing table'); }
              else{
                const ths = Array.from(table.querySelectorAll('thead th')).map(th=>th.textContent.trim());
                if (ths[0] !== 'English' || !/Español|Espanol/i.test(ths[1])) problems.push('FIB headers must be exactly "English" and "Español"');
                const rows = Array.from(table.querySelectorAll('tbody tr'));
                rows.forEach((tr, i)=>{
                  const tds=Array.from(tr.querySelectorAll('td'));
                  const enHTML = tds[0]?.innerHTML||'';
                  const esText = (tds[1]?.textContent||'').trim();
                  if (!/class="en"/i.test(enHTML)) problems.push(`FIB row ${i+1}: English target must be blue (<span class="en">)`);
                  if (!/\(.*?\)\s*_{6,}/.test(esText)) problems.push(`FIB row ${i+1}: Spanish must include (English target) before blank "________"`);
                });
              }
            }
            // Vocabulary Used words-only
            const vH2 = Array.from(doc.querySelectorAll('.section h2')).find(h=>/Vocabulary Used/i.test(h.textContent||''));
            if(!vH2){ problems.push('missing Vocabulary Used section'); }
            else{
              const rows = Array.from(vH2.parentElement.querySelectorAll('tbody tr'));
              rows.forEach((tr,i)=>{
                const en = (tr.querySelector('td:nth-child(1)')?.textContent||'').trim();
                const es = (tr.querySelector('td:nth-child(2)')?.textContent||'').trim();
                if (/[\.!?…]$/.test(en) || /[\.!?…]$/.test(es)) problems.push(`Vocabulary Used row ${i+1}: words only, no full sentences`);
              });
            }
            // Answer Key present
            const aH2 = Array.from(doc.querySelectorAll('.section h2')).find(h=>/Answer Key/i.test(h.textContent||''));
            if(!aH2){ problems.push('missing Answer Key'); }
          }

          return problems.length ? problems.join('; ') : '';
        }catch(e){ return ''; }
      };
    }

    function buildPromptAndUI(){
      const { prompt, ui } = buildConvoPrompt();
      const instruction = buildConvoInstruction();
      return { prompt, ui, instruction };
    }

    // Generate
    genBtn.addEventListener('click', async ()=>{
      const topic=$('c-topic').value.trim(); if(!topic){statusEl.textContent="Enter a topic.";return;}
      const { prompt, ui } = buildPromptAndUI();
      const validator = buildValidator({ ...ui, fibActive: ui.fibActive });
      await generateResultWithRetries(prompt, genBtn, statusEl, outputEl, validator, 1);
      await Speech.ensureVoices();
      addPerLineTTS(outputEl);
      addConversationPlayers(outputEl);
    });

    // Prompt + Copy + Excel
    promptBtn.addEventListener('click', ()=>{
      const topic=$('c-topic').value.trim(); if(!topic){statusEl.textContent="Enter a topic.";return;}
      const { instruction } = buildPromptAndUI();
      copyText(instruction, statusEl);
    });
    copyBtn.addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    excelBtn.addEventListener('click', ()=>downloadAsExcel(outputEl,statusEl,$('c-topic').value||'Conversation'));
  })();

  /* =========================
     Test (unchanged)
     ========================= */
  (function setupTest(){
    const testUI =
      `<div class="fcs-card">
        <h2>Test Creator</h2>
        <div><label for="t-vocab">Vocabulary List</label><textarea id="t-vocab" rows="6" placeholder="Paste the EXACT vocabulary for the test..."></textarea></div>
        <div><label for="t-level">Level (Grammar)</label>
          <select id="t-level">
            <option value="1" selected>Level 1 — Survival</option>
            <option value="2">Level 2 — Beginner</option>
            <option value="3">Level 3 — Intermediate</option>
            <option value="4">Level 4 — Conversational</option>
            <option value="5">Level 5 — Fluent</option>
          </select></div>
        <div><label><input type="checkbox" id="t-anskeys" checked> Include Teacher Answer Keys?</label></div>
        <div class="actions"><button id="t-gen" class="primary">Generate</button><button id="t-excel">Excel</button><button id="t-copy">Copy</button><div id="t-status" class="status"></div></div>
      </div>
      <div id="t-output" class="output-container"><p>Your test will appear here...</p></div>`;
    $('gen-test').innerHTML=testUI;

    const genBtn=$('t-gen'),excelBtn=$('t-excel'),copyBtn=$('t-copy'),statusEl=$('t-status'),outputEl=$('t-output');

    genBtn.addEventListener('click', async ()=>{
      const vocabEl=$('t-vocab'); if(!vocabEl.value.trim()){statusEl.textContent="Please paste a vocab list.";return;}
      const prompt =
`<!DOCTYPE html>
<!-- FCS TEST OUTPUT -->
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Test — Level ${$('t-level').value}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a}
  *{box-sizing:border-box} body{font-family:Calibri,Arial,sans-serif;font-size:10pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:14px;overflow-x:auto}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:8px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700} .es{color:var(--es);font-weight:700}
  .note{font-size:9pt;color:var(--muted)}
  @media(max-width:700px){ .tbl{font-size:9pt;width:auto} }
</style></head>
<body><div class="fcs-doc">
  <h1>FCS Conversation Test — Level ${$('t-level').value}</h1>
  <div class="note"><span class="en">English terms = blue</span>; <span class="es">Spanish terms = red</span> whenever vocabulary appears inline.</div>

  <div class="section">
    <h2>Part 1 — Spanish → English</h2>
    <table class="tbl"><thead><tr><th>#</th><th lang="es">Español</th>${$('t-anskeys').checked ? '<th>Answer (EN)</th>' : ''}</tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Part 2 — English → Spanish</h2>
    <table class="tbl"><thead><tr><th>#</th><th>English</th>${$('t-anskeys').checked ? '<th lang="es">Answer (ES)</th>' : ''}</tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Part 3 — Live Conversation Prompts</h2>
    <table class="tbl"><thead><tr><th>#</th><th lang="es">Prompt (Español)</th></tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  ${$('t-anskeys').checked ? `<div class="section"><h2>Answer Key</h2><!-- answers only --></div>` : ''}

  <div class="note">Vocabulary pasted by teacher:</div>
  <div class="note" style="white-space:pre-wrap;border:1px dashed var(--border);padding:8px;border-radius:8px;">${$('t-vocab').value.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>

</div></body></html>`;
      const html = await callAPI(prompt);
      outputEl.innerHTML = html;
      statusEl.textContent = "Done.";
      await Speech.ensureVoices();
      addPerLineTTS(outputEl);
    });

    $('t-copy').addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    $('t-excel').addEventListener('click',()=>downloadAsExcel(outputEl,statusEl,'Test'));
  })();

})();
</script>
</body>
</html>
