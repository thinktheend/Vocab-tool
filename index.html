<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>FCS AI Generator Suite</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  :root { --bg:#f7f9fc; --fg:#111; --muted:#667085; --border:#e5e7eb; --panel:#ffffff; --accent:#0b5cff;
          --en:#1a73e8; --es:#d93025; --head:#0f172a; }
  body { background: var(--bg); color: var(--fg); font-family: Calibri, Arial, sans-serif; font-size: 15px; margin:0; }
  .fcs-wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
  h1 { font-size: 28px; font-weight:700; text-align:center; margin-bottom: 28px; color: var(--head);}
  h2 { font-size: 20px; font-weight:700; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; color: var(--head); }
  .fcs-card { border:1px solid var(--border); border-radius: 12px; padding: 24px; background:var(--panel); margin-bottom: 20px; }
  label { font-weight: 600; font-size: 14px; display: block; margin-bottom: 6px; }
  input[type="text"], select, input[type="number"], textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size:15px; box-sizing:border-box; }
  input:disabled { background-color: #f8f9fa; }
  .hint, .small { font-size: 12px; color: var(--muted); margin-top: 4px; }
  button { padding: 10px 16px; border-radius: 8px; border:1px solid var(--border); background:#f6f8fb; cursor: pointer; font-weight: 600; font-size:15px; transition: all 0.2s; }
  button.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
  button:disabled { cursor: not-allowed; opacity: 0.6; }
  .fcs-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  .fcs-tab-btn { flex-grow: 1; text-align: center; } .fcs-generator { display: none; } .fcs-generator.active { display: block; }
  .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; align-items: end; }
  .six { grid-column: span 6; } .twelve { grid-column: span 12; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; } .grid-full { grid-column: 1 / -1; }
  .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top:20px; align-items:center; }
  .status { margin-top:10px; min-height:1.5em; text-align:left; color:var(--muted); font-size:13px; }
  .output-container { border:1px solid var(--border); border-radius:12px; padding:24px; background:#fff; min-height: 240px; margin-top:12px; }
  .output-container h1, .output-container h2 { text-align: center; color: #0f172a !important; }
  .output-container table { width:100%; border-collapse: separate; border-spacing: 0; margin-top: 12px; font-size:10pt;}
  .output-container th, .output-container td { border:1px solid #e5e7eb; padding:8px; vertical-align:top; }
  .output-container th { background: #f5f7fb; }
  .output-container tr:nth-child(even) td { background: #fafafa; }
  .output-container .en { color: var(--en); font-weight: bold; }
  .output-container .es { color: var(--es); font-weight: bold; }
  .output-container .full-black { color: var(--fg); font-weight: 700; }

  .tts-line-btn { display:inline-flex; align-items:center; gap:4px; padding:2px 6px; margin-right:6px; border:1px solid #dbe2ef;
    border-radius:999px; background:#eef2ff; cursor:pointer; font-size:12px; line-height:1; }
  .tts-line-btn[data-tts="es"] { background:#fdeaea; border-color:#f5c2c7; }
  .tts-line-btn:hover { filter:brightness(0.98); }

  .conv-ctrls { display:flex; gap:8px; align-items:center; margin:6px 0 10px; }
  .conv-ctrls button { padding:6px 10px; font-size:12px; }

  @media (max-width: 860px){ .six, .twelve { grid-column: span 12; } .grid-2{grid-template-columns:1fr;} }
</style>
</head>
<body>
<div class="fcs-wrap">
  <h1>FCS AI GENERATOR SUITE</h1>
  <div class="fcs-tabs">
    <button id="tab-vocab" class="fcs-tab-btn primary">Vocabulary</button>
    <button id="tab-convo" class="fcs-tab-btn">Conversation</button>
    <button id="tab-test" class="fcs-tab-btn">Test</button>
  </div>

  <div id="gen-vocab" class="fcs-generator active"></div>
  <div id="gen-convo" class="fcs-generator"></div>
  <div id="gen-test" class="fcs-generator"></div>
</div>

<script>
"use strict";
(function(){
  const $=id=>document.getElementById(id);
  const API_URL="/api/index";

  /* Tabs */
  (function initTabs(){
    const t=document.querySelectorAll(".fcs-tab-btn"), e=document.querySelectorAll(".fcs-generator");
    t.forEach(o=>{o.addEventListener("click",()=>{const n=o.id.replace("tab-","gen-");t.forEach(t=>t.classList.remove("primary")),o.classList.add("primary"),e.forEach(t=>{t.style.display=t.id===n?"block":"none"})})})
  })();

  /* Fetch + validator retry */
  async function callAPI(prompt){ 
    const resp=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})});
    const json=await resp.json();
    if(!resp.ok) throw new Error(json.details||json.error||"Unknown server error.");
    return json.content;
  }

  async function generateResultWithRetries(basePrompt, button, statusEl, outputEl, validator, maxRetries=2){
    button.disabled=true;
    statusEl.textContent="Generating...";
    outputEl.innerHTML="<h4>Please wait. AI is working...</h4>";
    let html = await callAPI(basePrompt);
    for (let attempt=0; attempt<maxRetries; attempt++){
      const failMsg = validator ? validator(html) : "";
      if (!failMsg) break;
      statusEl.textContent = `Retrying to enforce constraints‚Ä¶ (${attempt+1}/${maxRetries})`;
      const retryPrompt = basePrompt + `

<!-- VIOLATION NOTICE:
${failMsg}
Regenerate so that ALL constraints are satisfied EXACTLY. Do not change CSS class names or document structure.
-->`;
      html = await callAPI(retryPrompt);
    }
    outputEl.innerHTML = html;
    statusEl.textContent = "Done.";
  }

  /* Copy helpers */
  function copyToClipboard(container,statusEl){
    if(!container.innerHTML || container.innerText.includes("will appear here")){
      statusEl.textContent="Nothing to copy."; return;
    }
    navigator.clipboard.writeText(container.innerText).then(
      ()=>statusEl.textContent="Copied!",
      ()=>{ const t=document.createElement("textarea"); t.value=container.innerText; document.body.appendChild(t); t.select();
            try{ document.execCommand("copy") ? statusEl.textContent="Copied!" : statusEl.textContent="Copy failed."; }
            catch(e){ statusEl.textContent="Copy failed."; }
            document.body.removeChild(t); }
    );
  }
  function copyText(text,statusEl){
    if(!text){ statusEl.textContent="Nothing to copy."; return; }
    navigator.clipboard.writeText(text).then(
      ()=>statusEl.textContent="Prompt copied!",
      ()=>{ const t=document.createElement("textarea"); t.value=text; document.body.appendChild(t); t.select();
            try{ document.execCommand("copy") ? statusEl.textContent="Prompt copied!" : statusEl.textContent="Copy failed."; }
            catch(e){ statusEl.textContent="Copy failed."; }
            document.body.removeChild(t); }
    );
  }

  /* Excel export */
  function downloadAsExcel(container,statusEl,filename){
    if(!container.querySelector("table")){statusEl.textContent="No data to export.";return}
    try{
      statusEl.textContent="Creating Excel...";
      const wb=XLSX.utils.book_new(), rows=[], title=container.querySelector("h1")?.innerText||filename;
      rows.push([title]); rows.push([]);
      container.querySelectorAll("h2, table").forEach(el=>{
        if(el.tagName==="H2") rows.push([el.innerText]);
        if(el.tagName==="TABLE"){
          el.querySelectorAll("tr").forEach(tr=>{
            const line=Array.from(tr.querySelectorAll("th, td")).map(td=>td.innerText); rows.push(line);
          });
          rows.push([]);
        }
      });
      const ws=XLSX.utils.aoa_to_sheet(rows);
      ws["!cols"]=rows.reduce((acc,row)=>{row.forEach((cell,i)=>{const w=cell?cell.toString().length+2:10; if(!acc[i]||acc[i].wch<w) acc[i]={wch:w}}); return acc;},[]);
      XLSX.utils.book_append_sheet(wb,ws,"Generated Content");
      XLSX.writeFile(wb,`${(filename||'Export').replace(/\s+/g,"_")}.xlsx`);
      statusEl.textContent="Download started.";
    }catch(e){console.error("Excel Error:",e); statusEl.textContent="Failed to create Excel."}
  }

  /* ===== Level-specific MUST-FOLLOW rules (text only; used in prompts) ===== */
  function getLevelRulesLines(level){
    switch(String(level)){
      case '1':
        return [
          'LEVEL 1 ‚Äì Fluent Reading & Pronunciation (MUST FOLLOW):',
          '‚Ä¢ Purpose: Evaluate reading accuracy, pronunciation, and fluency only.',
          '‚Ä¢ Provide a long scripted conversation; the student only reads (no creation).',
          '‚Ä¢ Must read smoothly, with correct stress and intonation.',
          '‚Ä¢ No grammar production required ‚Äî purely recognition and oral delivery.',
          '‚Ä¢ Include full range of topic vocabulary.',
          '‚Ä¢ Pass Criteria: natural conversational speed; ‚â•90% correct pronunciation; intonation matches meaning (e.g., rising tone for questions).'
        ];
      case '2':
        return [
          'LEVEL 2 ‚Äì Present Tense, Reflexives & Glue Words (MUST FOLLOW):',
          '‚Ä¢ Purpose: Assess ability to produce correct present tense structures with connectors.',
          '‚Ä¢ Grammar Required: Ser & Estar (characteristics vs. states/locations).',
          '‚Ä¢ Present tense with all regular verbs.',
          '‚Ä¢ Present tense with: tener que, necesitar, querer, ir a, poder, acabar de, gustar.',
          '‚Ä¢ Conditional with: poder, gustar, deber (polite/softened intent).',
          '‚Ä¢ Object pronouns (direct & indirect).',
          '‚Ä¢ Reflexive verbs in present tense (with regular verbs).',
          '‚Ä¢ Glue words (connectors not verbs/nouns/adjectives).',
          '‚Ä¢ Prepositions: a, en, de, con, por, para, etc.',
          '‚Ä¢ Conjunctions: y, o, pero, porque, si, cuando, aunque, etc.',
          '‚Ä¢ Adverbs: bien, mal, r√°pido, siempre, ahora, despu√©s, etc.',
          '‚Ä¢ Pronouns: yo, t√∫, √©l, ella, nosotros, ustedes, ellos, etc.',
          '‚Ä¢ Possessive & demonstrative: mi, tu, su, nuestro; ese/este/estos, etc.',
          '‚Ä¢ Comparisons: m√°s‚Ä¶ que; tan‚Ä¶ como; tanto‚Ä¶ como; mayor, menor, peor, mejor.',
          '‚Ä¢ Quantities: mucho, poco, todo, algunos, ninguno, etc.',
          '‚Ä¢ Time words: hoy, ma√±ana, ahora, todav√≠a, ya, temprano, tarde, etc.'
        ];
      case '3':
        return [
          'LEVEL 3 ‚Äì Adds Past Tenses & Progressive (MUST FOLLOW):',
          '‚Ä¢ Purpose: Narrate/describe in both past and present.',
          '‚Ä¢ Includes ALL Level 2 items, plus:',
          '‚Ä¢ Present tense with regular & irregular verbs.',
          '‚Ä¢ Pret√©rito (completed past actions).',
          '‚Ä¢ Imperfecto (ongoing/habitual past).',
          '‚Ä¢ Progressive forms in present (estar + gerundio).'
        ];
      case '4':
        return [
          'LEVEL 4 ‚Äì Adds Future, Conditionals, Perfects & All Uses of ‚ÄúSe‚Äù (MUST FOLLOW):',
          '‚Ä¢ Purpose: Express plans, hypotheticals, completed actions, and ‚Äúse‚Äù constructions.',
          '‚Ä¢ Includes ALL Level 2 & 3 items, plus:',
          '‚Ä¢ Simple future.',
          '‚Ä¢ Simple conditional.',
          '‚Ä¢ Present perfect.',
          '‚Ä¢ Present perfect progressive.',
          '‚Ä¢ All uses of ‚Äúse‚Äù: passive (Se venden boletos), impersonal (Se juega con cinco jugadores), clitic/obj pronoun (Se lo di), reflexives (Se levanta), immediate reflexive (irse), intensifying reflexive (Se comi√≥ todo), accidental (Se me olvid√≥), reciprocal (Se pasan el bal√≥n).'
        ];
      case '5':
        return [
          'LEVEL 5 ‚Äì Adds Imperatives, Subjunctive, Expanded Progressives & Perfects (MUST FOLLOW):',
          '‚Ä¢ Purpose: Command, persuade, hypothesize, and narrate across all tenses.',
          '‚Ä¢ Includes ALL Level 2, 3, and 4 items, plus:',
          '‚Ä¢ Imperative ‚Äî positive and negative.',
          '‚Ä¢ Subjunctive ‚Äî present and past (use where required by triggers/volition/doubt/emotion, etc.).',
          '‚Ä¢ Progressives ‚Äî present, future, conditional, preterite, imperfect.',
          '‚Ä¢ Perfect tenses ‚Äî present, future, conditional, preterite, imperfect.',
          '‚Ä¢ Perfect progressives ‚Äî present, future, conditional, preterite, imperfect.'
        ];
      case '6':
        return [
          'LEVEL 6 ‚Äì Native (MUST FOLLOW):',
          '‚Ä¢ Produce a very long, cohesive monologue by a single native-sounding speaker that fully reflects the selected tone; ignore per-turn sentence bounds; no FIB/Vocab Used/Answer Key.'
        ];
      default:
        return [];
    }
  }

  /* Speech helpers */
  const Speech = {
    voices: [], ready:false, defaultRate:0.85,
    ensureVoices(){ return new Promise(res=>{ if(!('speechSynthesis'in window)){res();return;}
      const set=()=>{Speech.voices=window.speechSynthesis.getVoices()||[];Speech.ready=Speech.voices.length>0;res();};
      const ex=window.speechSynthesis.getVoices(); ex&&ex.length?set():window.speechSynthesis.onvoiceschanged=set;});},
    pickVoice(langPrefix){ if(!Speech.ready) return null;
      const lp=(langPrefix||'en').toLowerCase();
      const preferEs=v=>v&&v.lang&&/^es(-|$)/i.test(v.lang)&&/(mexico|spain|us|latam|standard|google|es[-_](MX|ES|US|419))/i.test(v.name||"");
      if(lp.startsWith('es')) return Speech.voices.find(preferEs)||Speech.voices.find(v=>/^es/i.test(v.lang))||Speech.voices[0]||null;
      if(lp.startsWith('en')) return Speech.voices.find(v=>/^en/i.test(v.lang))||Speech.voices[0]||null;
      return Speech.voices[0]||null; },
    stop(){ if('speechSynthesis'in window) window.speechSynthesis.cancel(); },
    speak(text, lang='en', opts={}){
      if (!('speechSynthesis' in window)) { alert('Text-to-speech not supported.'); return; }
      const s=(text||'').replace(/\s+/g,' ').trim(); if(!s) return;
      const v=this.pickVoice(lang);
      const u=new SpeechSynthesisUtterance(s);
      if (v) u.voice=v;
      u.lang = v ? v.lang : (lang.startsWith('es')?'es-ES':'en-US');
      u.rate = lang.startsWith('es') ? 0.92 : (opts.rate || this.defaultRate);
      u.pitch = (typeof opts.pitch === 'number') ? opts.pitch : 1.0;
      u.volume = 1.0;
      window.speechSynthesis.speak(u);
    }
  };

  function getCellReadableText(td){
    let txt = '';
    td.childNodes.forEach(n=>{
      const isBtn = n.nodeType===1 && n.tagName==='BUTTON' && n.classList.contains('tts-line-btn');
      if (!isBtn) txt += (n.textContent || '');
    });
    return txt.replace(/\s+/g,' ').trim();
  }

  const speakerVoiceMap = new Map();
  function getSpeakerFromText(t){
    const m = (t||'').trim().match(/^([A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±'‚Äô\-]+)\s*:\s*/);
    return m ? m[1] : "";
  }
  function stripSpeakerLabel(t){
    return (t||'').replace(/^([A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±'‚Äô\-]+)\s*:\s*/, '').trim();
  }
  function assignVoiceForSpeaker(speaker){
    if (speakerVoiceMap.has(speaker)) return speakerVoiceMap.get(speaker);
    const assign = { pitch: speakerVoiceMap.size % 2 ? 0.95 : 1.05 };
    speakerVoiceMap.set(speaker, assign);
    return assign;
  }

  function addPerLineTTS(root){
    const sections = root.querySelectorAll('.section');
    sections.forEach(section=>{
      const title = section.querySelector('h2')?.textContent || '';
      const isConversation = /Conversation\s+\d+/i.test(title);
      const tables = section.querySelectorAll('table');
      tables.forEach(tbl=>{
        const ths=Array.from(tbl.querySelectorAll('thead th'));
        const map=ths.map(th=>{
          const t=(th.textContent||'').toLowerCase();
          if (t.includes('english') || t.includes('(en)')) return 'en';
          if (t.includes('espa√±ol') || t.includes('espanol') || t.includes('(es)')) return 'es';
          return '';
        });
        Array.from(tbl.querySelectorAll('tbody tr')).forEach(tr=>{
          const tds=Array.from(tr.querySelectorAll('td'));
          tds.forEach((td,i)=>{
            const lang=map[i];
            if (lang==='en'||lang==='es'){
              if (!td.querySelector('.tts-line-btn')){
                const b=document.createElement('button');
                b.type='button';
                b.className='tts-line-btn';
                b.setAttribute('data-tts',lang);
                b.textContent='üîä';
                td.insertBefore(b, td.firstChild);

                b.addEventListener('click', async e=>{
                  e.stopPropagation();
                  await Speech.ensureVoices();
                  const raw = getCellReadableText(td);
                  if (isConversation){
                    const speaker = getSpeakerFromText(raw) || `Speaker${speakerVoiceMap.size+1}`;
                    const assign = assignVoiceForSpeaker(speaker);
                    const clean = stripSpeakerLabel(raw);
                    Speech.stop();
                    Speech.speak(clean, lang==='es'?'es':'en', { pitch: assign.pitch });
                  } else {
                    Speech.stop();
                    Speech.speak(raw, lang);
                  }
                });
              }
            }
          });
        });
      });
    });
  }

  function addConversationPlayers(root){
    const sections = Array.from(root.querySelectorAll('.section h2'))
      .filter(h2=>/Conversation\s+\d+/i.test(h2.textContent||''));
    sections.forEach(h2=>{
      const parent = h2.parentElement;
      const table = parent.querySelector('table');
      if(!table) return;
      const ths = Array.from(table.querySelectorAll('thead th'));
      let esIdx = ths.findIndex(th=>/espa√±ol|espanol/i.test(th.textContent||'')); if(esIdx<0) esIdx = ths.length-1;

      const rows = Array.from(table.querySelectorAll('tbody tr'));
      const items = rows.map(r=>{
        const tds=Array.from(r.querySelectorAll('td'));
        const cell = tds[esIdx];
        if (!cell) return null;
        const raw = getCellReadableText(cell);
        if(!raw) return null;
        const speaker = getSpeakerFromText(raw) || 'Narr';
        const text = stripSpeakerLabel(raw);
        return { speaker, text };
      }).filter(Boolean);

      if (parent.querySelector('.conv-ctrls')) return;
      const ctrl = document.createElement('div');
      ctrl.className='conv-ctrls';
      const playBtn=document.createElement('button'); playBtn.className='primary'; playBtn.textContent='Play (ES)';
      const pauseBtn=document.createElement('button'); pauseBtn.textContent='Pause';
      const resumeBtn=document.createElement('button'); resumeBtn.textContent='Resume';
      const stopBtn=document.createElement('button'); stopBtn.textContent='Stop';
      ctrl.append(playBtn,pauseBtn,resumeBtn,stopBtn);
      parent.insertBefore(ctrl, table);

      let idx=0; let state='stopped';
      const onend = ()=>{ if(state!=='stopped'){ idx++; if(idx>=items.length){ state='stopped'; return; }
        speakCurrent(); } };

      function speakCurrent(){
        const it = items[idx]; if(!it){ state='stopped'; return; }
        const assign = assignVoiceForSpeaker(it.speaker);
        Speech.stop();
        const u = new SpeechSynthesisUtterance(it.text);
        const v = Speech.pickVoice('es');
        if (v) u.voice=v;
        u.lang = v ? v.lang : 'es-ES';
        u.rate = 0.92;
        u.pitch = assign.pitch;
        u.volume = 1.0;
        u.onend = onend;
        window.speechSynthesis.speak(u);
        state='playing';
      }

      playBtn.addEventListener('click', async ()=>{
        await Speech.ensureVoices();
        if(state==='stopped'){ idx=0; speakCurrent(); }
        else if(state==='playing'){ window.speechSynthesis.pause(); state='paused'; }
        else if(state==='paused'){ window.speechSynthesis.resume(); state='playing'; }
      });
      pauseBtn.addEventListener('click', ()=>{ if(state==='playing'){ window.speechSynthesis.pause(); state='paused'; }});
      resumeBtn.addEventListener('click', ()=>{ if(state==='paused'){ window.speechSynthesis.resume(); state='playing'; }});
      stopBtn.addEventListener('click', ()=>{ Speech.stop(); state='stopped'; idx=0; });
    });
  }

  /* =========================
     Vocabulary
     ========================= */
  (function setupVocab(){
    const vocabUI =
      `<div class="fcs-card">
        <h2>Vocabulary Creator</h2>
        <div class="grid">
          <div class="six"><label for="v-topic">Topic</label><input id="v-topic" type="text" placeholder="e.g., At the Airport"></div>
          <div class="six"><label for="v-level">Level</label>
            <select id="v-level">
              <option value="1" selected>Level 1 ‚Äî Survival</option>
              <option value="2">Level 2 ‚Äî Beginner</option>
              <option value="3">Level 3 ‚Äî Intermediate</option>
              <option value="4">Level 4 ‚Äî Conversational</option>
              <option value="5">Level 5 ‚Äî Fluent</option>
            </select>
          </div>

          <div class="twelve">
            <label>Sections to Include (multi-select)</label>
            <div id="v-sections" style="display:flex; flex-wrap:wrap; gap:14px;">
              <label><input type="checkbox" id="v-sec-all" checked> All</label>
              <label><input type="checkbox" class="v-sec" value="nouns" checked> Nouns</label>
              <label><input type="checkbox" class="v-sec" value="verbs" checked> Verbs</label>
              <label><input type="checkbox" class="v-sec" value="descriptive" checked> Descriptive Words</label>
              <label><input type="checkbox" class="v-sec" value="phrases" checked> Common Phrases</label>
              <label><input type="checkbox" class="v-sec" value="questions" checked> Common Questions</label>
            </div>
            <div class="hint">Uncheck to generate only the sections you need. ‚ÄúAll‚Äù toggles everything.</div>
          </div>

          <div class="six">
            <label for="v-tmode">Total Words Mode</label>
            <select id="v-tmode"><option value="default" selected>Preset by Level</option><option value="custom">Custom</option></select>
            <div id="v-presetText" class="hint"></div>
          </div>
          <div class="six">
            <div class="grid">
              <div class="six"><label for="v-tmin">Min</label><input id="v-tmin" type="number" min="1" max="300" disabled></div>
              <div class="six"><label for="v-tmax">Max</label><input id="v-tmax" type="number" min="1" max="300" disabled></div>
            </div>
          </div>
          <div class="twelve">
            <label for="v-vocab-include">Vocabulary to Include (optional)</label>
            <textarea id="v-vocab-include" rows="3" placeholder="Paste a full or partial list of words to include..."></textarea>
          </div>
        </div>
        <div class="actions">
          <button id="v-gen" class="primary">Generate Vocabulary</button>
          <button id="v-excel">Download Excel</button>
          <button id="v-copy">Copy</button>
          <button id="v-prompt">Prompt</button>
          <div id="v-status" class="status"></div>
        </div>
      </div>
      <div id="v-output" class="output-container"><p>Your list will appear here...</p></div>`;
    $('gen-vocab').innerHTML=vocabUI;

    const genBtn=$('v-gen'),excelBtn=$('v-excel'),copyBtn=$('v-copy'),promptBtn=$('v-prompt'),statusEl=$('v-status'),outputEl=$('v-output'),
          levelEl=$("v-level"),tmodeEl=$("v-tmode"),tminEl=$("v-tmin"),tmaxEl=$("v-tmax"),
          presetTextEl=$("v-presetText"),topicEl=$("v-topic"),vocabIncludeEl=$("v-vocab-include");

    const allBox = $('v-sec-all');
    const childBoxes = Array.from(document.querySelectorAll('.v-sec'));
    function setChildren(checked){ childBoxes.forEach(b=>b.checked=checked); }
    function syncAll(){ allBox.checked = childBoxes.every(b=>b.checked); }
    allBox.addEventListener('change', ()=> setChildren(allBox.checked));
    childBoxes.forEach(b=> b.addEventListener('change', syncAll));
    function selectedSections(){
      if (allBox.checked) return ['nouns','verbs','descriptive','phrases','questions'];
      const vals = childBoxes.filter(b=>b.checked).map(b=>b.value);
      return vals.length ? vals : ['nouns','verbs','descriptive','phrases','questions'];
    }

    const presetRanges={"1":{min:33,max:55},"2":{min:60,max:85},"3":{min:90,max:120},"4":{min:120,max:180},"5":{min:160,max:240}};
    const levelTexts={"1":"Level 1‚ÄîSurvival","2":"Level 2‚ÄîBeginner","3":"Level 3‚ÄîIntermediate","4":"Level 4‚ÄîConversational","5":"Level 5‚ÄîFluent"};
    function updateUI(){
      const isCustom=tmodeEl.value==='custom';
      const range=presetRanges[levelEl.value];
      tminEl.disabled=!isCustom; tmaxEl.disabled=!isCustom;
      if(!isCustom){tminEl.value=range.min; tmaxEl.value=range.max;}
      if (isCustom){
        if (+tminEl.value > 300) tminEl.value = 300;
        if (+tmaxEl.value > 300) tmaxEl.value = 300;
      }
      presetTextEl.textContent=`Preset for ${levelTexts[levelEl.value]}: ${range.min}‚Äì${range.max} words. (Custom max = 300)`;
    }
    tmodeEl.addEventListener('change',updateUI); levelEl.addEventListener('change',updateUI); updateUI();

    /* ---------- Prompt builder: INSTRUCTIONS (plain text; Word + CSV) ---------- */
    function buildVocabInstruction(){
      const secs = selectedSections();
      const includeN = secs.includes('nouns'), includeV = secs.includes('verbs'), includeD = secs.includes('descriptive'),
            includeP = secs.includes('phrases'), includeQ = secs.includes('questions');

      let minCount, maxCount;
      if (tmodeEl.value==='custom'){
        minCount = Math.max(1, Math.min(300, Number(tminEl.value) || 1));
        maxCount = Math.max(minCount, Math.min(300, Number(tmaxEl.value) || minCount));
      } else {
        const r = presetRanges[levelEl.value];
        minCount = r.min; maxCount = r.max;
      }

      const onlySections = [
        includeN?'Nouns':null,
        includeV?'Verbs':null,
        includeD?'Descriptive Words':null,
        includeP?'Common Phrases':null,
        includeQ?'Common Questions':null
      ].filter(Boolean).join(', ');

      const teacherIncl = vocabIncludeEl.value ? vocabIncludeEl.value.replace(/[\r\n]+/g,'; ') : 'None';
      const levelLines = getLevelRulesLines(levelEl.value);

      return [
`You are an expert assistant for the Fast Conversational Spanish (FCS) program.`,
`IMPORTANT: Do NOT return HTML. Produce output in TWO PARTS so I can read it in chat and paste into Word/Excel.`,
`Topic: "${topicEl.value}". Level label: "${levelTexts[levelEl.value]}".`,
`Sections to generate (strictly this subset, in order): ${onlySections || '(none)'}.`,
`Total DISTINCT Spanish vocabulary items across Nouns + Verbs + Descriptive Words must be BETWEEN ${minCount} and ${maxCount}.`,
`Teacher-provided vocabulary to include when natural: ${teacherIncl}.`,
`LEVEL-SPECIFIC MUST-FOLLOW RULES:\n- ${levelLines.join('\n- ')}`,

`PART A ‚Äî READABLE VIEW (for Word):
- Use Markdown headings per section (e.g., "## Nouns / Sustantivos").
- Under each section, provide a Markdown table with columns exactly: "English" | "Espa√±ol".
- Mark target vocabulary inline using tags (for readability): English target = [EN]word[/EN], Spanish target = [ES]palabra[/ES].
- Nouns: prefer ‚ÄúHere is ‚Ä¶‚Äù or ‚ÄúIt is ‚Ä¶‚Äù when natural.
- Verbs: third-person only (He/She/It/They) and ALWAYS use ‚Äúis/are going to + [infinitive] ‚Ä¶‚Äù.
- Descriptive Words: present tense; wrap ONLY the single descriptive word in [EN] / [ES] (do NOT mark nouns in this section; exactly one marked descriptive word per row).
- Common Phrases: write natural full sentences; no target-mark tags needed for the whole line.
- Common Questions: each item is two rows ‚Äî first row is the bold question in both languages, second row is the answer in both languages; include a blank spacer row after each Q&A.
- At the end of Part A, add a single line: "Spanish vocab count (Nouns+Verbs+Descriptive): X".`,

`PART B ‚Äî EXCEL EXPORT (CSV):
- Provide ONE CSV code block (use triple backticks with "csv" language hint) titled CSV_EXPORT.
- Header row exactly: "Section","English","Espa√±ol".
- Include ALL rows across all sections in ONE CSV. Add a "Section" value like "Nouns", "Verbs", "Descriptive Words", "Common Phrases", "Common Questions ‚Äî Q", "Common Questions ‚Äî A".
- For Common Questions, put the question row tagged "Common Questions ‚Äî Q", then the answer row tagged "Common Questions ‚Äî A". Insert an extra empty CSV row after each Q&A pair with "Common Questions" in the Section column and empty English/Espa√±ol cells.
- Quote every field with double quotes; escape any embedded quotes by doubling them. Keep UTF-8. No extra commentary before/after the CSV block.`,

`GLOBAL RULES:
- Absolutely no HTML.
- Do not leave any section empty if it was requested.
- Alphabetize items inside each section by the English term; keep sentences natural and level-appropriate.
- Ensure the DISTINCT Spanish vocab count requirement is satisfied exactly for Nouns+Verbs+Descriptive (do not count Phrases/Questions).`
      ].join('\n');
    }

    /* ---- Build actual HTML prompt (app generation) ---- */
    function buildVocabPrompt(){
      const secs = selectedSections();
      const includeN = secs.includes('nouns'), includeV = secs.includes('verbs'), includeD = secs.includes('descriptive'),
            includeP = secs.includes('phrases'), includeQ = secs.includes('questions');

      let minCount, maxCount;
      if (tmodeEl.value==='custom'){
        minCount = Math.max(1, Math.min(300, Number(tminEl.value) || 1));
        maxCount = Math.max(minCount, Math.min(300, Number(tmaxEl.value) || minCount));
      } else {
        const r = presetRanges[levelEl.value];
        minCount = r.min; maxCount = r.max;
      }

      const onlySections = [
        includeN?'Nouns':null,
        includeV?'Verbs':null,
        includeD?'Descriptive Words':null,
        includeP?'Common Phrases':null,
        includeQ?'Common Questions':null
      ].filter(Boolean).join(', ');

      const rules = [
        `Generate ONLY these sections: ${onlySections}. Do NOT include any other section header.`,
        "Two columns only: English | Espa√±ol. Use full sentences.",
        "Highlight target vocabulary with <span class=\"en\"> (English) and <span class=\"es\"> (Spanish).",
        "Alphabetize items inside each section by the English term. Use natural, everyday wording.",
        `You MUST produce a total of DISTINCT Spanish vocabulary words BETWEEN ${minCount} and ${maxCount} IN Nouns, Verbs, Descriptive Words ONLY. Count = unique <span class=\"es\"> terms in those sections. Do NOT count Phrases/Questions.`,
        "Nouns: prefer starters like ‚ÄúHere is ‚Ä¶‚Äù or ‚ÄúIt is ‚Ä¶‚Äù when natural.",
        "Verbs: third-person only (He/She/It/They) and ALWAYS use ‚Äúis/are going to + [infinitive] ‚Ä¶‚Äù.",
        "Descriptive: present tense sentences; wrap ONLY the single descriptive word (adjective/adverb) in <span class=\"en\"> / <span class=\"es\">. Do NOT color any nouns in this section; exactly one colored descriptive word per row.",
        "Common Phrases: wrap the entire English cell and the entire Spanish cell in <span class=\"full-black\">‚Ä¶</span> so the whole sentence is black.",
        "Common Questions: question line bold in both languages; answer line normal; BOTH full sentences wrapped in <span class=\"full-black\">‚Ä¶</span>; add an empty spacer row after each Q&A.",
        `Include these specific terms if provided: ${vocabIncludeEl.value ? vocabIncludeEl.value.replace(/</g,"&lt;").replace(/>/g,"&gt;") : 'None'}.`,
        "No table may have an empty <tbody>. If a section is requested, populate it fully."
      ];
      const levelLines = getLevelRulesLines(levelEl.value);

      let sectionsHTML = "";
      if (includeN) sectionsHTML += `<div class="section"><h2>Nouns / Sustantivos</h2>
        <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
      </div>`;
      if (includeV) sectionsHTML += `<div class="section"><h2>Verbs / Verbos</h2>
        <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
      </div>`;
      if (includeD) sectionsHTML += `<div class="section"><h2>Descriptive Words / Palabras descriptivas</h2>
        <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
      </div>`;
      if (includeP) sectionsHTML += `<div class="section"><h2>Common Phrases / Frases comunes</h2>
        <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
      </div>`;
      if (includeQ) sectionsHTML += `<div class="section"><h2>Common Questions / Preguntas comunes</h2>
        <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
      </div>`;

      const prompt =
`<!DOCTYPE html>
<!-- FCS VOCABULARY OUTPUT -->
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vocabulary ‚Äî ${topicEl.value}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a;}
  *{box-sizing:border-box} body{font-family:Calibri,Arial,sans-serif;font-size:10pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:14px;overflow-x:auto}
  .legend{font-size:9pt;color:var(--muted);text-align:center;margin:6px 0 0 0}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:6px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700} .es{color:var(--es);font-weight:700}
  .full-black{color:var(--ink);font-weight:700}
  @media(max-width:700px){ .tbl{font-size:9pt;width:auto} }
</style></head>
<body><div class="fcs-doc" lang="en">
  <h1>Vocabulary: ${topicEl.value} ‚Äî ${levelTexts[levelEl.value]}</h1>
  <div class="legend"><span class="en">English blue</span> | <span class="es">Spanish red</span> (phrases & questions: full black)</div>

  <!-- STRICT RULES:
    ${rules.map((r,i)=>`${i+1}) ${r}`).join('\n    ')}
    LEVEL-SPECIFIC MUST-FOLLOW RULES:
    - ${getLevelRulesLines(levelEl.value).join('\n    - ')}
  -->

  ${sectionsHTML}
</div></body></html>`;
      return prompt;
    }

    /* ---- Generate (unchanged UI/output) ---- */
    genBtn.addEventListener('click', async ()=>{
      if(!topicEl.value.trim()){statusEl.textContent="Please enter a topic.";return;}

      const prompt = buildVocabPrompt();

      const validator = (html)=>{
        try{
          const doc = new DOMParser().parseFromString(html,'text/html');
          const secs = selectedSections();
          const includeN = secs.includes('nouns'), includeV = secs.includes('verbs'), includeD = secs.includes('descriptive'),
                includeP = secs.includes('phrases'), includeQ = secs.includes('questions');
          const want = { nouns:includeN, verbs:includeV, descriptive:includeD, phrases:includeP, questions:includeQ };
          const nameToRegex = {
            nouns:/^\s*Nouns/i, verbs:/^\s*Verbs/i, descriptive:/^\s*Descriptive/i,
            phrases:/^\s*Common Phrases/i, questions:/^\s*Common Questions/i
          };
          const problems = [];

          for (const key of Object.keys(want)){
            const sec = Array.from(doc.querySelectorAll('.section h2')).find(h=>nameToRegex[key].test(h.textContent||''));
            if (want[key]) {
              if(!sec) { problems.push(`missing required section: ${key}`); continue; }
              const tbody = sec.parentElement.querySelector('tbody');
              if(!tbody || !tbody.querySelector('tr')) problems.push(`empty section: ${key}`);
            } else {
              if (sec) problems.push(`forbidden extra section present: ${key}`);
            }
          }

          function esWordsIn(h2regex){
            const h2 = Array.from(doc.querySelectorAll('.section h2')).find(h=>h2regex.test(h.textContent||''));
            if(!h2) return [];
            const tbody = h2.parentElement.querySelector('tbody'); if(!tbody) return [];
            return Array.from(tbody.querySelectorAll('span.es')).map(s=>(s.textContent||'').trim().toLowerCase()).filter(Boolean);
          }
          let allEs = [];
          if(includeN) allEs=allEs.concat(esWordsIn(/^\s*Nouns/i));
          if(includeV) allEs=allEs.concat(esWordsIn(/^\s*Verbs/i));
          if(includeD) allEs=allEs.concat(esWordsIn(/^\s*Descriptive/i));
          const count = Array.from(new Set(allEs)).length;

          const presetRanges={"1":{min:33,max:55},"2":{min:60,max:85},"3":{min:90,max:120},"4":{min:120,max:180},"5":{min:160,max:240}};
          const isCustom = (tmodeEl.value==='custom');
          const min = isCustom ? Math.max(1, Math.min(300, Number(tminEl.value)||1)) : presetRanges[levelEl.value].min;
          const max = isCustom ? Math.max(min, Math.min(300, Number(tmaxEl.value)||min)) : presetRanges[levelEl.value].max;
          if (count < min || count > max)
            problems.push(`Spanish vocab count ${count} outside required range ${min}‚Äì${max}`);

          function fullBlackOK(h2regex){
            const h2 = Array.from(doc.querySelectorAll('.section h2')).find(h=>h2regex.test(h.textContent||''));
            if(!h2) return true;
            const rows = Array.from(h2.parentElement.querySelectorAll('tbody tr'));
            if(!rows.length) return false;
            return rows.every(tr=>{
              const tds=Array.from(tr.querySelectorAll('td'));
              if(tds.length<2) return true;
              const [en, es] = tds;
              const enSpan = en.querySelector('span.full-black');
              const esSpan = es.querySelector('span.full-black');
              if(!enSpan || !esSpan) return false;
              return (enSpan.textContent||'').trim() === (en.textContent||'').trim()
                && (esSpan.textContent||'').trim() === (es.textContent||'').trim();
            });
          }
          if(secs.includes('phrases') && !fullBlackOK(/^\s*Common Phrases/i)) problems.push('Phrases lines must be fully wrapped in <span class="full-black">‚Ä¶</span>');
          if(secs.includes('questions') && !fullBlackOK(/^\s*Common Questions/i)) problems.push('Questions lines must be fully wrapped in <span class="full-black">‚Ä¶</span>');

          if (secs.includes('descriptive')){
            const h2 = Array.from(doc.querySelectorAll('.section h2')).find(h=>/^\s*Descriptive/i.test(h.textContent||''));
            if (h2){
              const rows = Array.from(h2.parentElement.querySelectorAll('tbody tr'));
              rows.forEach((tr, i)=>{
                const tds = Array.from(tr.querySelectorAll('td'));
                if (tds.length<2) return;
                const enCount = tds[0].querySelectorAll('span.en').length;
                const esCount = tds[1].querySelectorAll('span.es').length;
                if (enCount !== 1 || esCount !== 1){
                  problems.push(`Descriptive row ${i+1}: must color ONLY the single descriptive word (exactly one <span class="en"> and one <span class="es">)`);
                }
              });
            }
          }

          return problems.length ? problems.join('; ') : '';
        }catch(e){ return ''; }
      };

      await generateResultWithRetries(prompt, genBtn, statusEl, outputEl, validator, 1);
      await Speech.ensureVoices();
      addPerLineTTS(outputEl);
      genBtn.disabled = false;
    });

    /* ---- Prompt button: copies INSTRUCTIONS text (Word + CSV) ---- */
    promptBtn.addEventListener('click', ()=>{
      if(!topicEl.value.trim()){statusEl.textContent="Please enter a topic.";return;}
      const instruction = buildVocabInstruction();
      copyText(instruction, statusEl);
    });

    $('v-copy').addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    $('v-excel').addEventListener('click',()=>downloadAsExcel(outputEl,statusEl,topicEl.value||'Vocabulary'));
  })();

  /* =========================
     Conversation (incl. Level 6 lock)
     ========================= */
  (function setupConvo(){
    const convoUI =
      `<div class="fcs-card"><h2>Conversation Creator</h2>
        <div class="grid-2">
          <div class="grid-full"><label for="c-topic">Topic</label><input id="c-topic" type="text" placeholder="e.g., A funny story about a vacation"/></div>

          <div><label>Level (Grammar)</label>
            <select id="c-level">
              <option value="1" selected>Level 1 ‚Äî Survival</option>
              <option value="2">Level 2 ‚Äî Beginner</option>
              <option value="3">Level 3 ‚Äî Intermediate</option>
              <option value="4">Level 4 ‚Äî Conversational</option>
              <option value="5">Level 5 ‚Äî Fluent</option>
              <option value="6">Level 6 ‚Äî Native</option>
            </select>
          </div>

          <div><label># of Conversations</label><input id="c-numConvos" type="number" value="2" min="1"/></div>
          <div><label># of Speakers</label><input id="c-numSpeakers" type="number" value="2" min="1"/></div>

          <div class="grid-full" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;">
            <div><label>Turns (approx.)</label><input id="c-turns" type="number" value="10" min="1"/></div>
            <div><label>Sentences/Turn ‚Äî Min</label><input id="c-sentMin" type="number" value="2" min="1"/></div>
            <div><label>Sentences/Turn ‚Äî Max</label><input id="c-sentMax" type="number" value="4" min="1"/></div>
          </div>

          <div><label>Tone</label>
            <select id="c-tone"><option>Neutral, casual</option><option>Informal, friendly</option><option>Instructor, student</option><option>Customer, staff</option><option>Professional, formal</option><option>Street slang</option></select>
          </div>
          <div><label>Country / Region</label><select id="c-country"></select></div>

          <div class="grid-full"><label>Include English Translation</label><select id="c-includeEN"><option value="yes" selected>Yes</option><option value="no">No</option></select></div>
          <div><label>Add Fill-In-The-Blank (FIB)</label><select id="c-addFib"><option value="no">No</option><option value="yes" selected>Yes</option></select></div>
          <div><label>FIB Focus</label><select id="c-fibFocus"><option>Mixed</option><option>Vocab only</option><option>Grammar only</option><option>Verbs only</option></select></div>
          <div><label>Show FIB Answer Key</label><select id="c-showFIBKey"><option value="yes">Yes</option><option value="no">No</option></select></div>
          <div><label>Show Vocabulary List</label><select id="c-showVocabList"><option value="yes">Yes</option><option value="no">No</option></select></div>

          <div class="grid-full"><label for="c-vocab">Vocabulary (optional)</label><textarea id="c-vocab" rows="6" placeholder="Put your own vocabulary here..."></textarea></div>
          <div class="grid-full"><label>Optional Teacher Notes</label><textarea id="c-notes" rows="4"></textarea></div>
        </div>

        <div class="actions"><button id="c-gen" class="primary">Generate</button><button id="c-excel">Excel</button><button id="c-copy">Copy</button><button id="c-prompt">Prompt</button><div id="c-status" class="status"></div></div>
      </div>
      <div id="c-output" class="output-container"><p>Your conversation appears here...</p></div>`;
    $('gen-convo').innerHTML=convoUI;

    const countrySelect=$('c-country');
    const countries=["-no specific-","Argentina","Bolivia","Chile","Colombia","Costa Rica","Cuba","Dominican Republic","Ecuador","El Salvador","Equatorial Guinea","Guatemala","Honduras","Mexico","Nicaragua","Panama","Paraguay","Peru","Puerto Rico","Spain","Uruguay","Venezuela"];
    countrySelect.innerHTML=countries.map(c=>`<option>${c}</option>`).join('');

    const idsToMaybeLock = [
      'c-numConvos','c-numSpeakers','c-turns','c-sentMin','c-sentMax',
      'c-country','c-includeEN','c-addFib','c-fibFocus','c-showFIBKey','c-showVocabList','c-vocab','c-notes'
    ];
    function applyConvLevelLock(){
      const isNative = $('c-level').value === '6';
      idsToMaybeLock.forEach(id=>{
        const el = $(id);
        if(!el) return;
        el.disabled = isNative;
        if(isNative){
          if (id==='c-numConvos') el.value = 1;
          if (id==='c-numSpeakers') el.value = 1;
          if (id==='c-addFib') el.value = 'no';
          if (id==='c-showFIBKey') el.value = 'no';
          if (id==='c-showVocabList') el.value = 'no';
        }
      });
    }
    $('c-level').addEventListener('change', applyConvLevelLock);
    applyConvLevelLock();

    const genBtn=$('c-gen'),excelBtn=$('c-excel'),copyBtn=$('c-copy'),promptBtn=$('c-prompt'),statusEl=$('c-status'),outputEl=$('c-output');

    /* ---------- Prompt builder: INSTRUCTIONS (plain text; Word + CSV) ---------- */
    function buildConvoInstruction(){
      const topic=$('c-topic').value.trim();
      const sentMin = Math.max(1, Number($('c-sentMin').value)||2);
      const sentMax = Math.max(sentMin, Number($('c-sentMax').value)||4);
      const turnsApprox = Math.max(1, Number($('c-turns').value)||10);
      const fibCount = Math.max(8, Math.min(30, Math.round(turnsApprox * 0.8)));

      const ui = {
        topic,
        level: $('c-level').value,
        sentences_per_turn: { min: sentMin, max: sentMax },
        vocab: $('c-vocab').value || "(auto-generate level-appropriate list if empty)",
        numConvos: Math.max(1, Number($('c-numConvos').value)||1),
        numSpeakers: Math.max(1, Number($('c-numSpeakers').value)||1),
        turnsApprox,
        tone: $('c-tone').value,
        region: $('c-country').value,
        includeEN: $('c-includeEN').value,
        addFIB: $('c-addFib').value,
        fibFocus: $('c-fibFocus').value,
        showFIBKey: $('c-showFIBKey').value,
        showVocabList: $('c-showVocabList').value,
        teacherNotes: $('c-notes').value||""
      };

      const isNative = ui.level === '6';
      const levelLines = getLevelRulesLines(ui.level);

      const header = [
        `You are an expert assistant for the Fast Conversational Spanish (FCS) program.`,
        `IMPORTANT: Do NOT return HTML. Produce output in TWO PARTS so I can read it in chat and paste into Word/Excel.`,
        `Topic: "${ui.topic}". Level: ${ui.level}. Tone: "${ui.tone}". Region/culture cues: "${ui.region}".`,
        ui.vocab && ui.vocab !== "(auto-generate level-appropriate list if empty)"
          ? `Teacher vocabulary (use naturally when appropriate): ${ui.vocab.replace(/[\r\n]+/g,'; ')}`
          : `Vocabulary: auto-generate, level-appropriate.`,
        `LEVEL-SPECIFIC MUST-FOLLOW RULES:\n- ${levelLines.join('\n- ')}`
      ];

      const baseRules = [
        `Create EXACTLY ${isNative ? 1 : ui.numConvos} conversation section${(isNative || ui.numConvos===1)?'':'s'} titled "Conversation 1", "Conversation 2", ...`,
        `Use exactly ${isNative ? 1 : ui.numSpeakers} distinct speaker name${(isNative || ui.numSpeakers===1)?'':'s'} that fit the selected region.`,
        ...(isNative ? [] : [
          `Every turn must contain between ${ui.sentences_per_turn.min} and ${ui.sentences_per_turn.max} sentences in Spanish (and English if included).`
        ]),
        (ui.includeEN==='yes'
          ? `Tables are two-column: "English" | "Espa√±ol".`
          : `Tables are single-column: "Espa√±ol" only.`),
        `Keep the flow natural and realistic; mix short replies with longer turns; avoid robotic symmetry.`
      ];

      const fibRules = (isNative || ui.addFIB!=='yes') ? [] : [
        `Include a Fill-in-the-Blank section with exactly ${fibCount} items.`,
        `Readable View rule:`,
        `‚Ä¢ English cell = full, natural English sentence corresponding to Spanish; NO blanks; the translated target word is wrapped in [EN]...[/EN].`,
        `‚Ä¢ Espa√±ol cell = full Spanish sentence with the target Spanish word replaced by "________"; immediately BEFORE the blank include the English word in parentheses (exactly the same text as inside [EN]...[/EN]).`,
        ui.showFIBKey==='yes'
          ? `Provide a numbered Answer Key (answers only) after FIB.`
          : `Do NOT include an Answer Key.`
      ];

      const vocabListRule = (isNative || ui.showVocabList!=='yes') ? [] : [
        `After conversations (and FIB if present), include a "Vocabulary Used" list.`
      ];

      const nativeOverride = isNative ? [
        `LEVEL 6 ‚Äî NATIVE OVERRIDE (STRICT):`,
        `‚Ä¢ Output ONLY one conversation ("Conversation 1").`,
        `‚Ä¢ Exactly one speaker (a native-sounding name). Produce a VERY LONG, cohesive monologue in Spanish (and English column too if includeEN = "yes"), reflecting the tone "${ui.tone}". You may split the monologue into several turns by the same speaker for readability.`,
        `‚Ä¢ Ignore the sentences-per-turn min/max; prioritize long, natural discourse with depth and nuance.`,
        `‚Ä¢ Do NOT include FIB, Vocabulary Used, or Answer Key.`
      ] : [];

      const partA = [
        `PART A ‚Äî READABLE VIEW (for Word):`,
        `- Use Markdown headings: "## Conversation 1", etc.`,
        (ui.includeEN==='yes'
          ? `- Under each heading, provide a Markdown table with columns exactly "English" | "Espa√±ol".`
          : `- Under each heading, provide a Markdown table with a single "Espa√±ol" column.`),
        `- Keep names and punctuation as in natural dialogue.`
      ];

      const partB = [
        `PART B ‚Äî EXCEL EXPORT (CSV):`,
        `Return up to FOUR CSV code blocks using triple backticks and "csv" language hints, in this order (omit a block if section not present):`,
        `1) CSV_CONVERSATIONS ‚Äî header: "Conversation","Turn","Speaker","English","Espa√±ol". Include every conversation turn. Quote every field with double quotes; escape embedded quotes by doubling them.`,
        (!isNative && ui.addFIB==='yes') ? `2) CSV_FIB ‚Äî header: "English","Espa√±ol". Follow the FIB formatting rules (English sentence with [EN]target[/EN]; Spanish sentence with "(target) ________").` : null,
        (!isNative && ui.showVocabList==='yes') ? `3) CSV_VOCAB_USED ‚Äî header: "English","Espa√±ol".` : null,
        (!isNative && ui.showFIBKey==='yes') ? `4) CSV_ANSWER_KEY ‚Äî header: "#","Answer".` : null,
        `No extra commentary before/after CSV blocks; keep UTF-8.`
      ].filter(Boolean);

      const footer = [
        `GLOBAL RULES:`,
        `- Absolutely no HTML.`,
        `- Keep everything level-appropriate and on topic "${ui.topic}".`,
        `- Ensure per-turn sentence bounds (when not native level) are satisfied exactly.`
      ];

      return [...header, '', 'Rules (strict):', ...baseRules, ...fibRules, ...vocabListRule, ...nativeOverride, '', ...partA, '', ...partB, '', ...footer].join('\n');
    }

    /* ---- Build actual HTML prompt (app generation) ---- */
    function buildConvoPrompt(){
      const topic=$('c-topic').value.trim();
      const sentMin = Math.max(1, Number($('c-sentMin').value)||2);
      const sentMax = Math.max(sentMin, Number($('c-sentMax').value)||4);
      const turnsApprox = Math.max(1, Number($('c-turns').value)||10);

      const ui = {
        topic,
        level: $('c-level').value,
        sentences_per_turn: { min: sentMin, max: sentMax },
        vocab: $('c-vocab').value || "(auto-generate level-appropriate list if empty)",
        numConvos: Math.max(1, Number($('c-numConvos').value)||1),
        numSpeakers: Math.max(1, Number($('c-numSpeakers').value)||1),
        turnsApprox,
        tone: $('c-tone').value,
        region: $('c-country').value,
        includeEN: $('c-includeEN').value,
        addFIB: $('c-addFib').value,
        fibFocus: $('c-fibFocus').value,
        showFIBKey: $('c-showFIBKey').value,
        showVocabList: $('c-showVocabList').value,
        teacherNotes: $('c-notes').value||""
      };

      const isNative = ui.level === '6';
      const uiForModel = isNative ? {
        ...ui, numConvos: 1, numSpeakers: 1, addFIB: 'no', showFIBKey: 'no', showVocabList: 'no'
      } : ui;

      const prompt =
`<!DOCTYPE html>
<!-- FCS CONVERSATION OUTPUT (full HTML) -->
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conversation ‚Äî ${uiForModel.topic}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a;--hi:#eef2ff}
  *{box-sizing:border-box}
  body{font-family:Calibri,Arial,sans-serif;font-size:11pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin:14px 0;overflow-x:auto}
  .legend{font-size:9pt;color:var(--muted);text-align:center;margin-top:6px}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:8px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700}
  .es{color:var(--es);font-weight:700}
  @media(max-width:700px){ .tbl{font-size:9pt;width:auto}.tbl thead{display:none}.tbl td{display:block;width:100%}.tbl td+td{margin-top:6px} }
</style>
</head>
<body>
<div class="fcs-doc">
  <h1>Conversation: ${uiForModel.topic} ‚Äî Level ${uiForModel.level}</h1>
  <div class="legend"><span class="en">EN vocab = blue</span> | <span class="es">ES vocab = red</span>.</div>

  <!-- CONTRACT (STRICT):
    UI = ${JSON.stringify(uiForModel)}
    - Create EXACTLY UI.numConvos conversation sections titled "Conversation 1", "Conversation 2", ... .
    - Each conversation uses names typical of UI.region. Use exactly UI.numSpeakers distinct speakers (no anonymous "A/B").
    - Topic must stay on "${uiForModel.topic}"; tone must be "${uiForModel.tone}" and level-appropriate for Level ${uiForModel.level}.
    - LEVEL-SPECIFIC MUST-FOLLOW RULES:
      - ${getLevelRulesLines(uiForModel.level).join('\n      - ')}

    ${isNative ? `
    === NATIVE OVERRIDE (Level 6 ‚Äî Native) ===
    - Output ONLY conversation sections (no FIB, no Vocabulary Used, no Answer Key).
    - EXACTLY one conversation: "Conversation 1".
    - EXACTLY one speaker (a native voice name). Produce a VERY LONG, cohesive monologue in Spanish (and English column too if UI.includeEN === "yes"), that fully reflects "${uiForModel.tone}" and real-life flow. Use natural paragraph-like turns (you may split the monologue into several turns by the same speaker).
    - Ignore sentence-per-turn constraints; prioritize long, natural discourse with depth and nuance.
    ` : `
    - Keep the flow natural and realistic: mix short replies with longer turns; avoid robotic symmetry.
    - Every turn contains between UI.sentences_per_turn.min and UI.sentences_per_turn.max sentences in Spanish (and English if included).
    - If UI.addFIB === "yes": include a Fill-in-the-Blank section with ${Math.max(8, Math.min(30, Math.round(uiForModel.turnsApprox * 0.8)))} items.
      * Table headers must be EXACTLY "English" and "Espa√±ol".
      * Each row has TWO cells ONLY:
          [English]  = A full, natural English sentence corresponding to the Spanish sentence. Do NOT include blanks.
                       The translated target word/phrase MUST be wrapped in <span class="en">‚Ä¶</span> (bold blue).
          [Espa√±ol]  = A full Spanish sentence where the target Spanish word is missing and replaced by "________".
                       Immediately BEFORE the blank, include the English word (the same as inside <span class="en">‚Ä¶</span>) in parentheses.
                       Example: Cuando lleguemos al (airport) ________ , tomamos un taxi.
      * Do NOT include answers/keys/bullets/numbering or extra notes inside the FIB table cells.
      * If UI.showFIBKey === "yes": provide answers in the separate "Answer Key" section only.
    - If UI.showFIBKey === "yes": provide a numbered Answer Key (answers only).
    - If UI.showVocabList === "yes": include a "Vocabulary Used" table (EN|ES).
    `}
    - SELF-CHECK BEFORE RETURNING: section counts, speaker count, and (if not native) per-turn sentence bounds and FIB format.
  -->

  ${Array.from({length: uiForModel.numConvos}).map((_,i)=>`
  <div class="section">
    <h2>Conversation ${i+1}</h2>
    <table class="tbl">
      <thead>
        ${uiForModel.includeEN==='yes'
          ? '<tr><th>English</th><th lang="es">Espa√±ol</th></tr>'
          : '<tr><th lang="es">Espa√±ol</th></tr>'}
      </thead>
      <tbody></tbody>
    </table>
  </div>`).join('')}

  ${(!isNative && uiForModel.addFIB==='yes') ? `
  <div class="section">
    <h2>Practice ‚Äî Fill-in-the-Blank (${uiForModel.fibFocus})</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
  </div>` : ''}

  ${(!isNative && uiForModel.showVocabList==='yes') ? `
  <div class="section">
    <h2>Vocabulary Used</h2>
    <table class="tbl"><thead><tr><th>English</th><th lang="es">Espa√±ol</th></tr></thead><tbody></tbody></table>
  </div>` : ''}

  ${(!isNative && uiForModel.showFIBKey==='yes') ? `
  <div class="section">
    <h2>Answer Key</h2>
    <table class="tbl"><thead><tr><th>#</th><th>Answer</th></tr></thead><tbody></tbody></table>
  </div>` : ''}

  ${uiForModel.vocab && uiForModel.vocab!=="(auto-generate level-appropriate list if empty)" ? 
  `<div class="legend" style="white-space:pre-wrap;border:1px dashed var(--border);padding:8px;border-radius:8px;margin-top:8px;">
    Teacher Vocabulary (STRICT use):\n${uiForModel.vocab.replace(/</g,"&lt;").replace(/>/g,"&gt;")}
  </div>` : ''}

  ${uiForModel.teacherNotes ? `<div class="legend" style="white-space:pre-wrap;margin-top:8px;">Teacher notes:\n${uiForModel.teacherNotes.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>` : ''}

</div>
</body>
</html>`;
      return { prompt, ui, uiForModel, isNative };
    }

    /* ---- Generate (unchanged UI/output) ---- */
    genBtn.addEventListener('click', async ()=>{
      const topic=$('c-topic').value.trim(); if(!topic){statusEl.textContent="Enter a topic.";return;}
      const { prompt, ui, uiForModel, isNative } = buildConvoPrompt();

      const validator = (html)=>{
        try{
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const problems = [];

          const convH2s = Array.from(doc.querySelectorAll('.section h2')).filter(h=>/Conversation\s+\d+/i.test(h.textContent||''));
          if (convH2s.length !== uiForModel.numConvos) problems.push(`need exactly ${uiForModel.numConvos} conversation sections, found ${convH2s.length}`);

          if (isNative){
            const tbl = convH2s[0]?.parentElement.querySelector('table');
            if(!tbl){ problems.push('native: missing conversation table'); }
            else {
              const speakerNames = new Set(Array.from(tbl.querySelectorAll('tbody td'))
                .map(td=>(td.textContent||'').trim().match(/^([A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±'‚Äô\-]+)\s*:/))
                .filter(Boolean).map(m=>m[1]));
              if (speakerNames.size !== 1) problems.push(`native: expected exactly 1 speaker, found ${speakerNames.size||0}`);

              const ths = Array.from(tbl.querySelectorAll('thead th')).map(th=>th.textContent.trim().toLowerCase());
              const esIdx = ths.findIndex(t=>t.includes('espa√±ol')||t.includes('espanol'));
              const rows = Array.from(tbl.querySelectorAll('tbody tr'));
              let totalEsSent = 0;
              rows.forEach(tr=>{
                const tds=Array.from(tr.querySelectorAll('td'));
                const esText=(tds[(esIdx<0?tds.length-1:esIdx)]?.textContent||'').trim();
                if (esText){
                  const sCount = (esText.replace(/\s+/g,' ').match(/[^\.!?]+[\.!?]+/g)||[esText]).length;
                  totalEsSent += sCount;
                }
              });
              if (totalEsSent < 25) problems.push(`native: monologue too short (${totalEsSent} sentences); expand substantially`);
            }

            const hasFIB = Array.from(doc.querySelectorAll('.section h2')).some(h=>/Fill\-in\-the\-Blank|Practice/i.test(h.textContent||''));
            const hasVU  = Array.from(doc.querySelectorAll('.section h2')).some(h=>/Vocabulary Used/i.test(h.textContent||''));
            const hasAK  = Array.from(doc.querySelectorAll('.section h2')).some(h=>/Answer Key/i.test(h.textContent||''));
            if (hasFIB) problems.push('native: FIB section must not be present');
            if (hasVU)  problems.push('native: Vocabulary Used section must not be present');
            if (hasAK)  problems.push('native: Answer Key section must not be present');
          } else {
            convH2s.forEach((h2, idx)=>{
              const tbl = h2.parentElement.querySelector('table'); if(!tbl){problems.push(`conv ${idx+1}: missing table`); return;}
              const ths = Array.from(tbl.querySelectorAll('thead th')).map(th=>th.textContent.trim().toLowerCase());
              if (uiForModel.includeEN==='yes'){
                if (!ths.includes('english') || !ths.find(t=>t.includes('espa√±ol')||t.includes('espanol'))) problems.push(`conv ${idx+1}: must have English | Espa√±ol headers`);
              } else {
                if (ths.length!==1 || !(ths[0].includes('espa√±ol')||ths[0].includes('espanol'))) problems.push(`conv ${idx+1}: must have only Espa√±ol column`);
              }
              const rows = Array.from(tbl.querySelectorAll('tbody tr'));
              rows.forEach((tr, ri)=>{
                const tds = Array.from(tr.querySelectorAll('td'));
                const esIdx = (uiForModel.includeEN==='yes') ? 1 : 0;
                const esText = (tds[esIdx]?.textContent||'').trim();
                if (esText){
                  const sCount = (esText.replace(/\s+/g,' ').match(/[^\.!?]+[\.!?]+/g)||[esText]).length;
                  if (sCount < uiForModel.sentences_per_turn.min || sCount > uiForModel.sentences_per_turn.max){
                    problems.push(`conv ${idx+1} row ${ri+1} (ES): ${sCount} sentences (must be ${uiForModel.sentences_per_turn.min}-${uiForModel.sentences_per_turn.max})`);
                  }
                }
                if (uiForModel.includeEN==='yes'){
                  const enText = (tds[0]?.textContent||'').trim();
                  if (enText){
                    const sCountEn = (enText.replace(/\s+/g,' ').match(/[^\.!?]+[\.!?]+/g)||[enText]).length;
                    if (sCountEn < uiForModel.sentences_per_turn.min || sCountEn > uiForModel.sentences_per_turn.max){
                      problems.push(`conv ${idx+1} row ${ri+1} (EN): ${sCountEn} sentences (must be ${uiForModel.sentences_per_turn.min}-${uiForModel.sentences_per_turn.max})`);
                    }
                  }
                }
              });

              const speakerNames = new Set(Array.from(tbl.querySelectorAll('tbody td'))
                .map(td=>(td.textContent||'').trim().match(/^([A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±'‚Äô\-]+)\s*:/))
                .filter(Boolean).map(m=>m[1]));
              if (speakerNames.size && speakerNames.size !== uiForModel.numSpeakers){
                problems.push(`conv ${idx+1}: expected ${uiForModel.numSpeakers} distinct speakers, found ${speakerNames.size}`);
              }
            });

            if (uiForModel.addFIB==='yes'){
              const fibH2 = Array.from(doc.querySelectorAll('.section h2')).find(h=>/Fill\-in\-the\-Blank|Practice/i.test(h.textContent||''));
              if(!fibH2){ problems.push('missing Fill-in-the-Blank section'); }
              else{
                const table = fibH2.parentElement.querySelector('table');
                if(!table){ problems.push('FIB: missing table'); }
                else{
                  const ths = Array.from(table.querySelectorAll('thead th')).map(th=>th.textContent.trim());
                  if (ths[0] !== 'English' || ths[1] !== 'Espa√±ol') problems.push('FIB headers must be exactly "English" and "Espa√±ol"');

                  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

                  const rows = Array.from(table.querySelectorAll('tbody tr'));
                  if (!rows.length) problems.push('FIB: empty tbody');
                  rows.forEach((tr, idx)=>{
                    const tds = Array.from(tr.querySelectorAll('td'));
                    if (tds.length < 2){ problems.push(`FIB row ${idx+1}: needs two cells`); return; }

                    const enCell = tds[0];
                    const esCell = tds[1];
                    const enText = (enCell.textContent||'').trim();
                    const esText = (esCell.textContent||'').trim();

                    if (!enText) problems.push(`FIB row ${idx+1}: empty English cell`);

                    const enSpan = enCell.querySelector('span.en');
                    if (!enSpan || !(enSpan.textContent||'').trim()){
                      problems.push(`FIB row ${idx+1}: English must include <span class="en">target</span>`);
                    }
                    if (/_{2,}/.test(enText)) problems.push(`FIB row ${idx+1}: English sentence must NOT include blanks`);

                    const hintRaw = (enSpan ? enSpan.textContent : '').trim();
                    if (!hintRaw){
                      if (!/\([^)]*\)\s*_+/.test(esText)) problems.push(`FIB row ${idx+1}: Spanish must contain a hint in parentheses before the blank`);
                    } else {
                      const hintRegex = new RegExp("\\(" + escapeRegExp(hintRaw) + "\\)\\s*_+", "i");
                      if (!hintRegex.test(esText)) problems.push(`FIB row ${idx+1}: Spanish must contain "(${hintRaw}) ________" with the hint immediately before the blank`);
                    }
                    if (!/_{6,}/.test(esText)) problems.push(`FIB row ${idx+1}: missing blank "________"`);
                  });
                }
              }
            }
          }

          return problems.length ? problems.join('; ') : '';
        }catch(e){ return ''; }
      };

      await generateResultWithRetries(prompt, genBtn, statusEl, outputEl, validator, 2);
      await Speech.ensureVoices();
      addPerLineTTS(outputEl);
      addConversationPlayers(outputEl);
      genBtn.disabled = false;
    });

    /* ---- Prompt button: copies INSTRUCTIONS text (Word + CSV) ---- */
    promptBtn.addEventListener('click', ()=>{
      const topic=$('c-topic').value.trim(); if(!topic){statusEl.textContent="Enter a topic.";return;}
      const instruction = buildConvoInstruction();
      copyText(instruction, statusEl);
    });

    $('c-copy').addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    $('c-excel').addEventListener('click', ()=>downloadAsExcel(outputEl,statusEl,$('c-topic').value||'Conversation'));
  })();

  /* =========================
     Test (unchanged)
     ========================= */
  (function setupTest(){
    const testUI =
      `<div class="fcs-card">
        <h2>Test Creator</h2>
        <div><label for="t-vocab">Vocabulary List</label><textarea id="t-vocab" rows="6" placeholder="Paste the EXACT vocabulary for the test..."></textarea></div>
        <div><label for="t-level">Level (Grammar)</label>
          <select id="t-level">
            <option value="1" selected>Level 1 ‚Äî Survival</option>
            <option value="2">Level 2 ‚Äî Beginner</option>
            <option value="3">Level 3 ‚Äî Intermediate</option>
            <option value="4">Level 4 ‚Äî Conversational</option>
            <option value="5">Level 5 ‚Äî Fluent</option>
          </select></div>
        <div><label><input type="checkbox" id="t-anskeys" checked> Include Teacher Answer Keys?</label></div>
        <div class="actions"><button id="t-gen" class="primary">Generate</button><button id="t-excel">Excel</button><button id="t-copy">Copy</button><div id="t-status" class="status"></div></div>
      </div>
      <div id="t-output" class="output-container"><p>Your test will appear here...</p></div>`;
    $('gen-test').innerHTML=testUI;

    const genBtn=$('t-gen'),excelBtn=$('t-excel'),copyBtn=$('t-copy'),statusEl=$('t-status'),outputEl=$('t-output');

    genBtn.addEventListener('click', async ()=>{
      const vocabEl=$('t-vocab'); if(!vocabEl.value.trim()){statusEl.textContent="Please paste a vocab list.";return;}
      const prompt =
`<!DOCTYPE html>
<!-- FCS TEST OUTPUT -->
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Test ‚Äî Level ${$('t-level').value}</title>
<style>
  :root{--ink:#111;--muted:#667085;--border:#e5e7eb;--panel:#ffffff;--bg:#ffffff;--en:#1a73e8;--es:#d93025;--h:#0f172a}
  *{box-sizing:border-box} body{font-family:Calibri,Arial,sans-serif;font-size:10pt;line-height:1.4;color:var(--ink);background:var(--bg);margin:0}
  .fcs-doc{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:20pt;text-align:center;color:var(--h);margin:0 0 12px 0}
  h2{font-size:13pt;color:var(--h);margin:16px 0 8px 0;text-align:center}
  .section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:14px;overflow-x:auto}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
  .tbl th,.tbl td{border:1px solid var(--border);padding:8px;vertical-align:top}
  .tbl th{background:#f5f7fb;font-weight:700}
  .tbl tr:nth-child(even) td{background:#fafafa}
  .en{color:var(--en);font-weight:700} .es{color:var(--es);font-weight:700}
  .note{font-size:9pt;color:var(--muted)}
  @media(max-width:700px){ .tbl{font-size:9pt;width:auto} }
</style></head>
<body><div class="fcs-doc">
  <h1>FCS Conversation Test ‚Äî Level ${$('t-level').value}</h1>
  <div class="note"><span class="en">English terms = blue</span>; <span class="es">Spanish terms = red</span> whenever vocabulary appears inline.</div>

  <div class="section">
    <h2>Part 1 ‚Äî Spanish ‚Üí English</h2>
    <table class="tbl"><thead><tr><th>#</th><th lang="es">Espa√±ol</th>${$('t-anskeys').checked ? '<th>Answer (EN)</th>' : ''}</tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Part 2 ‚Äî English ‚Üí Spanish</h2>
    <table class="tbl"><thead><tr><th>#</th><th>English</th>${$('t-anskeys').checked ? '<th lang="es">Answer (ES)</th>' : ''}</tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Part 3 ‚Äî Live Conversation Prompts</h2>
    <table class="tbl"><thead><tr><th>#</th><th lang="es">Prompt (Espa√±ol)</th></tr></thead>
      <tbody><!-- rows --></tbody>
    </table>
  </div>

  ${$('t-anskeys').checked ? `<div class="section"><h2>Answer Key</h2><!-- answers only --></div>` : ''}

  <div class="note">Vocabulary pasted by teacher:</div>
  <div class="note" style="white-space:pre-wrap;border:1px dashed var(--border);padding:8px;border-radius:8px;">${$('t-vocab').value.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>

</div></body></html>`;
      const html = await callAPI(prompt);
      outputEl.innerHTML = html;
      statusEl.textContent = "Done.";
      await Speech.ensureVoices();
      addPerLineTTS(outputEl);
    });

    $('t-copy').addEventListener('click',()=>copyToClipboard(outputEl,statusEl));
    $('t-excel').addEventListener('click',()=>downloadAsExcel(outputEl,statusEl,'Test'));
  })();
})();
</script>
</body>
</html>
