<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FCS AI Generator Suite</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  :root {
    --bg: #f7f9fc;
    --fg: #111;
    --muted: #667085;
    --border: #e5e7eb;
    --panel: #ffffff;
    --accent: #0b5cff;
    --en: #1a73e8;
    --es: #d93025;
    --head: #0f172a;
  }
  body {
    background: var(--bg);
    color: var(--fg);
    font-family: Calibri, Arial, sans-serif;
    font-size: 15px;
    margin: 0;
  }
  .fcs-wrap {
    max-width: 980px;
    margin: 28px auto;
    padding: 0 16px;
  }
  h1 {
    font-size: 28px;
    font-weight: 700;
    text-align: center;
    margin-bottom: 28px;
    color: var(--head);
  }
  h2 {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
    color: var(--head);
  }
  .fcs-card {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    background: var(--panel);
    margin-bottom: 20px;
  }
  label {
    font-weight: 600;
    font-size: 14px;
    display: block;
    margin-bottom: 6px;
  }
  input[type="text"],
  select,
  input[type="number"],
  textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: #fff;
    font-size: 15px;
    box-sizing: border-box;
  }
  input:disabled {
    background-color: #f8f9fa;
  }
  .hint,
  .small {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }
  button {
    padding: 10px 16px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: #f6f8fb;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.2s;
  }
  button.primary {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  }
  button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }
  .fcs-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
  }
  .fcs-tab-btn {
    flex-grow: 1;
    text-align: center;
  }
  .fcs-generator {
    display: none;
  }
  .fcs-generator.active {
    display: block;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 16px;
    align-items: end;
  }
  .six {
    grid-column: span 6;
  }
  .twelve {
    grid-column: span 12;
  }
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .grid-full {
    grid-column: 1 / -1;
  }
  .actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
    align-items: center;
  }
  .status {
    margin-top: 10px;
    min-height: 1.5em;
    text-align: left;
    color: var(--muted);
    font-size: 13px;
  }
  .output-container {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    background: #fff;
    min-height: 240px;
    margin-top: 20px;
  }
  .output-container h1,
  .output-container h2 {
    text-align: center;
    color: #0f172a !important;
  }
  .output-container table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: 12px;
    font-size: 10pt;
  }
  .output-container th,
  .output-container td {
    border: 1px solid #e5e7eb;
    padding: 8px;
    vertical-align: top;
  }
  .output-container th {
    background: #f5f7fb;
  }
  .output-container tr:nth-child(even) td {
    background: #fafafa;
  }
  .output-container .en {
    color: var(--en);
    font-weight: bold;
  }
  .output-container .es {
    color: var(--es);
    font-weight: bold;
  }
  @media (max-width: 860px) {
    .six,
    .twelve {
      grid-column: span 12;
    }
    .grid-2 {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>
<div class="fcs-wrap">
  <h1>FCS AI GENERATOR SUITE</h1>
  <div class="fcs-tabs">
    <button id="tab-vocab" class="fcs-tab-btn primary">Vocabulary</button>
    <button id="tab-convo" class="fcs-tab-btn">Conversation</button>
    <button id="tab-test" class="fcs-tab-btn">Test</button>
  </div>

  <div id="gen-vocab" class="fcs-generator active"></div>
  <div id="gen-convo" class="fcs-generator"></div>
  <div id="gen-test" class="fcs-generator"></div>
</div>

<script>
"use strict";
(function() {
  const $ = id => document.getElementById(id);
  const API_URL = "/api/index";

  // Tabs
  (function initTabs() {
    const tabs = document.querySelectorAll(".fcs-tab-btn");
    const sections = document.querySelectorAll(".fcs-generator");
    tabs.forEach(tabBtn => {
      tabBtn.addEventListener("click", () => {
        const targetId = tabBtn.id.replace("tab-", "gen-");
        tabs.forEach(t => t.classList.remove("primary"));
        tabBtn.classList.add("primary");
        sections.forEach(sec => {
          sec.style.display = sec.id === targetId ? "block" : "none";
        });
      });
    });
  })();

  async function generateResult(prompt, button, statusEl, outputEl) {
    button.disabled = true;
    statusEl.textContent = "Generating... This can take up to a minute.";
    outputEl.innerHTML = "<h4>Please wait. AI is working...</h4>";
    try {
      const resp = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
      });
      const json = await resp.json();
      if (!resp.ok) throw new Error(json.details || json.error || "Unknown server error.");
      outputEl.innerHTML = json.content;
      statusEl.textContent = "Success!";
    } catch (err) {
      console.error("Error:", err);
      outputEl.innerHTML = `<p style="color:red;"><strong>Error:</strong> ${err.message}</p>`;
      statusEl.textContent = "Error occurred.";
    } finally {
      button.disabled = false;
    }
  }

  function copyToClipboard(container, statusEl) {
    if (!container.innerHTML || container.innerText.includes("will appear here")) {
      statusEl.textContent = "Nothing to copy.";
      return;
    }
    navigator.clipboard.writeText(container.innerText).then(
      () => (statusEl.textContent = "Copied!"),
      () => (statusEl.textContent = "Copy failed.")
    );
  }

  function downloadAsExcel(container, statusEl, filename) {
    if (!container.querySelector("table")) {
      statusEl.textContent = "No data to export.";
      return;
    }
    try {
      statusEl.textContent = "Creating Excel...";
      const wb = XLSX.utils.book_new();
      const rows = [];
      const title = container.querySelector("h1")?.innerText || filename;
      rows.push([title]);
      rows.push([]);
      container.querySelectorAll("h2, table").forEach(el => {
        if (el.tagName === "H2") {
          rows.push([el.innerText]);
        }
        if (el.tagName === "TABLE") {
          el.querySelectorAll("tr").forEach(tr => {
            const line = Array.from(tr.querySelectorAll("th, td")).map(td => td.innerText);
            rows.push(line);
          });
          rows.push([]);
        }
      });
      const ws = XLSX.utils.aoa_to_sheet(rows);
      // Auto-adjust column widths
      ws["!cols"] = rows.reduce((acc, row) => {
        row.forEach((cell, i) => {
          const width = cell ? cell.toString().length + 2 : 10;
          if (!acc[i] || acc[i].wch < width) acc[i] = { wch: width };
        });
        return acc;
      }, []);
      XLSX.utils.book_append_sheet(wb, ws, "Generated Content");
      XLSX.writeFile(wb, `${(filename || "Export").replace(/\s+/g, "_")}.xlsx`);
      statusEl.textContent = "Download started.";
    } catch (e) {
      console.error("Excel Error:", e);
      statusEl.textContent = "Failed to create Excel.";
    }
  }

  // ---------- VOCABULARY ----------
  (function setupVocab() {
    const vocabUI = `
      <div class="fcs-card">
        <h2>Vocabulary Creator</h2>
        <div class="grid">
          <div class="six">
            <label for="v-topic">Topic</label>
            <input id="v-topic" type="text" placeholder="e.g., At the Airport" />
          </div>
          <div class="six">
            <label for="v-level">Level</label>
            <select id="v-level">
              <option value="1">Level 1 — Survival</option>
              <option value="2">Level 2 — Beginner</option>
              <option value="3" selected>Level 3 — Intermediate</option>
              <option value="4">Level 4 — Conversational</option>
              <option value="5">Level 5 — Fluent</option>
            </select>
          </div>
          <div class="six">
            <label for="v-tmode">Total Words Mode</label>
            <select id="v-tmode">
              <option value="default" selected>Preset by Level</option>
              <option value="custom">Custom</option>
            </select>
            <div id="v-presetText" class="hint"></div>
          </div>
          <div class="six">
            <div class="grid">
              <div class="six">
                <label for="v-tmin">Min</label>
                <input id="v-tmin" type="number" min="1" disabled />
              </div>
              <div class="six">
                <label for="v-tmax">Max</label>
                <input id="v-tmax" type="number" min="1" disabled />
              </div>
            </div>
          </div>
          <div class="twelve">
            <label for="v-vocab-include">Vocabulary to Include (optional)</label>
            <textarea id="v-vocab-include" rows="3" placeholder="Paste a full or partial list of words to include..."></textarea>
          </div>
        </div>
        <div class="actions">
          <button id="v-gen" class="primary">Generate Vocabulary</button>
          <button id="v-excel">Download Excel</button>
          <button id="v-copy">Copy</button>
          <div id="v-status" class="status"></div>
        </div>
      </div>
      <div id="v-output" class="output-container"><p>Your list will appear here...</p></div>`;
    $("gen-vocab").innerHTML = vocabUI;

    const genBtn = $("v-gen"),
          excelBtn = $("v-excel"),
          copyBtn = $("v-copy"),
          statusEl = $("v-status"),
          outputEl = $("v-output"),
          levelEl = $("v-level"),
          tmodeEl = $("v-tmode"),
          tminEl = $("v-tmin"),
          tmaxEl = $("v-tmax"),
          presetTextEl = $("v-presetText"),
          topicEl = $("v-topic"),
          vocabIncludeEl = $("v-vocab-include");

    const presetRanges = {
      "1": { min: 35, max: 55 },
      "2": { min: 60, max: 85 },
      "3": { min: 90, max: 120 },
      "4": { min: 120, max: 180 },
      "5": { min: 160, max: 240 }
    };
    const levelTexts = {
      "1": "Level 1—Survival",
      "2": "Level 2—Beginner",
      "3": "Level 3—Intermediate",
      "4": "Level 4—Conversational",
      "5": "Level 5—Fluent"
    };

    function updateUI() {
      const isCustom = tmodeEl.value === "custom";
      const range = presetRanges[levelEl.value];
      tminEl.disabled = !isCustom;
      tmaxEl.disabled = !isCustom;
      if (!isCustom) {
        tminEl.value = range.min;
        tmaxEl.value = range.max;
      }
      presetTextEl.textContent = `Preset for ${levelTexts[levelEl.value]}: ${range.min}–${range.max} words.`;
    }

    tmodeEl.addEventListener("change", updateUI);
    levelEl.addEventListener("change", updateUI);
    updateUI();

    genBtn.addEventListener("click", () => {
      if (!topicEl.value.trim()) {
        statusEl.textContent = "Please enter a topic.";
        return;
      }
      const prompt =
`<!DOCTYPE html>
<!-- FCS VOCABULARY OUTPUT -->
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vocabulary — ${topicEl.value}</title>
<style>
  :root { --ink:#111; --muted:#667085; --border:#e5e7eb; --panel:#ffffff; --bg:#ffffff; --en:#1a73e8; --es:#d93025; --h:#0f172a; }
  * { box-sizing: border-box; }
  body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; line-height: 1.4; color: var(--ink); background: var(--bg); margin: 0; }
  .fcs-doc { max-width: 980px; margin: 0 auto; padding: 24px; }
  h1 { font-size: 20pt; text-align: center; color: var(--h); margin: 0 0 12px 0; }
  h2 { font-size: 13pt; color: var(--h); margin: 16px 0 8px 0; text-align: center; }
  .section { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin: 14px 0; overflow-x: auto; }
  .legend { font-size: 9pt; color: var(--muted); text-align: center; margin: 6px 0 0 0; }
  .tbl { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
  .tbl th, .tbl td { border: 1px solid var(--border); padding: 6px; vertical-align: top; }
  .tbl th { background: #f5f7fb; font-weight: 700; }
  .tbl tr:nth-child(even) td { background: #fafafa; }
  .en { color: var(--en); font-weight: 700; }
  .es { color: var(--es); font-weight: 700; }
  .subcategory { background: #eef2ff; font-weight: 700; text-align: left; }
  .badge { display: inline-block; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; background: #f8fafc; font-size: 9pt; margin: 6px; }
  .note { font-size: 9pt; color: var(--muted); }
  @media(max-width:700px) {
    .tbl { font-size: 9pt; width: auto; }
  }
</style></head>
<body><div class="fcs-doc" lang="en">
  <h1>Vocabulary: ${topicEl.value} — ${levelTexts[levelEl.value]}</h1>
  <div class="legend">
    <span class="badge"><span class="en">English</span> / <span class="es" lang="es">Español</span></span>
    <span class="badge">Every row includes a concise definition or example sentence.</span>
  </div>

  <!-- RULES THE MODEL MUST FOLLOW -->
  <!--
    SECTION ORDER (fixed): Nouns, Verbs, Descriptive Words, Common Phrases, Common Questions
    COLUMNS (fixed): English | Spanish | Definition / Example
    - Alphabetize each section by the English term (ignore “to ” for verbs).
    - In all example sentences, wrap target words with <span class="en">…</span> or <span class="es">…</span>.
    - Show helpful subcategory label rows (e.g., Transportation, People) as:
      <tr><td class="subcategory" colspan="3">Nouns — Transportation</td></tr>
    - Level caps (strict):
      L1: Nouns ≤35, Verbs ≤15, Descriptive ≤12, Questions ≤8, Phrases ≤12
      L2: Nouns 30–55, Verbs 12–20, Descriptive 10–18, Questions 7–12, Phrases 10–18
      L3: Nouns 50–75, Verbs 18–30, Descriptive 18–28, Questions 12–18, Phrases 15–25
      L4: Nouns ≥70, Verbs ≥25, Descriptive ≥25, Questions ≥18, Phrases ≥25
      L5: Nouns ≥90, Verbs ≥30, Descriptive ≥30, Questions ≥25, Phrases ≥35
    - Ensure the total count of Nouns + Verbs + Descriptive words is between ${tminEl.value||'auto'} and ${tmaxEl.value||'auto'}.
    - If the user provided a “Vocabulary to Include” list, make sure those terms appear (place them in the best-fit section).
    - Use simple, student-friendly definitions (or a short example sentence when clearer).
  -->

  <div class="section">
    <h2>Nouns / Sustantivos</h2>
    <table class="tbl">
      <thead><tr><th>English</th><th lang="es">Español</th><th>Definition / Example</th></tr></thead>
      <tbody><!-- MODEL: insert noun rows and subcategories here --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Verbs / Verbos</h2>
    <table class="tbl">
      <thead><tr><th>English</th><th lang="es">Español</th><th>Definition / Example</th></tr></thead>
      <tbody><!-- MODEL: insert verb rows here --></tbody>
    </table>
    <div class="note">Tip: Keep example sentences in present/simple structures to emphasize infinitives.</div>
  </div>

  <div class="section">
    <h2>Descriptive Words / Palabras descriptivas</h2>
    <table class="tbl">
      <thead><tr><th>English</th><th lang="es">Español</th><th>Definition / Example</th></tr></thead>
      <tbody><!-- MODEL: insert adjectives/adverbs here --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Common Phrases / Frases comunes</h2>
    <table class="tbl">
      <thead><tr><th>English</th><th lang="es">Español</th><th>Meaning / Example</th></tr></thead>
      <tbody><!-- MODEL: insert phrases here --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Common Questions / Preguntas comunes</h2>
    <table class="tbl">
      <thead><tr><th>English</th><th lang="es">Español</th><th>Sample Answer</th></tr></thead>
      <tbody><!-- MODEL: insert Q&A here --></tbody>
    </table>
  </div>

  <div class="note">Included terms from user: ${vocabIncludeEl.value ? vocabIncludeEl.value.replace(/</g, "&lt;").replace(/>/g, "&gt;") : 'None'}.</div>
</div></body></html>`;
      generateResult(prompt, genBtn, statusEl, outputEl);
    });

    copyBtn.addEventListener("click", () => copyToClipboard(outputEl, statusEl));
    excelBtn.addEventListener("click", () => downloadAsExcel(outputEl, statusEl, topicEl.value || "Vocabulary"));
  })();

  // ---------- CONVERSATION ----------
  (function setupConvo() {
    const convoUI = `
      <div class="fcs-card">
        <h2>Conversation Creator</h2>
        <div class="grid-2">
          <div class="grid-full">
            <label for="c-topic">Topic</label>
            <input id="c-topic" type="text" placeholder="e.g., A funny story about a vacation" />
          </div>
          <div>
            <label>Level (Grammar)</label>
            <select id="c-level">
              <option value="1">Level 1</option>
              <option value="2">Level 2</option>
              <option value="3">Level 3</option>
              <option value="4">Level 4</option>
              <option value="5" selected>Level 5</option>
            </select>
          </div>
          <div class="grid-full">
            <label for="c-vocab">Vocabulary (optional)</label>
            <textarea id="c-vocab" rows="8" placeholder="Put your own vocabulary here..."></textarea>
          </div>
          <div>
            <label>Number of Conversations</label>
            <input id="c-numConvos" type="number" value="2" />
          </div>
          <div>
            <label># of Speakers</label>
            <input id="c-numSpeakers" type="number" value="2" />
          </div>
          <div>
            <label>Minutes</label>
            <input id="c-minutes" type="number" value="5" />
          </div>
          <div>
            <label>Turns</label>
            <input id="c-turns" type="number" value="10" />
          </div>
          <div>
            <label>Tone</label>
            <select id="c-tone">
              <option>Neutral, casual</option>
              <option>Informal, friendly</option>
              <option>Instructor, student</option>
              <option>Customer, staff</option>
              <option>Professional, formal</option>
              <option>Street slang</option>
            </select>
          </div>
          <div>
            <label>Country / Region</label>
            <select id="c-country"></select>
          </div>
          <div class="grid-full">
            <label>Include English Translation</label>
            <select id="c-includeEN">
              <option value="yes" selected>Yes</option>
              <option value="no">No</option>
            </select>
          </div>
          <div>
            <label>Add Fill-In-The-Blank</label>
            <select id="c-addFib">
              <option value="no">No</option>
              <option value="yes" selected>Yes</option>
            </select>
          </div>
          <div>
            <label>FIB Focus</label>
            <select id="c-fibFocus">
              <option>Mixed</option>
              <option>Vocab only</option>
              <option>Grammar only</option>
              <option>Verbs only</option>
            </select>
          </div>
          <div>
            <label>Show FIB Answer Key</label>
            <select id="c-showFIBKey">
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>
          <div>
            <label>Show Vocabulary List</label>
            <select id="c-showVocabList">
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>
          <div class="grid-full">
            <label>Optional Teacher Notes</label>
            <textarea id="c-notes" rows="4"></textarea>
          </div>
        </div>
        <div class="actions">
          <button id="c-gen" class="primary">Generate</button>
          <button id="c-excel">Excel</button>
          <button id="c-copy">Copy</button>
          <div id="c-status" class="status"></div>
        </div>
      </div>
      <div id="c-output" class="output-container"><p>Your conversation appears here...</p></div>`;
    $("gen-convo").innerHTML = convoUI;

    const countrySelect = $("c-country");
    const countries = ["-no specific-", "Argentina", "Bolivia", "Chile", "Colombia", "Costa Rica", "Cuba", "Dominican Republic", "Ecuador", "El Salvador", "Equatorial Guinea", "Guatemala", "Honduras", "Mexico", "Nicaragua", "Panama", "Paraguay", "Peru", "Puerto Rico", "Spain", "Uruguay", "Venezuela"];
    countrySelect.innerHTML = countries.map(c => `<option>${c}</option>`).join("");

    const genBtn = $("c-gen"),
          excelBtn = $("c-excel"),
          copyBtn = $("c-copy"),
          statusEl = $("c-status"),
          outputEl = $("c-output");

    genBtn.addEventListener("click", () => {
      if (!$("c-topic").value.trim()) {
        statusEl.textContent = "Enter a topic.";
        return;
      }
      const prompt =
`<!DOCTYPE html>
<!-- FCS CONVERSATION OUTPUT -->
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conversation — ${$("c-topic").value}</title>
<style>
  :root { --ink:#111; --muted:#667085; --border:#e5e7eb; --panel:#ffffff; --bg:#ffffff; --en:#1a73e8; --es:#d93025; --h:#0f172a; }
  * { box-sizing: border-box; }
  body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; line-height: 1.4; color: var(--ink); background: var(--bg); margin: 0; }
  .fcs-doc { max-width: 980px; margin: 0 auto; padding: 24px; }
  h1 { font-size: 20pt; text-align: center; color: var(--h); margin: 0 0 12px 0; }
  h2 { font-size: 13pt; color: var(--h); margin: 16px 0 8px 0; text-align: center; }
  .section { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin: 14px 0; overflow-x: auto; }
  .tbl { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
  .tbl th, .tbl td { border: 1px solid var(--border); padding: 8px; vertical-align: top; }
  .tbl th { background: #f5f7fb; font-weight: 700; }
  .tbl tr:nth-child(even) td { background: #fafafa; }
  .en { color: var(--en); font-weight: 700; }
  .es { color: var(--es); font-weight: 700; }
  .note { font-size: 9pt; color: var(--muted); }
  @media(max-width:700px) {
    .tbl { font-size: 9pt; }
    .tbl thead { display: none; }
    .tbl td { display: block; width: 100%; }
    .tbl td + td { margin-top: 6px; }
  }
</style></head>
<body><div class="fcs-doc">
  <h1>Conversation: ${$("c-topic").value} — Level ${$("c-level").value}</h1>

  <!-- MODEL MUST FOLLOW:
    - Create ${$("c-numConvos").value} conversation(s), each with ${$("c-numSpeakers").value} speaker(s), about ${$("c-minutes").value} minutes long and ~${$("c-turns").value} turns each.
    - If more than one conversation is requested, separate each conversation clearly (e.g., "Conversation 1", "Conversation 2") with its own table.
    - Tone: ${$("c-tone").value}; Country/Region: ${$("c-country").value}
    - If Include English Translation = ${$("c-includeEN").value}, use two columns (English on left, Spanish on right). If English translation is not included, output only the Spanish column (omit the English column).
    - Bold target vocabulary within lines using <span class="en">…</span> (English) and <span class="es" lang="es">…</span> (Spanish).
    - Use a table format for dialogues (columns as specified above). Clearly label each speaker turn (A:, B:, C:).
    - If Add Fill-In-The-Blank = ${$("c-addFib").value}, include a **Practice** section with fill-in-the-blank sentences focused on ${$("c-fibFocus").value}. Use blanks like "______ (English hint)".
    - If Show FIB Answer Key = ${$("c-showFIBKey").value}, add an **Answer Key** section at the end with the correct answers.
    - If Show Vocabulary List = ${$("c-showVocabList").value}, add a **Vocabulary Used** section with a mini table (English | Español) listing key vocabulary from the conversations.
    - Use grammar appropriate for Level ${$("c-level").value}. Maintain the requested tone and incorporate any provided vocabulary strictly (custom vocab provided: ${$("c-vocab").value ? 'Yes' : 'No'}).
  -->

  <!-- Dialogue Sections -->
  <div class="section">
    <h2>Dialogue</h2>
    <table class="tbl">
      <thead><tr><th>English</th><th lang="es">Español</th></tr></thead>
      <tbody><!-- MODEL: insert turn-by-turn rows here --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Practice — Fill-in-the-Blank</h2>
    <!-- MODEL: include this section only if requested. Provide a numbered list or table of fill-in-the-blank prompts. If an answer key is requested, include it in a separate Answer Key section. -->
  </div>

  <div class="section">
    <h2>Vocabulary Used</h2>
    <!-- MODEL: include this section only if requested. Provide a table (English | Español) of vocabulary from the conversations. -->
  </div>

  <div class="section">
    <h2>Answer Key</h2>
    <!-- MODEL: include this section only if FIB Answer Key is requested. List answers for each blank in the practice section. -->
  </div>

  <div class="note">${$("c-notes").value ? $("c-notes").value.replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""}</div>

</div></body></html>`;
      generateResult(prompt, genBtn, statusEl, outputEl);
    });

    copyBtn.addEventListener("click", () => copyToClipboard(outputEl, statusEl));
    excelBtn.addEventListener("click", () => downloadAsExcel(outputEl, statusEl, $("c-topic").value || "Conversation"));
  })();

  // ---------- TEST ----------
  (function setupTest() {
    const testUI = `
      <div class="fcs-card">
        <h2>Test Creator</h2>
        <div>
          <label for="t-vocab">Vocabulary List</label>
          <textarea id="t-vocab" rows="6" placeholder="Paste the EXACT vocabulary for the test..."></textarea>
        </div>
        <div>
          <label for="t-level">Level (Grammar)</label>
          <select id="t-level">
            <option value="1">Level 1</option>
            <option value="2" selected>Level 2</option>
            <option value="3">Level 3</option>
            <option value="4">Level 4</option>
            <option value="5">Level 5</option>
          </select>
        </div>
        <div>
          <label><input type="checkbox" id="t-anskeys" checked /> Include Teacher Answer Keys?</label>
        </div>
        <div class="actions">
          <button id="t-gen" class="primary">Generate</button>
          <button id="t-excel">Excel</button>
          <button id="t-copy">Copy</button>
          <div id="t-status" class="status"></div>
        </div>
      </div>
      <div id="t-output" class="output-container"><p>Your test will appear here...</p></div>`;
    $("gen-test").innerHTML = testUI;

    const genBtn = $("t-gen"),
          excelBtn = $("t-excel"),
          copyBtn = $("t-copy"),
          statusEl = $("t-status"),
          outputEl = $("t-output");

    genBtn.addEventListener("click", () => {
      const vocabEl = $("t-vocab");
      if (!vocabEl.value.trim()) {
        statusEl.textContent = "Please paste a vocab list.";
        return;
      }
      const prompt =
`<!DOCTYPE html>
<!-- FCS TEST OUTPUT -->
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Test — Level ${$("t-level").value}</title>
<style>
  :root { --ink:#111; --muted:#667085; --border:#e5e7eb; --panel:#ffffff; --bg:#ffffff; --en:#1a73e8; --es:#d93025; --h:#0f172a; }
  * { box-sizing: border-box; }
  body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; line-height: 1.4; color: var(--ink); background: var(--bg); margin: 0; }
  .fcs-doc { max-width: 980px; margin: 0 auto; padding: 24px; }
  h1 { font-size: 20pt; text-align: center; color: var(--h); margin: 0 0 12px 0; }
  h2 { font-size: 13pt; color: var(--h); margin: 16px 0 8px 0; text-align: center; }
  .section { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin: 14px 0; overflow-x: auto; }
  .tbl { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
  .tbl th, .tbl td { border: 1px solid var(--border); padding: 8px; vertical-align: top; }
  .tbl th { background: #f5f7fb; font-weight: 700; }
  .tbl tr:nth-child(even) td { background: #fafafa; }
  .en { color: var(--en); font-weight: 700; }
  .es { color: var(--es); font-weight: 700; }
  .note { font-size: 9pt; color: var(--muted); }
  @media(max-width:700px) {
    .tbl { font-size: 9pt; width: auto; }
  }
</style></head>
<body><div class="fcs-doc">
  <h1>FCS Conversation Test — Level ${$("t-level").value}</h1>
  <div class="note">Vocabulary source pasted by teacher is used verbatim where possible.</div>

  <!-- MODEL RULES:
    Structure MUST include three parts:
      **Part 1 – Spanish → English:** A table of items (Number | Spanish | **Answer (EN)**${$("t-anskeys").checked ? "" : " (omit Answer column)"})
      **Part 2 – English → Spanish:** A table of items (Number | English | **Answer (ES)**${$("t-anskeys").checked ? "" : " (omit Answer column)"})
      **Part 3 – Live Conversation Prompts:** A table of prompts (Number | Prompt in Spanish). No answer column for this part.
    - Use **only** the vocabulary provided in the list and appropriate Level ${$("t-level").value} grammar structures.
    - If "Include Teacher Answer Keys" = ${$("t-anskeys").checked}, include the answer columns in Part 1 and Part 2, and add a final **Answer Key** section consolidating all answers. If not, omit answer columns and the Answer Key section.
    - Keep questions clear, concise, and varied. Avoid any trick questions or overly complex phrasing.
  -->

  <div class="section">
    <h2>Part 1 — Spanish → English</h2>
    <table class="tbl">
      <thead>
        <tr><th>#</th><th lang="es">Español</th>${ $("t-anskeys").checked ? "<th>Answer (EN)</th>" : "" }</tr>
      </thead>
      <tbody><!-- MODEL: insert Part 1 questions here (Spanish prompt, English answer) --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Part 2 — English → Spanish</h2>
    <table class="tbl">
      <thead>
        <tr><th>#</th><th>English</th>${ $("t-anskeys").checked ? "<th lang='es'>Answer (ES)</th>" : "" }</tr>
      </thead>
      <tbody><!-- MODEL: insert Part 2 questions here (English prompt, Spanish answer) --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Part 3 — Live Conversation Prompts</h2>
    <table class="tbl">
      <thead>
        <tr><th>#</th><th lang="es">Prompt (Español)</th></tr>
      </thead>
      <tbody><!-- MODEL: insert Part 3 prompts here (Spanish prompts only) --></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Answer Key</h2>
    <!-- MODEL: include this section *only* if answer keys are included. Provide answers to Part 1 and Part 2 questions, clearly labeled by part and number. -->
  </div>

  <div class="note">Vocabulary pasted by teacher:</div>
  <div class="note" style="white-space: pre-wrap; border: 1px dashed var(--border); padding: 8px; border-radius: 8px;">${$("t-vocab").value.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>

</div></body></html>`;
      generateResult(prompt, genBtn, statusEl, outputEl);
    });

    copyBtn.addEventListener("click", () => copyToClipboard(outputEl, statusEl));
    excelBtn.addEventListener("click", () => downloadAsExcel(outputEl, statusEl, "Test"));
  })();
})();
</script>
</body>
</html>
