<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FCS AI Generator Suite — Excel-Ready Vocabulary, Conversations & Tests</title>
<style>
  :root{
    --bg:#0b0f19; --panel:#12182a; --panel2:#0f1424; --ink:#e6eef9; --muted:#b3c0d1;
    --accent:#5dd4ff; --accent2:#7ef29a; --border:rgba(255,255,255,.09);
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#0b1120 60%,#090e1a);
       color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Calibri,Arial,sans-serif}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  h1{margin:0;font-weight:800;letter-spacing:.2px}
  .subtitle{color:var(--muted);margin-top:6px}
  .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px;margin-top:18px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);
        border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .bd{padding:16px}
  .row{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
  .row > *{flex:1}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"], textarea, select{width:100%;background:#0b1120;color:var(--ink);
        border:1px solid var(--border);border-radius:10px;padding:10px 12px;font:inherit}
  textarea{min-height:110px;resize:vertical}
  .btn{appearance:none;background:#0b1120;color:var(--ink);border:1px solid var(--border);
       border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1120;font-weight:800;border:none}
  .muted{color:var(--muted)}
  .out{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;line-height:1.5}
  .excel{background:#fff;color:#111;border-radius:12px;padding:16px}
  .excel .en{color:#0057d9;font-weight:bold;font-family:Calibri,Arial,sans-serif}
  .excel .es{color:#c00000;font-weight:bold;font-family:Calibri,Arial,sans-serif}
  .excel .ans-en{color:#0057d9;font-style:italic;font-family:Calibri,Arial,sans-serif}
  .excel .ans-es{color:#c00000;font-style:italic;font-family:Calibri,Arial,sans-serif}
  .excel table{width:100%;border-collapse:collapse;font-family:Calibri,Arial,sans-serif;font-size:10pt}
  .excel th,.excel td{border:1px solid #ccc;padding:6px}
  .excel h1,.excel h2{text-align:center;font-family:Calibri,Arial,sans-serif}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px dashed var(--border);
        border-radius:999px;padding:4px 10px;color:var(--muted);font-size:12px}
  .tabs{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:#0b1120}
  .tab.active{outline:2px solid var(--accent)}
  .tips{font-size:12px;color:var(--muted)}
  .status{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>FCS AI Generator Suite</h1>
    <div class="subtitle">Excel-ready vocabulary (Calibri 10; <span style="color:#7dd3fc;font-weight:700">EN blue bold</span>, <span style="color:#f87171;font-weight:700">ES red bold</span>), scripted conversations, and tests — built to your rules.</div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="vocab">Vocabulary</div>
      <div class="tab" data-tab="conv">Conversations</div>
      <div class="tab" data-tab="tests">Tests</div>
      <div class="pill">Nouns → full sentences • Verbs → “Yo voy a …” • Descriptors → “It is … / Es …” • Sort by English</div>
    </div>

    <!-- VOCAB -->
    <section class="grid" data-panel="vocab">
      <div class="card">
        <div class="hd"><strong>Vocabulary — Builder</strong><button class="btn" id="resetV">Reset</button></div>
        <div class="bd">
          <div class="row">
            <div>
              <label>Topic</label>
              <input id="vTopic" type="text" placeholder="e.g., Engineering" />
            </div>
            <div>
              <label>Level (1–5)</label>
              <select id="vLevel">
                <option value="1">1 — Survival</option>
                <option value="2">2 — Present Tense + Glue</option>
                <option value="3">3 — Past & Ongoing</option>
                <option value="4">4 — Complex Tenses</option>
                <option value="5">5 — Fluent</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Nouns (English=Spanish; comma-separated)</label>
              <textarea id="vNouns" placeholder="blueprint=plano, circuit=circuito, device=dispositivo, engineer=ingeniero, equipment=equipo"></textarea>
              <div class="tips">Outputs sentences: “Here is the … / It is a/an … / The … is here.”</div>
            </div>
            <div>
              <label>Verbs (to + English=Spanish infinitive; comma-separated)</label>
              <textarea id="vVerbs" placeholder="to build=construir, to test=probar, to design=diseñar"></textarea>
              <div class="tips">Infinitive focus only: EN “I am going to …” • ES “Yo voy a …”</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Descriptive Words (English=Spanish; adjectives/adverbs only)</label>
              <textarea id="vDescs" placeholder="fast=rápido, precise=preciso, safe=seguro, stable=estable"></textarea>
              <div class="tips">Sentences: “It is … / Es …”</div>
            </div>
            <div>
              <label>Common Phrases (English=Spanish)</label>
              <textarea id="vPhrases" placeholder="Good job!=¡Buen trabajo!, Be careful.=Ten cuidado."></textarea>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Common Questions (Q=Pregunta | A=Respuesta)</label>
              <textarea id="vQs" placeholder="Where is the toolbox?=¿Dónde está la caja de herramientas? | It's on the shelf.=Está en el estante."></textarea>
            </div>
            <div>
              <label>Options</label>
              <div class="tips">
                <input type="checkbox" id="optSmartArt" checked /> Smart English articles (a/an/the) for nouns<br/>
                <input type="checkbox" id="optAltPatterns" checked /> Alternate noun patterns<br/>
                <input type="checkbox" id="optSortEn" checked /> Alphabetize sections by English
              </div>
            </div>
          </div>

          <div class="row">
            <button class="btn primary" id="makeV">Generate (Front-end)</button>
            <button class="btn" id="serverV">Generate (Server, no-AI)</button>
            <button class="btn" id="aiV">Generate with AI (Server)</button>
            <button class="btn" id="copyV">Copy HTML</button>
            <button class="btn" id="downloadV">Download .html</button>
          </div>
          <div class="status" id="vStatus"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><strong>Preview (Excel-Ready)</strong><span class="tips">Calibri 10 • EN blue bold • ES red bold</span></div>
        <div class="bd">
          <div id="vOut" class="excel out muted">Your Excel-ready HTML will appear here…</div>
        </div>
      </div>
    </section>

    <!-- CONVERSATIONS -->
    <section class="grid" data-panel="conv" style="display:none">
      <div class="card">
        <div class="hd"><strong>Conversations — Builder</strong><button class="btn" id="resetC">Reset</button></div>
        <div class="bd">
          <div class="row">
            <div><label>Topic</label><input id="cTopic" type="text" placeholder="e.g., Engineering: troubleshooting a device" /></div>
            <div>
              <label>Level</label>
              <select id="cLevel">
                <option value="1">1 — Fluent Reading & Pronunciation (Scripted)</option>
                <option value="2">2 — Present Tense + Glue</option>
                <option value="3">3 — Past & Ongoing</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div><label>Speaker A</label><input id="cA" type="text" value="Lucía" /></div>
            <div><label>Speaker B</label><input id="cB" type="text" value="Diego" /></div>
          </div>
          <div class="row">
            <button class="btn primary" id="makeC">Generate (Front-end)</button>
            <button class="btn" id="serverC">Generate (Server, no-AI)</button>
            <button class="btn" id="aiC">Generate with AI (Server)</button>
            <button class="btn" id="copyC">Copy Output</button>
          </div>
          <div class="status" id="cStatus"></div>
        </div>
      </div>
      <div class="card">
        <div class="hd"><strong>Output</strong></div>
        <div class="bd"><div id="cOut" class="out muted">Your conversations will appear here…</div></div>
      </div>
    </section>

    <!-- TESTS -->
    <section class="grid" data-panel="tests" style="display:none">
      <div class="card">
        <div class="hd"><strong>Tests — Builder</strong><button class="btn" id="resetT">Reset</button></div>
        <div class="bd">
          <div class="row">
            <div><label>Topic</label><input id="tTopic" type="text" placeholder="e.g., Engineering" /></div>
            <div>
              <label>Mode</label>
              <select id="tMode">
                <option value="read">Reading & Pronunciation (L1)</option>
                <option value="fitb">Fill-in-the-Blank (30% blanks)</option>
              </select>
            </div>
          </div>
          <div class="row">
            <button class="btn primary" id="makeT">Generate (Front-end)</button>
            <button class="btn" id="serverT">Generate (Server, no-AI)</button>
            <button class="btn" id="aiT">Generate with AI (Server)</button>
            <button class="btn" id="copyT">Copy Output</button>
          </div>
          <div class="status" id="tStatus"></div>
        </div>
      </div>
      <div class="card">
        <div class="hd"><strong>Output</strong></div>
        <div class="bd"><div id="tOut" class="out muted">Your tests will appear here…</div></div>
      </div>
    </section>
  </div>

  <script>
    // ——— helpers
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const esc = s => (s+"").replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

    function parsePairs(raw){
      if(!raw.trim()) return [];
      return raw.split(',').map(x=>x.trim()).filter(Boolean).map(x=>{
        const [en,es] = x.split('=').map(y=>y?.trim()||'');
        return { en: en||'', es: es||'' };
      });
    }
    function sortByEn(arr){ return arr.sort((a,b)=> (a.en||'').localeCompare(b.en||'', undefined, {sensitivity:'base'})); }

    function articleAAn(word){
      const w = (word||'').trim();
      if(!w) return 'a';
      return /^[aeiou]/i.test(w)? 'an' : 'a';
    }

    function nounSentenceEN(nounEn, idx, smart=true){
      const n = (nounEn||'').trim();
      const a = smart? articleAAn(n) : 'a';
      if(idx===0) return `Here is the ${n}.`;
      if(idx===1) return `It is ${a} ${n}.`;
      return `The ${n} is here.`;
    }
    function nounSentenceES(nounEsOrEn, idx){
      const n = (nounEsOrEn||'').trim();
      if(idx===0) return `Aquí está el/la ${n}.`;
      if(idx===1) return `Es un/una ${n}.`;
      return `El/La ${n} está aquí.`;
    }
    function verbSentenceEN(verbEn){ return `I am going to ${ (verbEn||'').replace(/^to\\s+/i,'').trim() }.`; }
    function verbSentenceES(verbEsOrEn, verbEn){ const v=(verbEsOrEn||'').trim()|| (verbEn||'').replace(/^to\\s+/i,'').trim(); return `Yo voy a ${v}.`; }
    function descSentenceEN(descEn){ return `It is ${ (descEn||'').trim() }.`; }
    function descSentenceES(descEsOrEn){ return `Es ${ (descEsOrEn||'').trim() }.`; }

    function buildExcelHTML({topic, level, nouns, verbs, descs, phrases, questions, smartArt=true, altPat=true, sortEn=true}){
      const H=[];
      H.push(`<div class="excel">`);
      H.push(`<h1>${esc(`Vocabulary: ${topic} — Level ${level}`)}</h1>`);

      // Nouns
      H.push(`<h2>Nouns / Sustantivos</h2>`);
      H.push(`<table><thead><tr><th>English</th><th>Español</th></tr></thead><tbody>`);
      nouns.forEach((row,i)=>{
        const pat = altPat ? (i%3) : 0;
        const en = nounSentenceEN(row.en||row.es||'', pat, smartArt);
        const es = nounSentenceES(row.es||row.en||'', pat);
        H.push(`<tr><td><span class="en">${esc('🔊'+en)}</span></td><td><span class="es">${esc('🔊'+es)}</span></td></tr>`);
      });
      H.push(`</tbody></table>`);

      // Verbs
      H.push(`<h2>Verbs / Verbos</h2>`);
      H.push(`<table><thead><tr><th>English</th><th>Español</th></tr></thead><tbody>`);
      verbs.forEach(row=>{
        const en = verbSentenceEN(row.en||'');
        const es = verbSentenceES(row.es||'', row.en||'');
        H.push(`<tr><td><span class="en">${esc('🔊'+en)}</span></td><td><span class="es">${esc('🔊'+es)}</span></td></tr>`);
      });
      H.push(`</tbody></table>`);

      // Descriptors
      H.push(`<h2>Descriptive Words / Palabras descriptivas</h2>`);
      H.push(`<table><thead><tr><th>English</th><th>Español</th></tr></thead><tbody>`);
      descs.forEach(row=>{
        const en = descSentenceEN(row.en||row.es||'');
        const es = descSentenceES(row.es||row.en||'');
        H.push(`<tr><td><span class="en">${esc('🔊'+en)}</span></td><td><span class="es">${esc('🔊'+es)}</span></td></tr>`);
      });
      H.push(`</tbody></table>`);

      if(phrases.length){
        H.push(`<h2>Common Phrases / Frases comunes</h2>`);
        H.push(`<table><thead><tr><th>English</th><th>Español</th></tr></thead><tbody>`);
        phrases.forEach(r=> H.push(`<tr><td><span class="en">${esc(r.en||'')}</span></td><td><span class="es">${esc(r.es||'')}</span></td></tr>`));
        H.push(`</tbody></table>`);
      }

      if(questions.length){
        H.push(`<h2>Common Questions / Preguntas comunes</h2>`);
        H.push(`<table><thead><tr><th>English</th><th>Español</th></tr></thead><tbody>`);
        questions.forEach(r=>{
          const [qEn,aEn]=(r.en||'').split('|').map(s=>s?.trim()||'');
          const [qEs,aEs]=(r.es||'').split('|').map(s=>s?.trim()||'');
          H.push(`<tr><td><b class="en">${esc(qEn||r.en||'')}</b><br><i class="ans-en">${esc(aEn||'')}</i></td><td><b class="es">${esc(qEs||r.es||'')}</b><br><i class="ans-es">${esc(aEs||'')}</i></td></tr>`);
        });
        H.push(`</tbody></table>`);
      }

      H.push(`</div>`);
      return H.join('\n');
    }

    // Tabs
    $$('#tabs .tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        $$('#tabs .tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const tab = t.dataset.tab;
        $$('section[data-panel]').forEach(p=> p.style.display = (p.dataset.panel===tab? 'grid':'none'));
      });
    });

    // —— VOCAB (front-end)
    let currentVHTML='';
    $('#makeV').addEventListener('click', ()=>{
      const topic = $('#vTopic').value.trim() || 'General';
      const level = $('#vLevel').value;
      let nouns = parsePairs($('#vNouns').value);
      let verbs = parsePairs($('#vVerbs').value);
      let descs = parsePairs($('#vDescs').value);
      let phrases = parsePairs($('#vPhrases').value);
      let questions = parsePairs($('#vQs').value);
      if($('#optSortEn').checked){ [nouns,verbs,descs,phrases].forEach(sortByEn); }
      currentVHTML = buildExcelHTML({
        topic, level, nouns, verbs, descs, phrases, questions,
        smartArt: $('#optSmartArt').checked, altPat: $('#optAltPatterns').checked, sortEn: $('#optSortEn').checked
      });
      $('#vOut').classList.remove('muted'); $('#vOut').innerHTML = currentVHTML;
    });

    $('#copyV').addEventListener('click', async ()=>{ await navigator.clipboard.writeText(currentVHTML||$('#vOut').innerHTML); alert('Vocabulary HTML copied.'); });
    $('#downloadV').addEventListener('click', ()=>{
      const html = currentVHTML||$('#vOut').innerHTML;
      const blob = new Blob([`<!doctype html><html><head><meta charset="utf-8"><title>FCS_Vocabulary</title></head><body>${html}</body></html>`], {type:'text/html'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=`FCS_Vocabulary_${Date.now()}.html`; a.click(); URL.revokeObjectURL(url);
    });
    $('#resetV').addEventListener('click', ()=>{ ['vTopic','vNouns','vVerbs','vDescs','vPhrases','vQs'].forEach(id=>$('#'+id).value=''); $('#vLevel').value='1'; $('#vOut').textContent='Your Excel-ready HTML will appear here…'; $('#vOut').classList.add('muted'); currentVHTML=''; $('#vStatus').textContent=''; });

    // —— VOCAB (server, no-AI)
    $('#serverV').addEventListener('click', async ()=>{
      $('#vStatus').textContent='Generating on server…';
      const body = {
        topic: $('#vTopic').value.trim() || 'General',
        level: $('#vLevel').value,
        nouns: parsePairs($('#vNouns').value),
        verbs: parsePairs($('#vVerbs').value),
        descs: parsePairs($('#vDescs').value),
        phrases: parsePairs($('#vPhrases').value),
        questions: parsePairs($('#vQs').value),
        options: { smartArt: $('#optSmartArt').checked, altPat: $('#optAltPatterns').checked, sortEn: $('#optSortEn').checked }
      };
      const r = await fetch('/api/generate_vocab', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const j = await r.json(); currentVHTML=j.html||''; $('#vOut').classList.remove('muted'); $('#vOut').innerHTML=currentVHTML||'No output.'; $('#vStatus').textContent='';
    });

    // —— VOCAB (server with AI)
    $('#aiV').addEventListener('click', async ()=>{
      $('#vStatus').textContent='Calling AI for vocabulary…';
      const body = {
        topic: $('#vTopic').value.trim() || 'General',
        level: $('#vLevel').value,
        options: { sortEn: $('#optSortEn').checked }
      };
      const r = await fetch('/api/ai_vocab', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const j = await r.json();
      if(j.error){ $('#vStatus').textContent = 'Error: ' + j.error; return; }
      currentVHTML = j.html || '';
      $('#vOut').classList.remove('muted'); $('#vOut').innerHTML=currentVHTML||'No output.';
      $('#vNouns').value = (j.debug?.nouns||[]).map(x=>`${x.en}=${x.es}`).join(', ');
      $('#vVerbs').value = (j.debug?.verbs||[]).map(x=>`${x.en}=${x.es}`).join(', ');
      $('#vDescs').value = (j.debug?.descs||[]).map(x=>`${x.en}=${x.es}`).join(', ');
      $('#vPhrases').value = (j.debug?.phrases||[]).map(x=>`${x.en}=${x.es}`).join(', ');
      $('#vQs').value = (j.debug?.questions||[]).map(x=>`${x.en}=${x.es}`).join(', ');
      $('#vStatus').textContent='Done.';
    });

    // —— Conversations (front-end demo)
    function scriptedReading(A,B, topic, turns){
      const out=[]; const t=(topic||'General').toLowerCase();
      for(let i=0;i<turns;i++){
        const s=(i%2===0?A:B); const lead=(i%5===0?'¿':(i%7===0?'¡':'—'));
        out.push(`${s}: ${lead}Hablamos de ${t} paso por paso…`); out.push(`(EN) ${s}: We talk about ${t} step by step…`);
      } return out.join('\\n');
    }
    function guidedDialogue(A,B, topic, turns, mode){
      const glue=['y','pero','porque','entonces','aunque','si','cuando'];
      const present=['Tengo que','Necesito','Quiero','Puedo','Voy a','Acabo de','Me gusta'];
      const past=['Ayer','La semana pasada','Antes','Anoche','Hace poco'];
      const t=(topic||'General').toLowerCase(); const out=[];
      for(let i=0;i<turns;i++){
        const s=(i%2===0?A:B); let es='', en='';
        if(mode==='present'){ es=`${present[i%present.length]} repasar ${t} ${glue[i%glue.length]} terminar las notas.`; en='I need to review the topic and finish the notes.'; }
        else { es=`${past[i%past.length]} ${glue[i%glue.length]} hoy, revisamos ${t} y comparamos resultados.`; en='Yesterday and today, we reviewed the topic and compared results.'; }
        out.push(`${s}: ${es}`); out.push(`(EN) ${s}: ${en}`);
      } return out.join('\\n');
    }

    $('#makeC').addEventListener('click', ()=>{
      const topic=$('#cTopic').value.trim()||'General', A=$('#cA').value.trim()||'Ana', B=$('#cB').value.trim()||'Luis', lvl=$('#cLevel').value;
      let text=''; if(lvl==='1'){ text+=`LEVEL 1 — Fluent Reading & Pronunciation\\nPurpose: reading accuracy (≥90%), natural speed, proper intonation; no production.\\n\\n`; text+=`Conversation 1\\n`+scriptedReading(A,B,topic,14)+`\\n\\nConversation 2\\n`+scriptedReading(A,B,topic,14); }
      else if(lvl==='2'){ text+=`Level 2 — Present Tense, Reflexives & Glue Words\\n\\n`+guidedDialogue(A,B,topic,10,'present'); }
      else { text+=`Level 3 — Past & Ongoing (mix present + pretérito/imperfecto; some progressive)\\n\\n`+guidedDialogue(A,B,topic,10,'mixed'); }
      $('#cOut').classList.remove('muted'); $('#cOut').textContent=text;
    });
    $('#copyC').addEventListener('click', async ()=>{ await navigator.clipboard.writeText($('#cOut').textContent); alert('Conversations copied.'); });
    $('#resetC').addEventListener('click', ()=>{ ['cTopic','cA','cB'].forEach(id=>$('#'+id).value=''); $('#cLevel').value='1'; $('#cOut').textContent='Your conversations will appear here…'; $('#cOut').classList.add('muted'); $('#cStatus').textContent=''; });
    $('#serverC').addEventListener('click', async ()=>{
      $('#cStatus').textContent='Generating on server…';
      const body={ topic:$('#cTopic').value.trim()||'General', a:$('#cA').value.trim()||'Ana', b:$('#cB').value.trim()||'Luis', level:$('#cLevel').value };
      const r=await fetch('/api/generate_conversations',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const j=await r.json(); $('#cOut').classList.remove('muted'); $('#cOut').textContent=j.text||'No output.'; $('#cStatus').textContent='';
    });
    $('#aiC').addEventListener('click', async ()=>{
      $('#cStatus').textContent='Calling AI for conversations…';
      const body={ topic:$('#cTopic').value.trim()||'General', a:$('#cA').value.trim()||'Ana', b:$('#cB').value.trim()||'Luis', level:$('#cLevel').value };
      const r=await fetch('/api/ai_conversations',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const j=await r.json(); if(j.error){ $('#cStatus').textContent='Error: '+j.error; return; }
      $('#cOut').classList.remove('muted'); $('#cOut').textContent=j.text||'No output.'; $('#cStatus').textContent='Done.';
    });

    // —— Tests
    function makeFITB(topic){
      const t=(topic||'General').toLowerCase();
      const base=[
        `Aquí está el informe de ${t}.`,`Es un sistema estable.`,`Yo voy a revisar los datos.`,`Necesito confirmar los resultados.`,
        `El equipo está listo.`,`Vamos a comparar las mediciones.`,`Me gusta el diseño simple.`,`La prueba fue precisa.`,
        `El robot está funcionando.`,`Aquí está la herramienta.`
      ];
      const out=[]; base.forEach((s,i)=>{ const words=s.split(' '); const blanks=Math.max(1,Math.floor(words.length*0.3)); const used=new Set();
        for(let b=0;b<blanks;b++){ let idx=1; if(words.length>2){ while(true){ idx=1+Math.floor(Math.random()*(words.length-2)); if(!used.has(idx)){used.add(idx); break;} } }
          words[idx]='____'; } out.push(`${i+1}. ${words.join(' ')}`); });
      out.push('\\nAnswer Key:'); base.forEach((s,i)=> out.push(`${i+1}. ${s}`)); return out.join('\\n');
    }
    $('#makeT').addEventListener('click', ()=>{
      const topic=$('#tTopic').value.trim()||'General', mode=$('#tMode').value; let text='';
      if(mode==='read'){ text+=`LEVEL 1 — Reading & Pronunciation Test\\nInstructions: Read aloud at natural conversational speed. Aim for ≥90% pronunciation accuracy. Use rising intonation for questions.\\n\\n`; text+=scriptedReading('A','B',topic,16); }
      else { text+=`Fill-in-the-Blank (30% blanks) — Topic: ${topic}\\n\\n`; text+=makeFITB(topic); }
      $('#tOut').classList.remove('muted'); $('#tOut').textContent=text;
    });
    $('#copyT').addEventListener('click', async ()=>{ await navigator.clipboard.writeText($('#tOut').textContent); alert('Test copied.'); });
    $('#resetT').addEventListener('click', ()=>{ $('#tTopic').value=''; $('#tMode').value='read'; $('#tOut').textContent='Your tests will appear here…'; $('#tOut').classList.add('muted'); $('#tStatus').textContent=''; });
    $('#serverT').addEventListener('click', async ()=>{
      $('#tStatus').textContent='Generating on server…';
      const body={ topic:$('#tTopic').value.trim()||'General', mode:$('#tMode').value };
      const r=await fetch('/api/generate_tests',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const j=await r.json(); $('#tOut').classList.remove('muted'); $('#tOut').textContent=j.text||'No output.'; $('#tStatus').textContent='';
    });
    $('#aiT').addEventListener('click', async ()=>{
      $('#tStatus').textContent='Calling AI for test…';
      const body={ topic:$('#tTopic').value.trim()||'General', mode:$('#tMode').value };
      const r=await fetch('/api/ai_tests',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const j=await r.json(); if(j.error){ $('#tStatus').textContent='Error: '+j.error; return; }
      $('#tOut').classList.remove('muted'); $('#tOut').textContent=j.text||'No output.'; $('#tStatus').textContent='Done.';
    });
  </script>
</body>
</html>
